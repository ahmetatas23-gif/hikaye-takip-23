<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T√ºrk√ße Okuma Anlama Test Sistemi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        .badge-gold { background: linear-gradient(45deg, #FFD700, #FFA500); }
        .badge-silver { background: linear-gradient(45deg, #C0C0C0, #A0A0A0); }
        .badge-bronze { background: linear-gradient(45deg, #CD7F32, #B8860B); }
        .badge-earned { 
            background: linear-gradient(135deg, #FFD700, #FFA500, #FFD700, #FFED4E) !important;
            background-size: 200% 200% !important;
            animation: badgeGlow 2s ease-in-out infinite alternate, goldShimmer 3s ease-in-out infinite !important;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.3) !important;
            opacity: 1 !important;
            border: 2px solid #FFD700 !important;
            position: relative !important;
        }
        .badge-earned::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700, #FFED4E);
            border-radius: inherit;
            z-index: -1;
            animation: goldShimmer 3s ease-in-out infinite;
        }
        .badge-earned::after {
            content: '‚ú®';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
            animation: sparkle 2s ease-in-out infinite;
        }
        .badge-locked { 
            background: linear-gradient(45deg, #9CA3AF, #6B7280) !important;
            opacity: 0.7 !important;
        }
        .badge-new { 
            animation: badgeEarned 1s ease-in-out;
        }
        @keyframes badgeGlow {
            0% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.3); }
            100% { box-shadow: 0 0 40px rgba(255, 215, 0, 1), 0 0 80px rgba(255, 215, 0, 0.6), inset 0 0 30px rgba(255, 255, 255, 0.5); }
        }
        @keyframes goldShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
            25% { opacity: 0.7; transform: scale(1.2) rotate(90deg); }
            50% { opacity: 1; transform: scale(0.8) rotate(180deg); }
            75% { opacity: 0.7; transform: scale(1.1) rotate(270deg); }
        }
        @keyframes badgeEarned {
            0% { transform: scale(0.5) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .timer-warning { animation: shake 0.5s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .border-3 { border-width: 3px; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Supabase Configuration -->
    <script>
        // Supabase baƒülantƒ±sƒ± - Ger√ßek bilgileriniz
        const SUPABASE_URL = 'https://gmzdeptaipfacmfdexnd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtemRlcHRhaXBmYWNtZmRleG5kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3Mzk2NzAsImV4cCI6MjA3MjMxNTY3MH0.uFenHsXWA0esrAoAYJ3MK6UoEW-8uNOc8CzYrJVyt5k';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Global state
let impersonatedStudent = null;
        let currentUser = null;
        let currentTest = null;
        let testTimer = null;
        let questionTimer = null;
        let timeRemaining = 0;
        let questionTimeRemaining = 75;
        let currentFontSize = 16;
        const fontSizes = [12, 14, 16, 18, 20, 22, 26, 32];
        
        // Test filtering state
        let allTestsData = [];
        let currentTestFilter = 'all';
        let currentTestSearch = '';
        
        // Student test filtering state
        let allStudentTestsData = [];
        let currentStudentTestFilter = 'all';
    </script>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-book-open text-5xl text-indigo-600 mb-4"></i>
                <h1 class="text-3xl font-bold text-gray-800">T√ºrk√ße Okuma Anlama</h1>
                <p class="text-gray-600 mt-2">Test Sistemi</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="showStudentLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                    <i class="fas fa-user-graduate mr-2"></i>
                    √ñƒürenci Giri≈üi
                </button>
                <button onclick="showTeacherLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>
                    √ñƒüretmen Giri≈üi
                </button>
            </div>
        </div>
    </div>

    <!-- Student Login -->
    <div id="studentLoginScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-user-graduate text-5xl text-blue-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">√ñƒürenci Giri≈üi</h2>
            </div>
            
            <form onsubmit="studentLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">TC Kimlik No</label>
                    <input type="text" id="studentTC" maxlength="11" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="TC Kimlik Numaranƒ±z" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">√ñƒürenci No</label>
                    <input type="text" id="studentNo" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="√ñƒürenci Numaranƒ±z" required>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="rememberStudent" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="rememberStudent" class="ml-2 block text-sm text-gray-700">
                        Beni hatƒ±rla
                    </label>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                    Giri≈ü Yap
                </button>
                <button type="button" onclick="showMainLogin()" class="w-full text-gray-600 hover:text-gray-800 py-2">
                    ‚Üê Geri D√∂n
                </button>
            </form>
        </div>
    </div>

    <!-- Teacher Login -->
    <div id="teacherLoginScreen" class="hidden min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-chalkboard-teacher text-5xl text-green-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">√ñƒüretmen Giri≈üi</h2>
            </div>
            
            <form onsubmit="teacherLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kullanƒ±cƒ± Adƒ±</label>
                    <input type="text" id="teacherUsername" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Kullanƒ±cƒ± adƒ±nƒ±z" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">≈ûifre</label>
                    <input type="password" id="teacherPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="≈ûifreniz" required>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="rememberTeacher" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                    <label for="rememberTeacher" class="ml-2 block text-sm text-gray-700">
                        Beni hatƒ±rla
                    </label>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-300">
                    Giri≈ü Yap
                </button>
                <button type="button" onclick="showMainLogin()" class="w-full text-gray-600 hover:text-gray-800 py-2">
                    ‚Üê Geri D√∂n
                </button>
            </form>
        </div>
    </div>

    <!-- Student Dashboard -->
    <div id="studentDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center                        <i class="fas fa-user-graduate text-2xl text-blue-600 mr-3"></i>
                        <h1 class="text-xl font-semibold text-gray-900">√ñƒürenci Paneli</h1>
                        <span id="impersonationBadge" class="hidden ml-4 px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                            √ñƒûRETMEN G√ñR√úN√úM√ú
                        </span>
                    </div>                    <div class="flex items-center space-x-4">
                        <div id="studentInfo" class="text-sm text-gray-600"></div>
                        <button id="exitImpersonationButton" onclick="exitImpersonation()" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 flex items-center">
                            <i class="fas fa-sign-out-alt mr-2"></i>√ñƒüretmen Paneline D√∂n
                        </button>
                        <button id="studentLogoutButton" onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-blue-100 rounded-lg">
                            <i class="fas fa-clipboard-list text-blue-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Toplam Test</p>
                            <p id="totalTests" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-green-100 rounded-lg">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Tamamlanan</p>
                            <p id="completedTests" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-yellow-100 rounded-lg">
                            <i class="fas fa-star text-yellow-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Ortalama Puan</p>
                            <p id="averageScore" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="p-2 bg-purple-100 rounded-lg">
                            <i class="fas fa-medal text-purple-600"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Rozetler</p>
                            <p id="badgeCount" class="text-2xl font-semibold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex">
                        <button onclick="showTab('tests')" id="testsTab" class="tab-button py-4 px-6 border-b-2 border-blue-500 text-blue-600 font-medium">
                            <i class="fas fa-clipboard-list mr-2"></i>Testlerim
                        </button>
                        <button onclick="showTab('badges')" id="badgesTab" class="tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-medal mr-2"></i>Rozetlerim
                        </button>
                        <button onclick="showTab('leaderboard')" id="leaderboardTab" class="tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-trophy mr-2"></i>Liderlik Tablosu
                        </button>
                    </nav>
                </div>

                <!-- Tests Tab -->
                <div id="testsContent" class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Testlerim</h3>
                        <button onclick="refreshStudentTests()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition duration-200 flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>Yenile
                        </button>
                    </div>

                    <!-- Filter Buttons -->
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex flex-wrap gap-3">
                            <button onclick="setStudentTestFilter('all')" id="filterAllStudentTests" 
                                    class="student-test-filter-btn px-4 py-2 text-sm rounded-lg bg-blue-100 text-blue-800 border border-blue-200 font-medium">
                                <i class="fas fa-list mr-1"></i>T√ºm√º
                            </button>
                            <button onclick="setStudentTestFilter('waiting')" id="filterWaitingStudentTests" 
                                    class="student-test-filter-btn px-4 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                üü° Bekliyor
                            </button>
                            <button onclick="setStudentTestFilter('successful')" id="filterSuccessfulStudentTests" 
                                    class="student-test-filter-btn px-4 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                üü¢ Ba≈üarƒ±lƒ±
                            </button>
                            <button onclick="setStudentTestFilter('low_score')" id="filterLowScoreStudentTests" 
                                    class="student-test-filter-btn px-4 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                üî¥ D√º≈ü√ºk Puan
                            </button>
                        </div>
                        
                        <!-- Filter Info -->
                        <div class="mt-3 flex justify-between items-center text-sm text-gray-600">
                            <div id="studentTestFilterInfo">T√ºm testler g√∂steriliyor</div>
                            <button onclick="clearStudentTestFilters()" class="text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-times mr-1"></i>Filtreleri Temizle
                            </button>
                        </div>
                    </div>

                    <div id="assignedTests" class="space-y-4"></div>
                </div>

                <!-- Badges Tab -->
                <div id="badgesContent" class="hidden p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Rozet Koleksiyonum</h3>
                        <p class="text-gray-600 text-sm">Testleri √ß√∂zerek yeni rozetler kazanƒ±n ve koleksiyonunuzu b√ºy√ºt√ºn!</p>
                    </div>
                    <div id="studentBadges" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>
                </div>

                <!-- Leaderboard Tab -->
                <div id="leaderboardContent" class="hidden p-6">
                    <div id="leaderboardList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Text Reading Screen (for first_page_only mode) -->
    <div id="textReadingScreen" class="hidden min-h-screen bg-gradient-to-br from-green-50 to-blue-100">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <!-- Header -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h2 id="readingTestTitle" class="text-2xl font-bold text-gray-900 mb-2"></h2>
                        <p id="readingTestDescription" class="text-gray-600"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Font Size Controls -->
                        <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-2">
                            <button onclick="changeReadingFontSize(-1)" class="w-8 h-8 bg-white rounded-md shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center text-gray-600 hover:text-gray-800">
                                <span class="text-sm font-bold">A-</span>
                            </button>
                            <span id="readingFontSizeIndicator" class="text-xs text-gray-600 px-2">16px</span>
                            <button onclick="changeReadingFontSize(1)" class="w-8 h-8 bg-white rounded-md shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center text-gray-600 hover:text-gray-800">
                                <span class="text-sm font-bold">A+</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-green-600 mr-2"></i>
                        <p class="text-green-800 font-medium">√ñnce metni dikkatle okuyun, sonra sorulara ge√ßin.</p>
                    </div>
                </div>
            </div>

            <!-- Reading Text Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100 mb-6">
                <div class="flex items-center mb-6">
                    <i class="fas fa-book-open text-green-600 mr-3 text-xl"></i>
                    <h3 class="text-xl font-semibold text-gray-900">Okuma Metni</h3>
                </div>
                <div id="readingTextContent" class="prose max-w-none text-gray-700 leading-relaxed" style="font-size: 16px; line-height: 1.8;"></div>
            </div>

            <!-- Continue Button -->
            <div class="text-center">
                <button onclick="startQuestionsFromReading()" class="px-8 py-4 bg-green-600 text-white rounded-xl hover:bg-green-700 transition duration-300 text-lg font-semibold shadow-lg">
                    Metni Okudum, Sorulara Ge√ß <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <p class="text-sm text-gray-600 mt-3">
                    <i class="fas fa-lightbulb mr-1"></i>
                    ƒ∞pucu: Metni dikkatlice okuduktan sonra sorulara ge√ßin
                </p>
            </div>
        </div>
    </div>

    <!-- Test Taking Screen -->
    <div id="testScreen" class="hidden min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div class="max-w-5xl mx-auto px-4 py-6">
            <!-- Test Header -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6 border border-gray-100">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h2 id="testTitle" class="text-2xl font-bold text-gray-900 mb-2"></h2>
                        <p id="testDescription" class="text-gray-600"></p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <!-- Font Size Controls -->
                        <div class="flex items-center space-x-2 bg-gray-100 rounded-lg p-2">
                            <button onclick="changeFontSize(-1)" class="w-8 h-8 bg-white rounded-md shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center text-gray-600 hover:text-gray-800">
                                <span class="text-sm font-bold">A-</span>
                            </button>
                            <span id="fontSizeIndicator" class="text-xs text-gray-600 px-2">16px</span>
                            <button onclick="changeFontSize(1)" class="w-8 h-8 bg-white rounded-md shadow-sm hover:shadow-md transition-all duration-200 flex items-center justify-center text-gray-600 hover:text-gray-800">
                                <span class="text-sm font-bold">A+</span>
                            </button>
                        </div>
                        <!-- Question Timer -->
                        <div class="text-center">
                            <div id="questionTimer" class="text-2xl font-bold text-green-600 mb-1">75</div>
                            <div class="text-xs text-gray-600">saniye</div>
                        </div>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>ƒ∞lerleme</span>
                        <span id="progressText">Soru 1/7</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-indigo-600 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="testLayout" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Reading Text -->
                <div id="readingTextColumn" class="lg:col-span-1">
                    <div id="readingText" class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 sticky top-6">
                        <div class="flex items-center mb-4">
                            <i class="fas fa-book-open text-indigo-600 mr-2"></i>
                            <h3 class="text-lg font-semibold text-gray-900">Okuma Metni</h3>
                        </div>
                        <div id="textContent" class="prose max-w-none text-gray-700 leading-relaxed" style="font-size: 16px;"></div>
                    </div>
                </div>

                <!-- Question Area -->
                <div id="questionColumn" class="lg:col-span-2">
                    <div id="questionCard" class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
                        <!-- Question Header -->
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                    <span id="currentQuestionNumber" class="font-bold text-indigo-600">1</span>
                                </div>
                                <span id="questionType" class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800"></span>
                            </div>
                        </div>

                        <!-- Question Text -->
                        <div class="mb-8">
                            <p id="questionText" class="text-xl text-gray-800 leading-relaxed font-medium" style="font-size: 20px;"></p>
                        </div>

                        <!-- Answer Options -->
                        <div id="answerOptions" class="space-y-4 mb-8"></div>

                        <!-- Navigation -->
                        <div class="flex justify-end">
                            <button id="nextButton" onclick="nextQuestion()" class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 text-lg font-semibold">
                                ƒ∞leri <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Teacher Dashboard -->
    <div id="teacherDashboard" class="hidden min-h-screen bg-gray-50">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-chalkboard-teacher text-2xl text-green-600 mr-3"></i>
                        <h1 class="text-xl font-semibold text-gray-900">√ñƒüretmen Paneli</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="teacherInfo" class="text-sm text-gray-600"></div>
                        <button onclick="refreshTeacherData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i>Yenile
                        </button>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> √áƒ±kƒ±≈ü
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Teacher Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex">
                        <button onclick="showTeacherTab('dashboard')" id="dashboardTab" class="teacher-tab-button py-4 px-6 border-b-2 border-green-500 text-green-600 font-medium">
                            <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                        </button>
                        <button onclick="showTeacherTab('tests')" id="testsManageTab" class="teacher-tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-clipboard-list mr-2"></i>Test Y√∂netimi
                        </button>
                        <button onclick="showTeacherTab('students')" id="studentsManageTab" class="teacher-tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-users mr-2"></i>√ñƒürenci Y√∂netimi
                        </button>
                        <button onclick="showTeacherTab('results')" id="resultsTab" class="teacher-tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-chart-bar mr-2"></i>Sonu√ßlar
                        </button>
                        <button onclick="showTeacherTab('library')" id="libraryTab" class="teacher-tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-book mr-2"></i>Sƒ±nƒ±f Kitaplƒ±ƒüƒ±
                        </button>
                        <button onclick="showTeacherTab('failedTests')" id="failedTestsTab" class="teacher-tab-button py-4 px-6 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times-circle mr-2"></i>Ba≈üarƒ±sƒ±z Testler
                        </button>
                    </nav>
                </div>

                <!-- Dashboard Content -->
                <div id="dashboardContent" class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow p-6 text-white">
                            <div class="flex items-center">
                                <i class="fas fa-users text-3xl mb-2"></i>
                                <div class="ml-4">
                                    <p class="text-blue-100">Toplam √ñƒürenci</p>
                                    <p id="totalStudents" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg shadow p-6 text-white">
                            <div class="flex items-center">
                                <i class="fas fa-clipboard-list text-3xl mb-2"></i>
                                <div class="ml-4">
                                    <p class="text-green-100">Aktif Testler</p>
                                    <p id="activeTests" class="text-3xl font-bold">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg shadow p-6 text-white">
                            <div class="flex items-center">
                                <i class="fas fa-chart-line text-3xl mb-2"></i>
                                <div class="ml-4">
                                    <p class="text-purple-100">Ortalama Ba≈üarƒ±</p>
                                    <p id="averageSuccess" class="text-3xl font-bold">0%</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Management Content -->
                <div id="testsManageContent" class="hidden p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Test Y√∂netimi</h3>
                        <div class="flex gap-3">
                            <button onclick="showPendingTestsModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-clock mr-2"></i>Bekleyen Testler
                            </button>
                            <button onclick="showUploadTest()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-plus mr-2"></i>Yeni Test Y√ºkle
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filter Section -->
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Search Input -->
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="text" id="testSearchInput" placeholder="Test adƒ± veya a√ßƒ±klama ile ara..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                           onkeyup="filterTests()">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Filter Buttons -->
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setTestFilter('all')" id="filterAllTests" 
                                        class="test-filter-btn px-3 py-2 text-sm rounded-lg bg-green-100 text-green-800 border border-green-200 font-medium">
                                    <i class="fas fa-list mr-1"></i>T√ºm√º
                                </button>
                                <button onclick="setTestFilter('recent')" id="filterRecentTests" 
                                        class="test-filter-btn px-3 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                    <i class="fas fa-clock mr-1"></i>Son Eklenenler
                                </button>
                                <button onclick="setTestFilter('active')" id="filterActiveTests" 
                                        class="test-filter-btn px-3 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                    <i class="fas fa-play-circle mr-1"></i>Aktif Testler
                                </button>
                                <button onclick="setTestFilter('completed')" id="filterCompletedTests" 
                                        class="test-filter-btn px-3 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                    <i class="fas fa-check-circle mr-1"></i>Tamamlananlar
                                </button>
                                <button onclick="setTestFilter('no_assignments')" id="filterNoAssignmentTests" 
                                        class="test-filter-btn px-3 py-2 text-sm rounded-lg bg-gray-100 text-gray-700 border border-gray-200 hover:bg-gray-200">
                                    <i class="fas fa-user-slash mr-1"></i>Atanmamƒ±≈ü
                                </button>
                            </div>

                            <!-- Sort Options -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 font-medium">Sƒ±rala:</label>
                                <select id="testSortSelect" onchange="filterTests()" 
                                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                    <option value="newest">En Yeni</option>
                                    <option value="oldest">En Eski</option>
                                    <option value="name_asc">ƒ∞sim (A-Z)</option>
                                    <option value="name_desc">ƒ∞sim (Z-A)</option>
                                    <option value="most_assigned">En √áok Atanan</option>
                                    <option value="least_assigned">En Az Atanan</option>
                                </select>
                            </div>
                        </div>

                        <!-- Filter Results Info -->
                        <div class="mt-3 flex justify-between items-center text-sm text-gray-600">
                            <div id="testFilterInfo">T√ºm testler g√∂steriliyor</div>
                            <button onclick="clearTestFilters()" class="text-green-600 hover:text-green-800 font-medium">
                                <i class="fas fa-times mr-1"></i>Filtreleri Temizle
                            </button>
                        </div>
                    </div>

                    <div id="testsList" class="space-y-4"></div>
                </div>

                <!-- Student Management Content -->
                <div id="studentsManageContent" class="hidden p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">√ñƒürenci Y√∂netimi</h3>
                        <div class="space-x-2">
                            <button onclick="showAddStudent()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-user-plus mr-2"></i>√ñƒürenci Ekle
                            </button>
                            <button onclick="showBulkUpload()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-file-excel mr-2"></i>Excel Y√ºkle
                            </button>
                            <button onclick="backupAllData()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i>T√ºm Verileri Yedekle
                            </button>
                        </div>
                    </div>
                    <div id="studentsList" class="space-y-4"></div>
                </div>

                <!-- Results Content -->
                <div id="resultsContent" class="hidden p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Test Sonu√ßlarƒ±</h3>
                    <div id="resultsList" class="space-y-4"></div>
                </div>

                <!-- Library Content -->
                <div id="libraryContent" class="hidden p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-book text-purple-600 mr-2"></i>Sƒ±nƒ±f Kitaplƒ±ƒüƒ±
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            Sistemdeki t√ºm testleri g√∂r√ºnt√ºleyin. Bir √∂ƒürenci se√ßtiƒüinizde, testlerin durumunu renklerle g√∂rebilir ve gri testlere tƒ±klayarak hƒ±zlƒ± atama yapabilirsiniz.
                        </p>
                        
                        <!-- Student Selection -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-user-graduate mr-2"></i>√ñƒürenci Se√ßin:
                            </label>
                            <select id="libraryStudentSelect" onchange="loadLibraryForStudent()" 
                                    class="w-full md:w-96 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                <option value="">-- √ñƒürenci Se√ßin --</option>
                            </select>
                            
                            <div id="libraryLegend" class="hidden mt-4 flex flex-wrap gap-4 text-sm">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                                    <span>üü¢ Ba≈üarƒ±lƒ± (‚â•70)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                                    <span>üî¥ Ba≈üarƒ±sƒ±z (<70)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-yellow-400 rounded mr-2"></div>
                                    <span>üü° Bekleyen</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-gray-300 rounded mr-2"></div>
                                    <span>‚ö™ Atanmamƒ±≈ü (Tƒ±kla & Ata)</span>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter -->
                        <div id="librarySearchFilter" class="hidden mb-6">
                            <div class="flex flex-col md:flex-row gap-4">
                                <!-- Search Box -->
                                <div class="flex-1 relative">
                                    <input type="text" id="librarySearchInput" 
                                           placeholder="Test adƒ± ile ara..." 
                                           oninput="filterLibraryTests()"
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>

                                <!-- Status Filter Buttons -->
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setLibraryFilter('all')" id="filterAll" 
                                            class="library-filter-btn px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200">
                                        <i class="fas fa-list mr-1"></i>T√ºm√º
                                    </button>
                                    <button onclick="setLibraryFilter('success')" id="filterSuccess"
                                            class="library-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-green-100 transition duration-200">
                                        üü¢ Ba≈üarƒ±lƒ±
                                    </button>
                                    <button onclick="setLibraryFilter('failed')" id="filterFailed"
                                            class="library-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-red-100 transition duration-200">
                                        üî¥ Ba≈üarƒ±sƒ±z
                                    </button>
                                    <button onclick="setLibraryFilter('pending')" id="filterPending"
                                            class="library-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-yellow-100 transition duration-200">
                                        üü° Bekleyen
                                    </button>
                                    <button onclick="setLibraryFilter('unassigned')" id="filterUnassigned"
                                            class="library-filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200">
                                        ‚ö™ Atanmamƒ±≈ü
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div id="libraryStats" class="hidden grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                            <div onclick="setLibraryFilter('all')" class="bg-white border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg transition duration-200">
                                <div class="text-2xl font-bold text-purple-600" id="libTotalTests">0</div>
                                <div class="text-xs text-gray-600">Toplam Test</div>
                            </div>
                            <div onclick="setLibraryFilter('success')" class="bg-green-50 border border-green-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg hover:bg-green-100 transition duration-200">
                                <div class="text-2xl font-bold text-green-600" id="libSuccessTests">0</div>
                                <div class="text-xs text-gray-600">Ba≈üarƒ±lƒ±</div>
                            </div>
                            <div onclick="setLibraryFilter('failed')" class="bg-red-50 border border-red-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg hover:bg-red-100 transition duration-200">
                                <div class="text-2xl font-bold text-red-600" id="libFailedTests">0</div>
                                <div class="text-xs text-gray-600">Ba≈üarƒ±sƒ±z</div>
                            </div>
                            <div onclick="setLibraryFilter('pending')" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg hover:bg-yellow-100 transition duration-200">
                                <div class="text-2xl font-bold text-yellow-600" id="libPendingTests">0</div>
                                <div class="text-xs text-gray-600">Bekleyen</div>
                            </div>
                            <div onclick="setLibraryFilter('unassigned')" class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center cursor-pointer hover:shadow-lg hover:bg-gray-200 transition duration-200">
                                <div class="text-2xl font-bold text-gray-600" id="libUnassignedTests">0</div>
                                <div class="text-xs text-gray-600">Atanmamƒ±≈ü</div>
                            </div>
                        </div>
                    </div>

                    <!-- Tests Grid -->
                    <div id="libraryTestsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <div class="text-center text-gray-500 py-8 col-span-full">
                            <i class="fas fa-book text-4xl mb-2"></i>
                            <p>Yukarƒ±dan bir √∂ƒürenci se√ßin</p>
                        </div>
                    </div>
                </div>

                <!-- Failed Tests Content -->
                <div id="failedTestsContent" class="hidden p-6">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-times-circle text-red-600 mr-2"></i>Ba≈üarƒ±sƒ±z Testler
                        </h3>
                        <p class="text-gray-600 text-sm mb-4">
                            √ñƒürencilerin ba≈üarƒ±sƒ±z olduƒüu testler a≈üaƒüƒ±da listelenmektedir. Tekrar atama butonu ile bu testleri tekrar atayabilirsiniz.
                        </p>
                    </div>

                    <!-- Filter and Search Section -->
                    <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- Search Input -->
                            <div class="flex-1">
                                <div class="relative">
                                    <input type="text" id="failedTestsSearchInput" placeholder="√ñƒürenci adƒ± veya test adƒ± ile ara..." 
                                           class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           oninput="filterFailedTests()">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <i class="fas fa-search text-gray-400"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Sort Options -->
                            <div class="flex items-center space-x-2">
                                <label class="text-sm text-gray-600 font-medium">Sƒ±rala:</label>
                                <select id="failedTestsSortSelect" onchange="filterFailedTests()" 
                                        class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                    <option value="recent">En Yeni</option>
                                    <option value="oldest">En Eski</option>
                                    <option value="student_asc">√ñƒürenci Adƒ± (A-Z)</option>
                                    <option value="student_desc">√ñƒürenci Adƒ± (Z-A)</option>
                                    <option value="score_asc">Puan (D√º≈ü√ºkten Y√ºkseƒüe)</option>
                                    <option value="score_desc">Puan (Y√ºksekten D√º≈ü√ºƒüe)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Filter Results Info -->
                        <div class="mt-3 flex justify-between items-center text-sm text-gray-600">
                            <div id="failedTestsFilterInfo">Ba≈üarƒ±sƒ±z testler y√ºkleniyor...</div>
                            <button onclick="clearFailedTestsFilters()" class="text-red-600 hover:text-red-800 font-medium">
                                <i class="fas fa-times mr-1"></i>Filtreleri Temizle
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div id="failedTestsStats" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-red-600" id="failedTestsCount">0</div>
                            <div class="text-xs text-gray-600">Ba≈üarƒ±sƒ±z Test</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="failedStudentsCount">0</div>
                            <div class="text-xs text-gray-600">Etkilenen √ñƒürenci</div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="failedTestsAvgScore">0%</div>
                            <div class="text-xs text-gray-600">Ortalama Puan</div>
                        </div>
                    </div>

                    <!-- Failed Tests List -->
                    <div id="failedTestsList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Test Upload Modal -->
    <div id="uploadTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full h-[90vh] flex flex-col">
            <div class="flex-1 overflow-y-auto p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Test Y√ºkle (JSON Format)</h3>
                    <button onclick="closeModal('uploadTestModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Upload Method Tabs -->
                <div class="mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchUploadTab('file')" id="fileUploadTab" class="upload-tab-button py-2 px-1 border-b-2 border-green-500 text-green-600 font-medium text-sm">
                                <i class="fas fa-file-upload mr-2"></i>Dosya Y√ºkle
                            </button>
                            <button onclick="switchUploadTab('paste')" id="pasteUploadTab" class="upload-tab-button py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">
                                <i class="fas fa-paste mr-2"></i>Kopyala-Yapƒ±≈ütƒ±r
                            </button>
                        </nav>
                    </div>
                </div>

                <form onsubmit="uploadTest(event)">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Adƒ±</label>
                            <input type="text" id="testName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test A√ßƒ±klamasƒ±</label>
                            <input type="text" id="testDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <!-- Text Display Settings -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-book-open text-blue-600 mr-2"></i>
                            üìñ Metin G√∂r√ºnt√ºleme Ayarlarƒ±
                        </h4>
                        <p class="text-sm text-gray-600 mb-4">√ñƒürenci teste ba≈üladƒ±ƒüƒ±nda metin nasƒ±l g√∂sterilsin?</p>
                        
                        <div class="space-y-3">
                            <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer transition-colors">
                                <input type="radio" name="textDisplayMode" value="with_questions" class="mt-1 text-blue-600 focus:ring-blue-500">
                                <div>
                                    <div class="font-medium text-gray-900 flex items-center">
                                        üìÑ Her Soruyla Birlikte Metni G√∂ster
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        Klasik mod - Her soru sayfasƒ±nda metin g√∂r√ºn√ºr
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-start space-x-3 p-3 border-2 border-blue-300 bg-blue-50 rounded-lg cursor-pointer">
                                <input type="radio" name="textDisplayMode" value="first_page_only" class="mt-1 text-blue-600 focus:ring-blue-500" checked>
                                <div>
                                    <div class="font-medium text-gray-900 flex items-center">
                                        üìã Sadece ƒ∞lk Sayfada Metni G√∂ster
                                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">Varsayƒ±lan</span>
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        √ñƒürenci √∂nce metni okur, sonra sorulara ge√ßer
                                    </div>
                                </div>
                            </label>
                            
                            <label class="flex items-start space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-red-50 cursor-pointer transition-colors">
                                <input type="radio" name="textDisplayMode" value="no_text" class="mt-1 text-red-600 focus:ring-red-500">
                                <div>
                                    <div class="font-medium text-gray-900 flex items-center">
                                        üö´ Metni Hi√ß G√∂sterme, Doƒürudan Sorulara Ge√ß
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        Metin hi√ß g√∂sterilmez - Sadece sorular g√∂r√ºn√ºr
                                    </div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-600 mr-2 mt-0.5"></i>
                                <div class="text-sm text-yellow-800">
                                    <strong>ƒ∞pucu:</strong> "Sadece ƒ∞lk Sayfada" modu √∂ƒürencilerin metni dikkatlice okumalarƒ±nƒ± saƒülar. 
                                    "Her Soruyla Birlikte" modu ise √∂ƒürencilerin metne s√ºrekli bakabilmelerini saƒülar.
                                </div>
                            </div>
                        </div>
                    </div>



                    <!-- File Upload Tab -->
                    <div id="fileUploadContent" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">JSON Dosyasƒ± Se√ß</label>
                            <div class="flex items-center justify-center w-full">
                                <label for="testFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                        <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Dosya se√ßmek i√ßin tƒ±klayƒ±n</span></p>
                                        <p class="text-xs text-gray-500">JSON dosyalarƒ± (.json)</p>
                                    </div>
                                    <input id="testFile" type="file" accept=".json" class="hidden">
                                </label>
                            </div>
                            <div id="selectedFileName" class="mt-2 text-sm text-gray-600 hidden"></div>
                        </div>
                    </div>

                    <!-- Copy-Paste Tab -->
                    <div id="pasteUploadContent" class="hidden space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-medium text-gray-700">JSON Kodunu Yapƒ±≈ütƒ±rƒ±n</label>
                                <div class="flex space-x-2">
                                    <button type="button" onclick="validateJSON()" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                        <i class="fas fa-check mr-1"></i>Doƒürula
                                    </button>
                                    <button type="button" onclick="formatJSON()" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700">
                                        <i class="fas fa-magic mr-1"></i>Bi√ßimlendir
                                    </button>
                                    <button type="button" onclick="clearJSON()" class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700">
                                        <i class="fas fa-trash mr-1"></i>Temizle
                                    </button>
                                    <button type="button" onclick="copyExampleJSON()" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                                        <i class="fas fa-copy mr-1"></i>√ñrneƒüi Kopyala
                                    </button>
                                </div>
                            </div>
                            <textarea id="jsonTextArea" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 font-mono text-sm" placeholder="JSON kodunuzu buraya yapƒ±≈ütƒ±rƒ±n..."></textarea>
                            <div id="jsonValidationResult" class="mt-2 text-sm hidden"></div>
                        </div>
                    </div>

                    <!-- JSON Example -->
                    <div class="bg-gray-50 p-4 rounded-lg mt-6">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-900">JSON Format √ñrneƒüi:</h4>
                            <button type="button" onclick="copyToClipboard(getExampleJSON())" class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                <i class="fas fa-copy mr-1"></i>Kopyala
                            </button>
                        </div>
                        <div class="bg-white rounded border p-3 max-h-32 overflow-y-auto">
                            <pre id="jsonExample" class="text-xs text-gray-600 whitespace-pre-wrap">{
  "title": "T√ºrk√ße Okuma Anlama Testi",
  "description": "2. Sƒ±nƒ±f T√ºrk√ße Okuma Anlama Testi",
  "readingText": "BURAYA OKUMA METNƒ∞ GELECEK",
  "textDisplayMode": "first_page_only",
  "questions": [
    {
      "type": "multiple_choice",
      "question": "SORU METNƒ∞",
      "options": ["A) ≈ûIK 1", "B) ≈ûIK 2", "C) ≈ûIK 3"],
      "correct": 0,
      "points": 5,
      "timeLimit": 75
    },
    {
      "type": "fill_blank",
      "question": "SORU METNƒ∞",
      "options": ["cevap1", "cevap2", "cevap3"],
      "correct": "cevap1",
      "points": 5,
      "timeLimit": 75
    },
    {
      "type": "true_false",
      "question": "SORU METNƒ∞",
      "correct": true,
      "points": 5,
      "timeLimit": 75
    }
  ]
}</pre>
                        </div>
                        <div class="mt-3 text-xs text-gray-600">
                            <p><strong>Soru Tipleri:</strong></p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li><code>multiple_choice</code>: √áoktan se√ßmeli (options dizisi ve correct index gerekli)</li>
                                <li><code>fill_blank</code>: Bo≈üluk doldurma (correct string gerekli)</li>
                                <li><code>true_false</code>: Doƒüru/Yanlƒ±≈ü (correct boolean gerekli)</li>
                            </ul>
                            <p class="mt-2"><strong>Soru Ayarlarƒ±:</strong></p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li><code>points</code>: Her soru i√ßin puan deƒüeri (1-20 arasƒ±, varsayƒ±lan: 5)</li>
                                <li><code>timeLimit</code>: Her soru i√ßin s√ºre limiti saniye cinsinden (30-300 arasƒ±, varsayƒ±lan: 75)</li>
                            </ul>
                            <p class="mt-2"><strong>Metin G√∂r√ºnt√ºleme Modu:</strong></p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li><code>textDisplayMode</code>: "first_page_only" (varsayƒ±lan), "with_questions", "no_text"</li>
                                <li><strong>first_page_only:</strong> √ñnce metin, sonra sorular</li>
                                <li><strong>with_questions:</strong> Her soruda metin g√∂r√ºn√ºr</li>
                                <li><strong>no_text:</strong> Metin hi√ß g√∂sterilmez</li>
                            </ul>
                            <p class="mt-2 text-xs text-blue-600"><strong>üí° ƒ∞pucu:</strong> D√ºzenleme modunda her sorunun puan deƒüeri ve s√ºre limiti ayrƒ± ayrƒ± ayarlanabilir!</p>
                        </div>
                    </div>

                    <!-- Quick Load Button -->
                    <div class="mt-4">
                        <button type="button" onclick="loadSampleTest()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm">
                            <i class="fas fa-bolt mr-2"></i>Hƒ±zlƒ± Test ƒ∞√ßin √ñrnek Veriyi Y√ºkle
                        </button>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex justify-between items-center mt-6 pt-4 border-t">
                        <div class="flex space-x-3">
                            <button type="button" onclick="previewTest()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-eye mr-2"></i>√ñn ƒ∞zleme
                            </button>
                            <button type="button" onclick="editTest()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <i class="fas fa-edit mr-2"></i>D√ºzenle
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" onclick="closeModal('uploadTestModal')" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
                                ƒ∞ptal
                            </button>
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-upload mr-2"></i>Test Y√ºkle
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">√ñƒürenci Ekle</h3>
                    <button onclick="closeModal('addStudentModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form onsubmit="addStudent(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ad Soyad</label>
                            <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TC Kimlik No</label>
                            <input type="text" id="studentTCAdd" maxlength="11" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">√ñƒürenci No</label>
                            <input type="text" id="studentNoAdd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sƒ±nƒ±f</label>
                            <input type="text" id="studentClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal('addStudentModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">ƒ∞ptal</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Ekle</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">√ñƒürenci D√ºzenle</h3>
                    <button onclick="closeModal('editStudentModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form onsubmit="updateStudent(event)">
                    <input type="hidden" id="editStudentId">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ad Soyad</label>
                            <input type="text" id="editStudentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TC Kimlik No</label>
                            <input type="text" id="editStudentTC" maxlength="11" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">√ñƒürenci No</label>
                            <input type="text" id="editStudentNo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sƒ±nƒ±f</label>
                            <input type="text" id="editStudentClass" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal('editStudentModal')" class="px-4 py-2 text-gray-600 hover:text-gray-800">ƒ∞ptal</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-save mr-2"></i>G√ºncelle
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Edit Test Modal -->
    <div id="editTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-edit text-orange-600 mr-2"></i>Test D√ºzenle
                </h3>
                <button onclick="closeModal('editTestModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div id="editTestContent" class="p-6 overflow-y-auto flex-1">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>


    <!-- Edit Test Modal -->
    <div id="editTestModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
                <h3 class="text-xl font-semibold text-gray-900">
                    <i class="fas fa-edit text-orange-600 mr-2"></i>Test D√ºzenle
                </h3>
                <button onclick="closeModal('editTestModal')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div id="editTestContent" class="p-6 overflow-y-auto flex-1">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="testResultModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Test Sonucu</h3>
                    <button onclick="closeModal('testResultModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="testResultContent"></div>
                <div class="flex justify-center mt-4">
                    <button onclick="closeModal('testResultModal')" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Preview Modal -->
    <div id="testPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Test √ñn ƒ∞zleme</h3>
                    <button onclick="closeModal('testPreviewModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Preview Content -->
                <div id="previewContent" class="space-y-6">
                    <!-- Test Info -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-100">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="previewTitle">Test Ba≈ülƒ±ƒüƒ±</div>
                                <div class="text-sm text-blue-500">Test Adƒ±</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="previewTimeLimit">30</div>
                                <div class="text-sm text-green-500">Dakika</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600" id="previewQuestionCount">7</div>
                                <div class="text-sm text-purple-500">Soru</div>
                            </div>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-gray-700" id="previewDescription">Test a√ßƒ±klamasƒ±</p>
                        </div>
                    </div>

                    <!-- Reading Text -->
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-book-open text-green-600 mr-2"></i>
                            Okuma Metni
                        </h4>
                        <div id="previewReadingText" class="prose max-w-none text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg"></div>
                    </div>

                    <!-- Questions -->
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <i class="fas fa-question-circle text-blue-600 mr-2"></i>
                            Sorular
                        </h4>
                        <div id="previewQuestions" class="space-y-6"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeModal('testPreviewModal')" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
                        Kapat
                    </button>
                    <button onclick="editFromPreview()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                        <i class="fas fa-edit mr-2"></i>D√ºzenle
                    </button>
                </div>
            </div>
        </div>
    </div>

	    <!-- Test Edit Modal -->
	    <div id="testEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[95vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-gray-900">Test D√ºzenleyici</h3>
                    <button onclick="closeModal('testEditModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form onsubmit="saveEditedTest(event)">
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Adƒ±</label>
                            <input type="text" id="editTestName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">S√ºre (Dakika)</label>
                            <input type="number" id="editTimeLimit" min="5" max="120" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Test A√ßƒ±klamasƒ±</label>
                        <input type="text" id="editTestDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>

                    <!-- Reading Text -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Okuma Metni</label>
                        <textarea id="editReadingText" rows="8" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required></textarea>
                    </div>

                    <!-- Questions Editor -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <label class="block text-sm font-medium text-gray-700">Sorular</label>
                            <button type="button" onclick="addNewQuestion()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-plus mr-2"></i>Yeni Soru Ekle
                            </button>
                        </div>
                        <div id="questionsEditor" class="space-y-6"></div>
                    </div>

                    <!-- Actions -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <button type="button" onclick="previewEditedTest()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-eye mr-2"></i>√ñn ƒ∞zleme
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" onclick="closeModal('testEditModal')" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
                                ƒ∞ptal
                            </button>
                            <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                                <i class="fas fa-save mr-2"></i>Kaydet
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

	    <!-- Test JSON Edit Modal -->
	    <div id="jsonEditModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
	        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[95vh] overflow-y-auto">
	            <div class="p-6">
	                <div class="flex justify-between items-center mb-6">
	                    <h3 class="text-xl font-semibold text-gray-900">Test JSON D√ºzenleyici</h3>
	                    <button onclick="closeModal('jsonEditModal')" class="text-gray-400 hover:text-gray-600">
	                        <i class="fas fa-times text-xl"></i>
	                    </button>
	                </div>
	
	                <form onsubmit="saveJSONEdit(event)">
	                    <input type="hidden" id="jsonEditTestId">
	                    
	                    <div class="mb-6">
	                        <label class="block text-sm font-medium text-gray-700 mb-2">
	                            <i class="fas fa-code mr-2"></i>Sorular (JSON Formatƒ±nda)
	                        </label>
	                        <textarea id="jsonEditQuestions" rows="20" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 font-mono text-sm" required></textarea>
	                        <p class="mt-2 text-xs text-gray-500">
	                            <i class="fas fa-exclamation-triangle text-red-500 mr-1"></i>
	                            L√ºtfen ge√ßerli bir JSON formatƒ±nda girdiƒüinizden emin olun.
	                        </p>
	                    </div>
	
	                    <!-- Actions -->
	                    <div class="flex justify-end space-x-3 pt-4 border-t">
	                        <button type="button" onclick="closeModal('jsonEditModal')" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
	                            ƒ∞ptal
	                        </button>
	                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
	                            <i class="fas fa-save mr-2"></i>Kaydet ve D√ºzelt
	                        </button>
	                    </div>
	                </form>
	            </div>
	        </div>
	    </div>
	
	    <!-- Test Assignment Management Modal -->
	    <div id="assignmentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-90vh overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold text-gray-900">Test Atama Y√∂netimi</h3>
                        <p id="assignmentTestTitle" class="text-gray-600 text-sm mt-1"></p>
                    </div>
                    <button onclick="closeModal('assignmentModal')" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Assignment Actions -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex flex-wrap gap-3">
                        <button onclick="assignToAllStudents()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-users mr-2"></i>T√ºm √ñƒürencilere Ata
                        </button>
                        <button onclick="assignToClass()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                            <i class="fas fa-school mr-2"></i>Sƒ±nƒ±fa Ata
                        </button>
                        <button onclick="removeAllAssignments()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                            <i class="fas fa-trash mr-2"></i>T√ºm Atamalarƒ± Kaldƒ±r
                        </button>
                        <button onclick="refreshAssignments()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-200">
                            <i class="fas fa-sync mr-2"></i>Yenile
                        </button>
                    </div>
                </div>

                <!-- Filter Options -->
                <div class="mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-700">Filtrele:</span>
                        <button onclick="filterAssignments('all')" id="filterAll" class="filter-btn px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700 hover:bg-gray-300 transition duration-200">
                            T√ºm√º
                        </button>
                        <button onclick="filterAssignments('waiting')" id="filterWaiting" class="filter-btn px-3 py-1 text-sm rounded-full bg-yellow-100 text-yellow-800 hover:bg-yellow-200 transition duration-200">
                            üü° Bekliyor
                        </button>
                        <button onclick="filterAssignments('completed')" id="filterCompleted" class="filter-btn px-3 py-1 text-sm rounded-full bg-green-100 text-green-800 hover:bg-green-200 transition duration-200">
                            üü¢ Ba≈üarƒ±lƒ±
                        </button>
                        <button onclick="filterAssignments('failed')" id="filterFailed" class="filter-btn px-3 py-1 text-sm rounded-full bg-red-100 text-red-800 hover:bg-red-200 transition duration-200">
                            üî¥ D√º≈ü√ºk Puan
                        </button>
                        <button onclick="filterAssignments('not_assigned')" id="filterNotAssigned" class="filter-btn px-3 py-1 text-sm rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition duration-200">
                            Atanmamƒ±≈ü
                        </button>
                    </div>
                </div>

                <!-- Students List -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-900">√ñƒürenci Listesi</h4>
                        <div class="text-sm text-gray-600">
                            <span id="assignmentStats">Toplam: 0 | Atanmƒ±≈ü: 0 | Tamamlanmƒ±≈ü: 0</span>
                        </div>
                    </div>
                    <div id="assignmentStudentsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>

                <div class="flex justify-end">
                    <button onclick="closeModal('assignmentModal')" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                        Kapat
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('T√ºrk√ße Okuma Anlama Test Sistemi y√ºklendi!');
            
	        // Load remembered credentials
	        loadRememberedCredentials();
	        
	        // Test Supabase connection
	        testSupabaseConnection();
	    });
	
	    // --- JSON Edit Functions ---
	
	    // Show JSON Edit Modal
	    async function showJSONEditModal(testId) {
	        try {
	            const { data: test, error } = await supabase
	                .from('tests')
	                .select('id, questions')
	                .eq('id', testId)
	                .single();
	
	            if (error) throw error;
	
	            document.getElementById('jsonEditTestId').value = test.id;
	            
	            // Pretty print the JSON string for editing
	            let prettyJson = test.questions;
	            try {
	                const parsedQuestions = JSON.parse(test.questions);
	                prettyJson = JSON.stringify(parsedQuestions, null, 2);
	            } catch (e) {
	                console.warn("Questions field is not valid JSON, showing as raw text.");
	            }
	            
	            document.getElementById('jsonEditQuestions').value = prettyJson;
	            
	            showModal('jsonEditModal');
	        } catch (error) {
	            console.error('Error loading test for JSON edit:', error);
	            showNotification('Test verileri y√ºklenirken hata olu≈ütu.', 'error');
	        }
	    }
	
	    // Save JSON Edit
	    async function saveJSONEdit(event) {
	        event.preventDefault();
	        const testId = document.getElementById('jsonEditTestId').value;
	        const questionsText = document.getElementById('jsonEditQuestions').value;
	        
	        // Validate JSON structure (without any automatic conversion)
	        let questionsJsonString = questionsText;
	        try {
	            // Attempt to parse to validate structure
	            const parsedQuestions = JSON.parse(questionsText);
	            
	            // Sorularƒ± olduƒüu gibi kaydet - hi√ßbir otomatik d√∂n√º≈üt√ºrme yapma
	            // (Kullanƒ±cƒ± 3 se√ßenekli sorular istiyorsa, 3 se√ßenekli kalacak)
	            questionsJsonString = JSON.stringify(parsedQuestions);
	            
	        } catch (e) {
	            // If parsing fails, assume the user intended to save the raw text as is (as requested by user)
	            console.warn('JSON parsing failed. Saving raw text as requested by user. Error:', e);
	            questionsJsonString = questionsText;
	        }
	        
	        // 2. Update Supabase
	        try {
	            const { error } = await supabase
	                .from('tests')
	                .update({ questions: questionsJsonString })
	                .eq('id', testId);
	
	            if (error) throw error;
	
	            showNotification('‚úÖ Kaydedildi! Test verileri ba≈üarƒ±yla g√ºncellendi.', 'success');
	            closeModal('jsonEditModal');
	            
	            // Reload the tests list to reflect changes
	            loadTestsList();
	            
	        } catch (error) {
	            console.error('Error saving JSON edit:', error);
	            showNotification('Kaydetme sƒ±rasƒ±nda hata olu≈ütu: ' + error.message, 'error');
	        }
	    }
	
	    // --- End JSON Edit Functions ---

        // Remember Me functionality
        function saveCredentials(type, credentials) {
            if (type === 'student') {
                localStorage.setItem('rememberedStudent', JSON.stringify({
                    tc: credentials.tc,
                    studentNo: credentials.studentNo,
                    timestamp: Date.now()
                }));
            } else if (type === 'teacher') {
                localStorage.setItem('rememberedTeacher', JSON.stringify({
                    username: credentials.username,
                    timestamp: Date.now()
                }));
            }
        }

        function loadRememberedCredentials() {
            // Load student credentials
            const rememberedStudent = localStorage.getItem('rememberedStudent');
            if (rememberedStudent) {
                try {
                    const studentData = JSON.parse(rememberedStudent);
                    // Check if data is not older than 30 days
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    
                    if (studentData.timestamp > thirtyDaysAgo) {
                        document.getElementById('studentTC').value = studentData.tc || '';
                        document.getElementById('studentNo').value = studentData.studentNo || '';
                        document.getElementById('rememberStudent').checked = true;
                    } else {
                        // Remove expired data
                        localStorage.removeItem('rememberedStudent');
                    }
                } catch (error) {
                    console.error('Error loading remembered student credentials:', error);
                    localStorage.removeItem('rememberedStudent');
                }
            }

            // Load teacher credentials
            const rememberedTeacher = localStorage.getItem('rememberedTeacher');
            if (rememberedTeacher) {
                try {
                    const teacherData = JSON.parse(rememberedTeacher);
                    // Check if data is not older than 30 days
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    
                    if (teacherData.timestamp > thirtyDaysAgo) {
                        document.getElementById('teacherUsername').value = teacherData.username || '';
                        document.getElementById('rememberTeacher').checked = true;
                    } else {
                        // Remove expired data
                        localStorage.removeItem('rememberedTeacher');
                    }
                } catch (error) {
                    console.error('Error loading remembered teacher credentials:', error);
                    localStorage.removeItem('rememberedTeacher');
                }
            }
        }

        function clearRememberedCredentials(type) {
            if (type === 'student') {
                localStorage.removeItem('rememberedStudent');
            } else if (type === 'teacher') {
                localStorage.removeItem('rememberedTeacher');
            }
        }

        async function testSupabaseConnection() {
            try {
                console.log('Supabase baƒülantƒ±sƒ± test ediliyor...');
                
                // Test basic connection
                const { data, error } = await supabase.from('teachers').select('count');
                if (error) {
                    console.error('Teachers table error:', error);
                    // If table doesn't exist, try to create tables
                    await createMissingTables();
                } else {
                    console.log('Supabase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!');
                }
                
                // Verify all required tables exist
                await verifyTables();
                
            } catch (error) {
                console.error('Supabase baƒülantƒ± hatasƒ±:', error);
                showNotification('Veritabanƒ± baƒülantƒ±sƒ± kurulamadƒ±. L√ºtfen Supabase ayarlarƒ±nƒ± kontrol edin.', 'error');
            }
        }

        async function createMissingTables() {
            console.log('Eksik tablolar olu≈üturuluyor...');
            
            try {
                // Create teachers table
                await supabase.rpc('create_teachers_table');
                
                // Create students table  
                await supabase.rpc('create_students_table');
                
                // Create tests table
                await supabase.rpc('create_tests_table');
                
                // Create test_assignments table
                await supabase.rpc('create_test_assignments_table');
                
                // Create test_results table
                await supabase.rpc('create_test_results_table');
                
                // Create student_badges table
                await supabase.rpc('create_student_badges_table');
                
                console.log('Tablolar ba≈üarƒ±yla olu≈üturuldu!');
                
            } catch (error) {
                console.error('Tablo olu≈üturma hatasƒ±:', error);
                // If RPC functions don't exist, show manual SQL
                showTableCreationSQL();
            }
        }

        async function verifyTables() {
            const requiredTables = ['teachers', 'students', 'tests', 'test_assignments', 'test_results', 'student_badges'];
            const missingTables = [];
            
            for (const table of requiredTables) {
                try {
                    const { error } = await supabase.from(table).select('*').limit(1);
                    if (error && error.code === 'PGRST116') {
                        missingTables.push(table);
                    }
                } catch (error) {
                    console.error(`Error checking table ${table}:`, error);
                    missingTables.push(table);
                }
            }
            
            if (missingTables.length > 0) {
                console.error('Eksik tablolar:', missingTables);
                showTableCreationSQL();
            } else {
                console.log('T√ºm gerekli tablolar mevcut ‚úì');
                await insertSampleData();
            }
        }

        function showTableCreationSQL() {
            const sqlCommands = `
-- Supabase SQL Editor'da √ßalƒ±≈ütƒ±rmanƒ±z gereken komutlar:

-- 1. Teachers table
CREATE TABLE IF NOT EXISTS teachers (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. Students table
CREATE TABLE IF NOT EXISTS students (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    tc_no VARCHAR(11) UNIQUE NOT NULL,
    student_no VARCHAR(50) UNIQUE NOT NULL,
    class VARCHAR(10) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 3. Tests table
CREATE TABLE IF NOT EXISTS tests (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    reading_text TEXT NOT NULL,
    text_display_mode VARCHAR(20) DEFAULT 'first_page_only',
    questions JSONB NOT NULL,
    time_limit INTEGER DEFAULT 30,
    created_by INTEGER REFERENCES teachers(id),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 4. Add text_display_mode column if it doesn't exist (for existing tables)
ALTER TABLE tests ADD COLUMN IF NOT EXISTS text_display_mode VARCHAR(20) DEFAULT 'first_page_only';

-- 4. Test assignments table
CREATE TABLE IF NOT EXISTS test_assignments (
    id SERIAL PRIMARY KEY,
    test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    assigned_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(test_id, student_id)
);

-- 5. Test results table
CREATE TABLE IF NOT EXISTS test_results (
    id SERIAL PRIMARY KEY,
    test_id INTEGER REFERENCES tests(id) ON DELETE CASCADE,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    score INTEGER NOT NULL,
    answers JSONB,
    completed_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(test_id, student_id)
);

-- 6. Student badges table
CREATE TABLE IF NOT EXISTS student_badges (
    id SERIAL PRIMARY KEY,
    student_id INTEGER REFERENCES students(id) ON DELETE CASCADE,
    badge_type VARCHAR(50) NOT NULL,
    earned_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(student_id, badge_type)
);

-- 7. Insert sample teacher (username: admin, password: admin123)
INSERT INTO teachers (name, username, password) 
VALUES ('√ñrnek √ñƒüretmen', 'admin', 'admin123')
ON CONFLICT (username) DO NOTHING;

-- 8. Insert sample students
INSERT INTO students (name, tc_no, student_no, class) VALUES
('Ahmet Yƒ±lmaz', '12345678901', '2024001', '8A'),
('Ay≈üe Demir', '12345678902', '2024002', '8A'),
('Mehmet Kaya', '12345678903', '2024003', '8B'),
('Fatma ≈ûahin', '12345678904', '2024004', '8B'),
('Ali √ñzkan', '12345678905', '2024005', '8A')
ON CONFLICT (tc_no) DO NOTHING;
            `;
            
            console.log('SQL Komutlarƒ±:');
            console.log(sqlCommands);
            
            // Show modal with SQL commands
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-900">Supabase Tablo Kurulumu Gerekli</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <h4 class="font-semibold text-yellow-800">Gerekli Tablolar Eksik</h4>
                            </div>
                            <p class="text-yellow-700 text-sm">
                                Sistem √ßalƒ±≈ümasƒ± i√ßin gerekli veritabanƒ± tablolarƒ± bulunamadƒ±. 
                                L√ºtfen a≈üaƒüƒ±daki SQL komutlarƒ±nƒ± Supabase SQL Editor'da √ßalƒ±≈ütƒ±rƒ±n.
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Adƒ±mlar:</h4>
                            <ol class="list-decimal list-inside text-sm text-gray-700 space-y-1">
                                <li>Supabase Dashboard'a gidin</li>
                                <li>SQL Editor sekmesini a√ßƒ±n</li>
                                <li>A≈üaƒüƒ±daki SQL kodunu kopyalayƒ±p yapƒ±≈ütƒ±rƒ±n</li>
                                <li>RUN butonuna tƒ±klayƒ±n</li>
                                <li>Sayfayƒ± yenileyin</li>
                            </ol>
                        </div>
                        
                        <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm overflow-x-auto">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-gray-400">SQL Komutlarƒ±:</span>
                                <button onclick="copyToClipboard(\`${sqlCommands.replace(/`/g, '\\`')}\`)" 
                                        class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">
                                    <i class="fas fa-copy mr-1"></i>Kopyala
                                </button>
                            </div>
                            <pre class="whitespace-pre-wrap">${sqlCommands}</pre>
                        </div>
                        
                        <div class="mt-4 flex justify-end space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Kapat
                            </button>
                            <button onclick="location.reload()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Sayfayƒ± Yenile
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function insertSampleData() {
            try {
                // Check if sample teacher exists
                const { data: teachers } = await supabase
                    .from('teachers')
                    .select('*')
                    .limit(1);
                
                if (!teachers || teachers.length === 0) {
                    // Insert sample teacher
                    await supabase
                        .from('teachers')
                        .insert({
                            name: '√ñrnek √ñƒüretmen',
                            username: 'admin',
                            password: 'admin123'
                        });
                    console.log('√ñrnek √∂ƒüretmen eklendi (admin/admin123)');
                }
                
                // Check if sample students exist
                const { data: students } = await supabase
                    .from('students')
                    .select('*')
                    .limit(1);
                
                if (!students || students.length === 0) {
                    // Insert sample students
                    await supabase
                        .from('students')
                        .insert([
                            { name: 'Ahmet Yƒ±lmaz', tc_no: '12345678901', student_no: '2024001', class: '8A' },
                            { name: 'Ay≈üe Demir', tc_no: '12345678902', student_no: '2024002', class: '8A' },
                            { name: 'Mehmet Kaya', tc_no: '12345678903', student_no: '2024003', class: '8B' },
                            { name: 'Fatma ≈ûahin', tc_no: '12345678904', student_no: '2024004', class: '8B' },
                            { name: 'Ali √ñzkan', tc_no: '12345678905', student_no: '2024005', class: '8A' }
                        ]);
                    console.log('√ñrnek √∂ƒürenciler eklendi');
                }
                
            } catch (error) {
                console.error('√ñrnek veri ekleme hatasƒ±:', error);
            }
        }

        // Navigation functions
        function showStudentLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('studentLoginScreen').classList.remove('hidden');
        }

        function showTeacherLogin() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('teacherLoginScreen').classList.remove('hidden');
        }

        function showMainLogin() {
            document.getElementById('studentLoginScreen').classList.add('hidden');
            document.getElementById('teacherLoginScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        // Student login
        async function studentLogin(event) {
            event.preventDefault();
            const tc = document.getElementById('studentTC').value;
            const studentNo = document.getElementById('studentNo').value;
            const rememberMe = document.getElementById('rememberStudent').checked;

            try {
                const { data, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('tc_no', tc)
                    .eq('student_no', studentNo)
                    .single();
const { data, error } = await supabase.rpc('student_login');

                if (error) throw error;

                if (data) {
                    currentUser = { ...data, type: 'student' };
                    
                    // Handle remember me functionality
                    if (rememberMe) {
                        saveCredentials('student', { tc, studentNo });
                        showNotification('Giri≈ü bilgileriniz hatƒ±rlandƒ±! üìù', 'success');
                    } else {
                        clearRememberedCredentials('student');
                    }
                    
                    showStudentDashboard();
                } else {
                    showNotification('√ñƒürenci bulunamadƒ±. TC ve √∂ƒürenci numaranƒ±zƒ± kontrol edin.', 'error');
                }
            } catch (error) {
                console.error('Student login error:', error);
                showNotification('Giri≈ü yapƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Teacher login
        async function teacherLogin(event) {
            event.preventDefault();
            const username = document.getElementById('teacherUsername').value;
            const password = document.getElementById('teacherPassword').value;
            const rememberMe = document.getElementById('rememberTeacher').checked;

            try {
                const { data, error } = await supabase
                    .from('teachers')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .single();

                if (error) throw error;

                if (data) {
                    currentUser = { ...data, type: 'teacher' };
                    
                    // Handle remember me functionality
                    if (rememberMe) {
                        saveCredentials('teacher', { username });
                        showNotification('Giri≈ü bilgileriniz hatƒ±rlandƒ±! üìù', 'success');
                    } else {
                        clearRememberedCredentials('teacher');
                    }
                    
                    showTeacherDashboard();
                } else {
                    showNotification('Kullanƒ±cƒ± adƒ± veya ≈üifre hatalƒ±.', 'error');
                }
            } catch (error) {
                console.error('Teacher login error:', error);
                showNotification('Giri≈ü yapƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Show student dashboard
        async function showStudentDashboard() {
            hideAllScreens();
            document.getElementById('studentDashboard').classList.remove('hidden');
            document.getElementById('studentInfo').textContent = `${currentUser.name} (${currentUser.student_no})`;
            
            // Handle impersonation UI
            const isImpersonating = impersonatedStudent !== null;
            document.getElementById('impersonationBadge').classList.toggle('hidden', !isImpersonating);
            document.getElementById('exitImpersonationButton').classList.toggle('hidden', !isImpersonating);
            document.getElementById('studentLogoutButton').classList.toggle('hidden', isImpersonating);

            await loadStudentData();
        }

        // Show teacher dashboard
        async function showTeacherDashboard() {
            hideAllScreens();
            document.getElementById('teacherDashboard').classList.remove('hidden');
            document.getElementById('teacherInfo').textContent = `${currentUser.name}`;
            
            await loadTeacherData();
        }

        function hideAllScreens() {
            const screens = ['loginScreen', 'studentLoginScreen', 'teacherLoginScreen', 'studentDashboard', 'teacherDashboard', 'testScreen', 'textReadingScreen'];
            screens.forEach(screen => {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        // Show text reading screen
        function showTextReadingScreen() {
            hideAllScreens();
            document.getElementById('textReadingScreen').classList.remove('hidden');
            
            document.getElementById('readingTestTitle').textContent = currentTest.title;
            document.getElementById('readingTestDescription').textContent = currentTest.description || '';
            document.getElementById('readingTextContent').textContent = currentTest.reading_text;
            
            // Reset font size to default
            currentFontSize = 16;
            document.getElementById('readingFontSizeIndicator').textContent = '16px';
            document.getElementById('readingTextContent').style.fontSize = '16px';
        }

        // Font size control for reading screen
        function changeReadingFontSize(direction) {
            const currentIndex = fontSizes.indexOf(currentFontSize);
            let newIndex = currentIndex + direction;
            
            // Clamp to valid range
            newIndex = Math.max(0, Math.min(fontSizes.length - 1, newIndex));
            currentFontSize = fontSizes[newIndex];
            
            // Update font size indicator
            document.getElementById('readingFontSizeIndicator').textContent = `${currentFontSize}px`;
            
            // Apply font size to reading text
            document.getElementById('readingTextContent').style.fontSize = `${currentFontSize}px`;
        }

        // Start questions from reading screen
        function startQuestionsFromReading() {
            showTestScreen();
            startTimer(currentTest.time_limit * 60); // Convert minutes to seconds
            displayQuestion();
        }

        // Start test timer
        function startTimer(seconds) {
            if (testTimer) clearInterval(testTimer);
            
            timeRemaining = seconds;
            
            testTimer = setInterval(() => {
                timeRemaining--;
                
                if (timeRemaining <= 0) {
                    clearInterval(testTimer);
                    // Auto submit when time runs out
                    submitTest();
                }
            }, 1000);
        }

        // Load student data
        async function loadStudentData() {
            try {
                // Load assigned tests
                const { data: assignments } = await supabase
                    .from('test_assignments')
                    .select(`
                        *,
                        tests (*)
                    `)
                    .eq('student_id', currentUser.id);

                // Load test results
                const { data: results } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('student_id', currentUser.id);

                // Load badges
                const { data: badges } = await supabase
                    .from('student_badges')
                    .select(`
                        *,
                        badges (*)
                    `)
                    .eq('student_id', currentUser.id);

                // Store results globally for filtering
                window.currentStudentResults = results;
                
                updateStudentStats(assignments, results, badges);
                displayAssignedTests(assignments, results);
                displayStudentBadges(badges);
                await loadLeaderboard();

            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }

        // Update student statistics
        function updateStudentStats(assignments, results, badges) {
            document.getElementById('totalTests').textContent = assignments?.length || 0;
            document.getElementById('completedTests').textContent = results?.length || 0;
            
            const avgScore = results?.length > 0 
                ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length)
                : 0;
            document.getElementById('averageScore').textContent = avgScore;
            document.getElementById('badgeCount').textContent = badges?.length || 0;
        }

        // Display assigned tests with one-time completion logic
        function displayAssignedTests(assignments, results) {
            // Store all test data for filtering
            allStudentTestsData = assignments || [];
            
            // Apply current filter
            filterStudentTests(assignments, results);
        }

        // Filter student tests
        function filterStudentTests(assignments = null, results = null) {
            // Use stored data if not provided
            if (!assignments) assignments = allStudentTestsData;
            if (!results) {
                // Get results from global state or fetch them
                results = window.currentStudentResults || [];
            }
            
            const container = document.getElementById('assignedTests');
            container.innerHTML = '';

            if (!assignments || assignments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Hen√ºz atanmƒ±≈ü test bulunmuyor.</p>
                        <p class="text-gray-400 text-sm mt-2">√ñƒüretmeniniz size test atadƒ±ƒüƒ±nda burada g√∂r√ºnecek.</p>
                    </div>
                `;
                updateStudentTestFilterInfo(0, 0);
                return;
            }

            // Filter assignments based on current filter
            let filteredAssignments = [...assignments];
            
            switch (currentStudentTestFilter) {
                case 'waiting':
                    // Only assignments without results
                    filteredAssignments = assignments.filter(assignment => {
                        const result = results?.find(r => r.test_id === assignment.test_id);
                        return !result;
                    });
                    break;
                case 'successful':
                    // Only assignments with results >= 70
                    filteredAssignments = assignments.filter(assignment => {
                        const result = results?.find(r => r.test_id === assignment.test_id);
                        return result && result.score >= 70;
                    });
                    break;
                case 'low_score':
                    // Only assignments with results < 70
                    filteredAssignments = assignments.filter(assignment => {
                        const result = results?.find(r => r.test_id === assignment.test_id);
                        return result && result.score < 70;
                    });
                    break;
                case 'all':
                default:
                    // Show all assignments
                    break;
            }

            if (filteredAssignments.length === 0) {
                const filterMessages = {
                    'waiting': 'Bekleyen test bulunmuyor.',
                    'successful': 'Ba≈üarƒ±lƒ± test bulunmuyor.',
                    'low_score': 'D√º≈ü√ºk puan alan test bulunmuyor.',
                    'all': 'Test bulunmuyor.'
                };
                
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">${filterMessages[currentStudentTestFilter]}</p>
                        <p class="text-gray-400 text-sm mt-2">Farklƒ± bir filtre se√ßerek diƒüer testleri g√∂rebilirsiniz.</p>
                    </div>
                `;
                updateStudentTestFilterInfo(filteredAssignments.length, assignments.length);
                return;
            }

            filteredAssignments.forEach(assignment => {
                const result = results?.find(r => r.test_id === assignment.test_id);
                const isCompleted = !!result;
                const passed = result && result.score >= 70;
                const failed = result && result.score < 70;

                // Determine status and styling
                let statusBadge, statusColor, buttonContent, buttonAction, buttonClass;
                
                if (!isCompleted) {
                    statusBadge = 'üü° Bekliyor';
                    statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    buttonContent = '<i class="fas fa-play mr-2"></i>Teste Ba≈üla';
                    buttonAction = `onclick="startTest(${assignment.test_id})"`;
                    buttonClass = 'px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 font-semibold';
                } else if (passed) {
                    statusBadge = 'üü¢ Ba≈üarƒ±lƒ±';
                    statusColor = 'bg-green-100 text-green-800 border-green-200';
                    buttonContent = '<i class="fas fa-trophy mr-2"></i>Tamamlandƒ±';
                    buttonAction = '';
                    buttonClass = 'px-6 py-3 bg-green-100 text-green-800 rounded-lg cursor-default font-semibold';
                } else {
                    statusBadge = 'üî¥ D√º≈ü√ºk Puan';
                    statusColor = 'bg-red-100 text-red-800 border-red-200';
                    buttonContent = '<i class="fas fa-lock mr-2"></i>Tamamlandƒ±';
                    buttonAction = 'onclick="showRetakeMessage()"';
                    buttonClass = 'px-6 py-3 bg-gray-400 text-white rounded-lg cursor-not-allowed font-semibold';
                }

                const testCard = document.createElement('div');
                testCard.className = `bg-white rounded-xl p-6 border-2 ${statusColor.includes('yellow') ? 'border-yellow-200 hover:border-yellow-300' : statusColor.includes('green') ? 'border-green-200' : 'border-red-200'} hover:shadow-lg transition-all duration-300`;
                testCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <!-- Test Header -->
                            <div class="flex items-center mb-3">
                                <h4 class="font-bold text-gray-900 text-lg">${assignment.tests.title}</h4>
                                <span class="ml-3 px-3 py-1 text-sm font-medium rounded-full border ${statusColor}">
                                    ${statusBadge}
                                </span>
                            </div>
                            
                            <p class="text-gray-600 mb-4">${assignment.tests.description || 'Test a√ßƒ±klamasƒ± bulunmuyor.'}</p>
                            
                            <!-- Test Info Grid -->
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-4">
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <div class="text-lg font-bold text-gray-800">${assignment.tests.time_limit}</div>
                                    <div class="text-xs text-gray-600">Dakika</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-3 text-center">
                                    <div class="text-lg font-bold text-blue-800">${(() => {
                                        try {
                                            const questions = JSON.parse(assignment.tests.questions);
                                            return Array.isArray(questions) ? questions.length : 7;
                                        } catch (e) {
                                            return 7;
                                        }
                                    })()}</div>
                                    <div class="text-xs text-blue-600">Soru</div>
                                </div>
                                ${result ? `
                                    <div class="bg-${result.score >= 70 ? 'green' : 'red'}-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-${result.score >= 70 ? 'green' : 'red'}-800">${result.score}</div>
                                        <div class="text-xs text-${result.score >= 70 ? 'green' : 'red'}-600">Puan</div>
                                    </div>
                                ` : `
                                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                                        <div class="text-lg font-bold text-gray-800">-</div>
                                        <div class="text-xs text-gray-600">Puan</div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- Additional Info -->
                            <div class="text-sm text-gray-500">
                                <div class="flex items-center mb-1">
                                    <i class="fas fa-calendar mr-2"></i>
                                    Atanma: ${new Date(assignment.assigned_at).toLocaleDateString('tr-TR')}
                                </div>
                                ${result ? `
                                    <div class="flex items-center">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Tamamlanma: ${new Date(result.completed_at).toLocaleDateString('tr-TR')}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Warning for failed tests -->
                            ${failed ? `
                                <div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                                    <div class="flex items-center">
                                        <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                        <div>
                                            <p class="text-red-800 font-medium text-sm">Tekrar √á√∂zme Hakkƒ±</p>
                                            <p class="text-red-700 text-xs mt-1">
                                                Bu testi tekrar √ß√∂zebilmek i√ßin √∂ƒüretmeninizin size yeniden atama yapmasƒ± gerekmektedir.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Action Button -->
                        <div class="ml-6 flex flex-col items-end">
                            <button ${buttonAction} class="${buttonClass}">
                                ${buttonContent}
                            </button>
                            
                            ${!isCompleted ? `
                                <div class="mt-2 text-xs text-gray-500 text-center">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Tek seferlik test
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(testCard);
            });
            
            // Update filter info
            updateStudentTestFilterInfo(filteredAssignments.length, assignments.length);
        }

        // Start test with assignment validation
        async function startTest(testId) {
            try {
                console.log('Starting test with ID:', testId, 'for student:', currentUser.id);
                
                if (!currentUser || !currentUser.id) {
                    console.error('No current user found');
                    showNotification('Kullanƒ±cƒ± oturumu bulunamadƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.', 'error');
                    return;
                }
                
                // First, check if student has valid assignment
                const { data: assignment, error: assignmentError } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('test_id', testId)
                    .eq('student_id', currentUser.id)
                    .maybeSingle(); // Use maybeSingle instead of single to handle no results

                console.log('Assignment query result:', { assignment, assignmentError });

                if (assignmentError) {
                    console.error('Assignment query error:', assignmentError);
                    showNotification('Atama kontrol√º yapƒ±lƒ±rken hata olu≈ütu.', 'error');
                    return;
                }

                if (!assignment) {
                    console.error('Assignment not found for student:', currentUser.id, 'test:', testId);
                    showNotification('Bu test size atanmamƒ±≈ü veya eri≈üim yetkiniz yok.', 'error');
                    return;
                }

                // Check if test is already completed (separate query for better reliability)
                const { data: existingResult, error: resultError } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('test_id', testId)
                    .eq('student_id', currentUser.id)
                    .maybeSingle(); // Use maybeSingle instead of single

                console.log('Existing result check:', { existingResult, resultError });

                if (resultError) {
                    console.error('Result query error:', resultError);
                    showNotification('Test sonucu kontrol√º yapƒ±lƒ±rken hata olu≈ütu.', 'error');
                    return;
                }

                if (existingResult) {
                    if (existingResult.score >= 70) {
                        showNotification('Bu testi zaten ba≈üarƒ±yla tamamladƒ±nƒ±z. Tekrar √ß√∂zemezsiniz.', 'warning');
                    } else {
                        showNotification('Bu testi zaten tamamladƒ±nƒ±z. √ñƒüretmeninizin tekrar atamasƒ±nƒ± bekleyin.', 'warning');
                    }
                    return;
                }

                // Load test data
                const { data: test, error: testError } = await supabase
                    .from('tests')
                    .select('*')
                    .eq('id', testId)
                    .single();

                if (testError) {
                    console.error('Test loading error:', testError);
                    showNotification('Test verileri y√ºklenirken hata olu≈ütu.', 'error');
                    return;
                }

                if (!test) {
                    console.error('Test not found:', testId);
                    showNotification('Test bulunamadƒ±.', 'error');
                    return;
                }

                // Parse questions safely
                let questions;
                try {
                    questions = JSON.parse(test.questions);
                    if (!Array.isArray(questions) || questions.length === 0) {
                        throw new Error('Invalid questions format');
                    }
                } catch (parseError) {
                    console.error('Questions parsing error:', parseError);
                    showNotification('Test sorularƒ± y√ºklenirken hata olu≈ütu.', 'error');
                    return;
                }

                currentTest = {
                    ...test,
                    questions: questions,
                    currentQuestion: 0,
                    answers: {},
                    startTime: new Date(),
                    assignmentId: assignment.id
                };

                console.log('Test loaded successfully:', currentTest);

                // Show mobile-friendly confirmation dialog
                const confirmStart = await showMobileConfirmDialog({
                    title: 'üéØ Test Ba≈ülatma Onayƒ±',
                    message: `Test: ${test.title}\nS√ºre: ${test.time_limit} dakika\nSoru Sayƒ±sƒ±: ${questions.length}`,
                    warning: '‚ö†Ô∏è √ñNEMLƒ∞ UYARI:\n‚Ä¢ Bu test sadece 1 kez √ß√∂z√ºlebilir\n‚Ä¢ Test ba≈üladƒ±ktan sonra iptal edemezsiniz\n‚Ä¢ S√ºre dolduƒüunda otomatik teslim edilir',
                    question: 'Teste ba≈ülamak istediƒüinizden emin misiniz?'
                });

                if (!confirmStart) {
                    console.log('Test start cancelled by user');
                    currentTest = null;
                    return;
                }

                console.log('Starting test with display mode:', test.text_display_mode);
                
                // Handle different text display modes
                const displayMode = test.text_display_mode || 'first_page_only';
                
                switch (displayMode) {
                    case 'first_page_only':
                        // Show text reading screen first (default behavior)
                        showTextReadingScreen();
                        break;
                    case 'with_questions':
                        // Show test screen with text visible alongside questions
                        showTestScreenWithText();
                        break;
                    case 'no_text':
                        // Skip text, go directly to questions
                        showTestScreen();
                        startTimer(currentTest.time_limit * 60);
                        displayQuestion();
                        break;
                    default:
                        // Fallback to default behavior
                        showTextReadingScreen();
                        break;
                }

            } catch (error) {
                console.error('Error starting test:', error);
                showNotification(`Test ba≈ülatƒ±lƒ±rken hata olu≈ütu: ${error.message}`, 'error');
            }
        }

        // Show test screen
        function showTestScreen() {
            hideAllScreens();
            document.getElementById('testScreen').classList.remove('hidden');
            
            document.getElementById('testTitle').textContent = currentTest.title;
            document.getElementById('testDescription').textContent = currentTest.description || '';
            
            // Hide text in question screen (text was already shown separately)
            const readingTextColumn = document.getElementById('readingTextColumn');
            const questionColumn = document.getElementById('questionColumn');
            const testLayout = document.getElementById('testLayout');
            
            readingTextColumn.classList.add('hidden');
            questionColumn.className = 'col-span-full';
            testLayout.className = 'grid grid-cols-1 gap-6';
            
            // Reset font size to default
            currentFontSize = 16;
            document.getElementById('fontSizeIndicator').textContent = '16px';
        }

        // Show test screen with text visible alongside questions
        function showTestScreenWithText() {
            hideAllScreens();
            document.getElementById('testScreen').classList.remove('hidden');
            
            document.getElementById('testTitle').textContent = currentTest.title;
            document.getElementById('testDescription').textContent = currentTest.description || '';
            
            // Show text alongside questions
            const readingTextColumn = document.getElementById('readingTextColumn');
            const questionColumn = document.getElementById('questionColumn');
            const testLayout = document.getElementById('testLayout');
            
            readingTextColumn.classList.remove('hidden');
            questionColumn.className = 'lg:col-span-2';
            testLayout.className = 'grid grid-cols-1 lg:grid-cols-3 gap-6';
            
            // Populate reading text
            document.getElementById('textContent').textContent = currentTest.reading_text;
            
            // Reset font size to default
            currentFontSize = 16;
            document.getElementById('fontSizeIndicator').textContent = '16px';
            
            // Start timer and display first question
            startTimer(currentTest.time_limit * 60);
            displayQuestion();
        }

        // Start question timer with custom time limit
        function startQuestionTimer() {
            if (questionTimer) clearInterval(questionTimer);
            
            // Get current question's time limit (default to 75 if not set)
            const currentQuestion = currentTest.questions[currentTest.currentQuestion];
            questionTimeRemaining = currentQuestion.timeLimit || 75;
            
            console.log(`Starting timer for question ${currentTest.currentQuestion + 1}: ${questionTimeRemaining} seconds`);
            
            updateQuestionTimerDisplay();
            
            questionTimer = setInterval(() => {
                questionTimeRemaining--;
                updateQuestionTimerDisplay();
                
                if (questionTimeRemaining <= 0) {
                    clearInterval(questionTimer);
                    // Auto advance to next question when time runs out
                    nextQuestion();
                }
            }, 1000);
        }

        // Update question timer display
        function updateQuestionTimerDisplay() {
            const timerEl = document.getElementById('questionTimer');
            timerEl.textContent = questionTimeRemaining;
            
            // Change color based on remaining time
            if (questionTimeRemaining <= 15) {
                timerEl.className = 'text-2xl font-bold text-red-600 mb-1 animate-pulse';
            } else if (questionTimeRemaining <= 30) {
                timerEl.className = 'text-2xl font-bold text-yellow-600 mb-1';
            } else {
                timerEl.className = 'text-2xl font-bold text-green-600 mb-1';
            }
        }

        // Font size control
        function changeFontSize(direction) {
            const currentIndex = fontSizes.indexOf(currentFontSize);
            let newIndex = currentIndex + direction;
            
            // Clamp to valid range
            newIndex = Math.max(0, Math.min(fontSizes.length - 1, newIndex));
            currentFontSize = fontSizes[newIndex];
            
            // Update font size indicator
            document.getElementById('fontSizeIndicator').textContent = `${currentFontSize}px`;
            
            // Apply font size to question text
            document.getElementById('questionText').style.fontSize = `${currentFontSize + 4}px`;
            
            // Apply to answer options
            const answerOptions = document.querySelectorAll('#answerOptions label span, #answerOptions input');
            answerOptions.forEach(el => {
                if (el.tagName === 'SPAN') {
                    el.style.fontSize = `${currentFontSize}px`;
                } else if (el.tagName === 'INPUT') {
                    el.style.fontSize = `${currentFontSize}px`;
                }
            });
        }

        // Display current question with specialized designs
        function displayQuestion() {
            const question = currentTest.questions[currentTest.currentQuestion];
            const questionNumber = currentTest.currentQuestion + 1;
            const totalQuestions = currentTest.questions.length;
            
            console.log('Displaying question:', questionNumber, 'of', totalQuestions, question);
            
            // Update progress - ensure correct total is shown
            document.getElementById('currentQuestionNumber').textContent = questionNumber;
            document.getElementById('progressText').textContent = `Soru ${questionNumber}/${totalQuestions}`;
            document.getElementById('progressBar').style.width = `${(questionNumber / totalQuestions) * 100}%`;
            
            // Set question type badge
            const typeMap = {
                'multiple_choice': { text: '√áoktan Se√ßmeli', color: 'bg-blue-100 text-blue-800' },
                'fill_blank': { text: 'Bo≈üluk Doldurma', color: 'bg-yellow-100 text-yellow-800' },
                'true_false': { text: 'Doƒüru/Yanlƒ±≈ü', color: 'bg-green-100 text-green-800' }
            };
            const typeInfo = typeMap[question.type] || { text: 'Bilinmeyen', color: 'bg-gray-100 text-gray-800' };
            document.getElementById('questionType').textContent = typeInfo.text;
            document.getElementById('questionType').className = `px-3 py-1 rounded-full text-sm font-medium ${typeInfo.color}`;
            
            // Always set question text first, regardless of type
            document.getElementById('questionText').textContent = question.question || 'Soru metni bulunamadƒ±';
            
            // Display answer options with specialized designs
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            if (question.type === 'multiple_choice') {
                // A) √áoktan Se√ßmeli Sorular (3 Se√ßenekli)
                console.log('Rendering multiple choice question with options:', question.options);
                
                const letters = ['A', 'B', 'C'];
                const availableOptions = question.options || [];
                
                // Ensure we have at least 3 options, pad with empty if needed
                const optionsToShow = [...availableOptions];
                while (optionsToShow.length < 3) {
                    optionsToShow.push(`Se√ßenek ${optionsToShow.length + 1}`);
                }
                
                // Only show first 3 options
                const finalOptions = optionsToShow.slice(0, 3);
                
                finalOptions.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'mb-4';
                    
                    // Clean the option text by removing any existing letter prefixes
                    const cleanOption = option.replace(/^[A-C]\)\s*/, '').trim();
                    const isSelected = currentTest.answers[currentTest.currentQuestion] == index;
                    
                    console.log(`Option ${index}:`, cleanOption, 'Selected:', isSelected);
                    
                    optionDiv.innerHTML = `
                        <div class="option-choice p-5 border-2 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200 bg-white'} rounded-xl hover:border-blue-300 hover:shadow-sm cursor-pointer transition-all duration-200" 
                             onclick="selectMultipleChoice(${index})">
                            <div class="flex items-start space-x-4">
                                <div class="option-circle w-12 h-12 rounded-full border-2 ${isSelected ? 'bg-blue-500 text-white border-blue-500' : 'border-gray-300 bg-white text-gray-600'} flex items-center justify-center font-bold text-lg flex-shrink-0 mt-1">
                                    ${letters[index]}
                                </div>
                                <div class="option-text flex-1 min-w-0">
                                    <span class="text-lg font-medium text-gray-800 leading-relaxed block break-words">${cleanOption}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
            } else if (question.type === 'fill_blank') {
                // B) Bo≈üluk Doldurma Sorularƒ±
                // Create interactive sentence with clickable blank
                const blankId = 'fillBlank_' + currentTest.currentQuestion;
                const selectedWord = currentTest.answers[currentTest.currentQuestion] || '';
                
                const sentenceWithBlank = question.question.replace(/___+/g, 
                    `<span id="${blankId}" class="inline-block min-w-[120px] px-3 py-1 mx-1 border-2 border-dashed border-gray-400 rounded cursor-pointer text-center font-semibold ${selectedWord ? 'bg-yellow-200 border-yellow-400' : 'bg-gray-100'}">${selectedWord || '[___]'}</span>`
                );
                
                document.getElementById('questionText').innerHTML = sentenceWithBlank;
                
                // Word options below the sentence
                const wordOptions = question.options || ['kelime1', 'kelime2', 'kelime3'];
                optionsContainer.innerHTML = `
                    <div class="mt-8">
                        <p class="text-sm font-medium text-gray-700 mb-4">Bo≈üluƒüa uygun kelimeyi se√ßin:</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            ${wordOptions.map((word, index) => `
                                <div class="word-option p-3 border-2 border-gray-200 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 cursor-pointer transition-all duration-200 text-center font-medium ${currentTest.answers[currentTest.currentQuestion] === word ? 'border-yellow-400 bg-yellow-100' : ''}"
                                     onclick="selectFillBlankWord('${word}', '${blankId}')">
                                    ${word}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
            } else if (question.type === 'true_false') {
                // C) Doƒüru/Yanlƒ±≈ü Sorularƒ±
                document.getElementById('questionText').textContent = question.question || 'Soru metni bulunamadƒ±';
                
                optionsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                        <div class="true-false-option p-8 border-3 border-green-200 rounded-2xl hover:border-green-400 hover:bg-green-50 cursor-pointer transition-all duration-200 text-center ${currentTest.answers[currentTest.currentQuestion] === 'true' ? 'border-green-500 bg-green-100 shadow-lg' : ''}"
                             onclick="selectTrueFalse('true')">
                            <div class="w-20 h-20 rounded-full bg-green-500 flex items-center justify-center mb-4 mx-auto ${currentTest.answers[currentTest.currentQuestion] === 'true' ? 'ring-4 ring-green-300 shadow-lg' : ''}">
                                <i class="fas fa-check text-3xl text-white"></i>
                            </div>
                            <span class="text-2xl font-bold text-green-700">DOƒûRU</span>
                        </div>
                        <div class="true-false-option p-8 border-3 border-red-200 rounded-2xl hover:border-red-400 hover:bg-red-50 cursor-pointer transition-all duration-200 text-center ${currentTest.answers[currentTest.currentQuestion] === 'false' ? 'border-red-500 bg-red-100 shadow-lg' : ''}"
                             onclick="selectTrueFalse('false')">
                            <div class="w-20 h-20 rounded-full bg-red-500 flex items-center justify-center mb-4 mx-auto ${currentTest.answers[currentTest.currentQuestion] === 'false' ? 'ring-4 ring-red-300 shadow-lg' : ''}">
                                <i class="fas fa-times text-3xl text-white"></i>
                            </div>
                            <span class="text-2xl font-bold text-red-700">YANLI≈û</span>
                        </div>
                    </div>
                `;
            }
            
            // Start question timer (75 seconds)
            startQuestionTimer();
            
            // Update navigation - only next button
            const nextButton = document.getElementById('nextButton');
            if (currentTest.currentQuestion === totalQuestions - 1) {
                nextButton.innerHTML = 'Testi Bitir <i class="fas fa-flag-checkered ml-2"></i>';
                nextButton.className = 'px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-300 text-lg font-semibold';
            } else {
                nextButton.innerHTML = 'ƒ∞leri <i class="fas fa-arrow-right ml-2"></i>';
                nextButton.className = 'px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 text-lg font-semibold';
            }
        }

        // Interaction functions for different question types
        function selectMultipleChoice(index) {
            currentTest.answers[currentTest.currentQuestion] = index;
            
            // Update visual selection without changing layout
            const options = document.querySelectorAll('.option-choice');
            options.forEach((option, i) => {
                const circle = option.querySelector('.option-circle');
                const container = option.querySelector('.option-container');
                
                if (i === index) {
                    // Selected state - only change colors, not layout
                    option.classList.remove('border-gray-200', 'bg-white');
                    option.classList.add('border-blue-500', 'bg-blue-50');
                    
                    circle.classList.remove('border-gray-300', 'bg-white', 'text-gray-600');
                    circle.classList.add('border-blue-500', 'bg-blue-500', 'text-white');
                } else {
                    // Unselected state
                    option.classList.remove('border-blue-500', 'bg-blue-50');
                    option.classList.add('border-gray-200', 'bg-white');
                    
                    circle.classList.remove('border-blue-500', 'bg-blue-500', 'text-white');
                    circle.classList.add('border-gray-300', 'bg-white', 'text-gray-600');
                }
            });
        }

        function selectFillBlankWord(word, blankId) {
            currentTest.answers[currentTest.currentQuestion] = word;
            
            // Update the blank in the sentence with yellow highlight
            const blankElement = document.getElementById(blankId);
            blankElement.textContent = word;
            blankElement.className = 'inline-block min-w-[120px] px-3 py-1 mx-1 border-2 border-yellow-400 bg-yellow-200 rounded cursor-pointer text-center font-semibold';
            
            // Update word option selection
            const wordOptions = document.querySelectorAll('.word-option');
            wordOptions.forEach(option => {
                if (option.textContent.trim() === word) {
                    option.className = 'word-option p-3 border-2 border-yellow-400 bg-yellow-100 rounded-lg cursor-pointer transition-all duration-200 text-center font-medium';
                } else {
                    option.className = 'word-option p-3 border-2 border-gray-200 rounded-lg hover:border-yellow-400 hover:bg-yellow-50 cursor-pointer transition-all duration-200 text-center font-medium';
                }
            });
        }

        function selectTrueFalse(value) {
            currentTest.answers[currentTest.currentQuestion] = value;
            
            // Update visual selection
            const trueOption = document.querySelector('.true-false-option:first-child');
            const falseOption = document.querySelector('.true-false-option:last-child');
            const trueCircle = trueOption.querySelector('div');
            const falseCircle = falseOption.querySelector('div');
            
            if (value === 'true') {
                trueOption.className = 'true-false-option p-8 border-3 border-green-500 bg-green-100 shadow-lg rounded-2xl cursor-pointer transition-all duration-200 text-center';
                trueCircle.className = 'w-20 h-20 rounded-full bg-green-500 flex items-center justify-center mb-4 mx-auto ring-4 ring-green-300 shadow-lg';
                falseOption.className = 'true-false-option p-8 border-3 border-red-200 rounded-2xl hover:border-red-400 hover:bg-red-50 cursor-pointer transition-all duration-200 text-center';
                falseCircle.className = 'w-20 h-20 rounded-full bg-red-500 flex items-center justify-center mb-4 mx-auto';
            } else {
                falseOption.className = 'true-false-option p-8 border-3 border-red-500 bg-red-100 shadow-lg rounded-2xl cursor-pointer transition-all duration-200 text-center';
                falseCircle.className = 'w-20 h-20 rounded-full bg-red-500 flex items-center justify-center mb-4 mx-auto ring-4 ring-red-300 shadow-lg';
                trueOption.className = 'true-false-option p-8 border-3 border-green-200 rounded-2xl hover:border-green-400 hover:bg-green-50 cursor-pointer transition-all duration-200 text-center';
                trueCircle.className = 'w-20 h-20 rounded-full bg-green-500 flex items-center justify-center mb-4 mx-auto';
            }
        }

        // Save current answer (legacy support)
        function saveCurrentAnswer() {
            // Answer is already saved by the interaction functions above
            // This function is kept for compatibility
        }

        // Next question (only forward navigation)
        function nextQuestion() {
            saveCurrentAnswer();
            
            // Clear question timer
            if (questionTimer) clearInterval(questionTimer);
            
            if (currentTest.currentQuestion === currentTest.questions.length - 1) {
                submitTest();
            } else {
                currentTest.currentQuestion++;
                displayQuestion();
            }
        }

        // Submit test
        async function submitTest() {
            if (questionTimer) clearInterval(questionTimer);
            
            saveCurrentAnswer();
            
            // Calculate score with individual question points
            let totalPoints = 0;
            let earnedPoints = 0;
            let correctAnswers = 0;
            
            currentTest.questions.forEach((question, index) => {
                const userAnswer = currentTest.answers[index];
                const questionPoints = question.points || 5; // Default 5 points if not specified
                totalPoints += questionPoints;
                
                let isCorrect = false;
                
                if (question.type === 'multiple_choice') {
                    isCorrect = parseInt(userAnswer) === question.correct;
                } else if (question.type === 'fill_blank') {
                    // Handle both word selection and text input formats
                    if (typeof userAnswer === 'string') {
                        isCorrect = userAnswer.toLowerCase().trim() === question.correct.toLowerCase().trim();
                    }
                } else if (question.type === 'true_false') {
                    isCorrect = (userAnswer === 'true') === question.correct;
                }
                
                if (isCorrect) {
                    correctAnswers++;
                    earnedPoints += questionPoints;
                }
            });
            
            // Calculate final score as percentage
            const score = totalPoints > 0 ? Math.round((earnedPoints / totalPoints) * 100) : 0;
            
            try {
                console.log('Submitting test with score:', score, 'Correct answers:', correctAnswers);
                
                // Check if test already completed (prevent duplicate submissions)
                // Use maybeSingle() instead of single() to avoid errors when no result exists
                const { data: existingResult, error: checkError } = await supabase
                    .from('test_results')
                    .select('id')
                    .eq('student_id', currentUser.id)
                    .eq('test_id', currentTest.id)
                    .maybeSingle();

                if (checkError) {
                    console.error('Error checking existing result:', checkError);
                    // Continue with submission even if check fails
                }

                if (existingResult) {
                    console.warn('Test already completed by this student');
                    showNotification('‚ö†Ô∏è Bu testi zaten tamamladƒ±nƒ±z!', 'warning');
                    showTestResult(score, correctAnswers, currentTest.questions.length, earnedPoints, totalPoints);
                    return;
                }

                // Save test result with detailed scoring
                const { data: insertedResult, error } = await supabase
                    .from('test_results')
                    .insert({
                        student_id: currentUser.id,
                        test_id: currentTest.id,
                        score: score,
                        answers: JSON.stringify({
                            answers: currentTest.answers,
                            earnedPoints: earnedPoints,
                            totalPoints: totalPoints,
                            correctAnswers: correctAnswers,
                            totalQuestions: currentTest.questions.length
                        }),
                        completed_at: new Date().toISOString()
                    });

                if (error) {
                    console.error('Insert error:', error);
                    throw error;
                }
                
                console.log('Test result saved successfully');

                // Calculate test duration
                const testDuration = Math.floor((new Date() - currentTest.startTime) / 1000);
                
                // Award badges based on score and performance
                await awardBadges(score, testDuration);
                
                // Show result with detailed scoring
                showTestResult(score, correctAnswers, currentTest.questions.length, earnedPoints, totalPoints);
                
            } catch (error) {
                console.error('Error submitting test:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                showNotification('‚ùå Test sonucu kaydedilirken hata olu≈ütu: ' + (error.message || 'Bilinmeyen hata'), 'error');
            }
        }

        // Award badges
        async function awardBadges(score, testDuration) {
            try {
                // Get current student stats
                const { data: results } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('student_id', currentUser.id);

                const { data: existingBadges } = await supabase
                    .from('student_badges')
                    .select('*')
                    .eq('student_id', currentUser.id);

                const totalTestCount = results?.length || 0;
                const successfulTestCount = results?.filter(r => r.score >= 70).length || 0;
                const hasHighScore = results?.some(r => r.score >= 90) || false;
                const hasPerfectScore = results?.some(r => r.score === 100) || false;
                const newBadges = [];
                const existingBadgeTypes = existingBadges?.map(b => b.badge_type) || [];

                // Check for new badges - using successful test count for most badges
                const badgeChecks = [
                    { type: 'first_step', condition: totalTestCount >= 1, name: 'üê£ ƒ∞lk Adƒ±m' },
                    { type: 'bright_star', condition: score >= 90, name: 'üåà Parlak Yƒ±ldƒ±z' },
                    { type: 'perfect_hit', condition: score === 100, name: 'ü•á Tam ƒ∞sabet' },
                    { type: 'speed_fingers', condition: testDuration && testDuration < 300, name: '‚ö° Hƒ±zlƒ± Parmaklar' },
                    { type: 'patient_hero', condition: successfulTestCount >= 5, name: 'üê¢ Sabƒ±rlƒ± Kahraman' },
                    { type: 'super_student', condition: successfulTestCount >= 10, name: 'ü¶∏ S√ºper √ñƒürenci' },
                    { type: 'knowledge_dragon', condition: successfulTestCount >= 25, name: 'üêâ Bilgi Ejderhasƒ±' },
                    { type: 'shining_mind', condition: successfulTestCount >= 50, name: 'üåü Parlayan Zihin' },
                    { type: 'class_leader', condition: successfulTestCount >= 100, name: 'üëë Sƒ±nƒ±f Lideri' },
                    { type: 'book_worm', condition: successfulTestCount >= 150, name: 'üìöüêõ Kitap Kurdu' }
                ];

                for (const badge of badgeChecks) {
                    if (badge.condition && !existingBadgeTypes.includes(badge.type)) {
                        newBadges.push({
                            student_id: currentUser.id,
                            badge_type: badge.type,
                            earned_at: new Date().toISOString()
                        });
                    }
                }

                // Insert new badges
                if (newBadges.length > 0) {
                    const { error } = await supabase
                        .from('student_badges')
                        .insert(newBadges);
                    
                    if (error) throw error;

                    // Show badge notification
                    setTimeout(() => {
                        newBadges.forEach((badge, index) => {
                            setTimeout(() => {
                                const badgeName = badgeChecks.find(b => b.type === badge.badge_type)?.name;
                                showBadgeNotification(badgeName);
                            }, index * 1000);
                        });
                    }, 2000);
                }

                return newBadges;

            } catch (error) {
                console.error('Error awarding badges:', error);
                return [];
            }
        }

        // Show test result
        function showTestResult(score, correct, total, earnedPoints = null, totalPoints = null) {
            const resultContent = document.getElementById('testResultContent');
            const passed = score >= 70;
            const testDuration = Math.floor((new Date() - currentTest.startTime) / 1000);
            const minutes = Math.floor(testDuration / 60);
            const seconds = testDuration % 60;
            
            // Use earned/total points if available, otherwise calculate from correct answers
            const displayEarnedPoints = earnedPoints !== null ? earnedPoints : (correct * 5);
            const displayTotalPoints = totalPoints !== null ? totalPoints : (total * 5);
            
            resultContent.innerHTML = `
                <div class="text-center">
                    <div class="mb-4">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center ${passed ? 'bg-gradient-to-br from-green-400 to-green-600' : 'bg-gradient-to-br from-orange-400 to-red-500'} shadow-lg">
                            <i class="fas ${passed ? 'fa-trophy' : 'fa-exclamation-triangle'} text-3xl text-white"></i>
                        </div>
                        <h3 class="text-xl font-bold ${passed ? 'text-green-600' : 'text-orange-600'} mb-2">
                            ${passed ? 'üéâ Tebrikler!' : '‚ö†Ô∏è Test Tamamlandƒ±'}
                        </h3>
                        <div class="text-3xl font-bold ${passed ? 'text-green-700' : 'text-red-600'} mb-2">
                            ${score}%
                        </div>
                        <p class="text-sm text-gray-600 mb-1">
                            ${passed ? 'Ba≈üarƒ± puanƒ±na ula≈ütƒ±nƒ±z!' : 'Ba≈üarƒ± puanƒ±na ula≈üamadƒ±nƒ±z.'}
                        </p>
                        <p class="text-xs text-gray-500">
                            S√ºre: ${minutes}dk ${seconds}sn
                        </p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border border-blue-100">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-2xl font-bold ${score >= 90 ? 'text-green-600' : score >= 70 ? 'text-blue-600' : 'text-red-600'}">${score}%</div>
                                <div class="text-xs text-gray-600 font-medium">Ba≈üarƒ± Oranƒ±</div>
                                <div class="text-xs text-gray-500">
                                    ${score >= 90 ? 'üåü' : score >= 70 ? '‚úÖ' : '‚ùå'}
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-2xl font-bold text-purple-600">${displayEarnedPoints}</div>
                                <div class="text-xs text-gray-600 font-medium">Kazanƒ±lan Puan</div>
                                <div class="text-xs text-gray-500">
                                    /${displayTotalPoints} puan
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-2xl font-bold text-green-600">${correct}</div>
                                <div class="text-xs text-gray-600 font-medium">Doƒüru Cevap</div>
                                <div class="text-xs text-gray-500">
                                    /${total} soru
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                <div class="text-2xl font-bold text-red-600">${total - correct}</div>
                                <div class="text-xs text-gray-600 font-medium">Yanlƒ±≈ü Cevap</div>
                                <div class="text-xs text-gray-500">
                                    ${total - correct === 0 ? 'üéØ M√ºkemmel!' : 'üìö √áalƒ±≈ü'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Question Breakdown -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-list-check text-blue-600 mr-2"></i>
                            Soru Bazƒ±nda Detay
                        </h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${currentTest.questions.map((question, index) => {
                                const userAnswer = currentTest.answers[index];
                                const questionPoints = question.points || 5;
                                let isCorrect = false;
                                
                                if (question.type === 'multiple_choice') {
                                    isCorrect = parseInt(userAnswer) === question.correct;
                                } else if (question.type === 'fill_blank') {
                                    if (typeof userAnswer === 'string') {
                                        isCorrect = userAnswer.toLowerCase().trim() === question.correct.toLowerCase().trim();
                                    }
                                } else if (question.type === 'true_false') {
                                    isCorrect = (userAnswer === 'true') === question.correct;
                                }
                                
                                return `
                                    <div class="flex justify-between items-center py-2 px-3 rounded ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm font-medium ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                                ${isCorrect ? '‚úÖ' : '‚ùå'} Soru ${index + 1}
                                            </span>
                                            <span class="text-xs text-gray-600">
                                                (${question.type === 'multiple_choice' ? '√áoktan Se√ßmeli' : 
                                                   question.type === 'fill_blank' ? 'Bo≈üluk Doldurma' : 'Doƒüru/Yanlƒ±≈ü'})
                                            </span>
                                        </div>
                                        <div class="text-sm font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                            ${isCorrect ? questionPoints : 0}/${questionPoints} puan
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    ${!passed ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                <h4 class="text-sm font-semibold text-red-800">√ñnemli Uyarƒ±</h4>
                            </div>
                            <p class="text-red-800 text-sm font-medium mb-1">
                                √ñƒüretmeninizin tekrar atamasƒ±nƒ± bekleyin.
                            </p>
                            <p class="text-red-700 text-xs">
                                Tekrar √ß√∂zebilmek i√ßin √∂ƒüretmeninizin yeniden atama yapmasƒ± gerekir.
                            </p>
                        </div>
                    ` : `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-star text-green-600 mr-2"></i>
                                <h4 class="text-sm font-semibold text-green-800">Harika ƒ∞≈ü!</h4>
                            </div>
                            <p class="text-green-800 text-sm">
                                Ba≈üarƒ±yla ge√ßtiniz! Yeni rozetler kazanmƒ±≈ü olabilirsiniz.
                            </p>
                        </div>
                    `}
                    
                    <div class="text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        8 saniye sonra otomatik kapanacak...
                    </div>
                </div>
            `;
            
            document.getElementById('testResultModal').classList.remove('hidden');
            
            // Return to dashboard after showing result
            setTimeout(() => {
                closeModal('testResultModal');
                showStudentDashboard();
            }, 8000);
        }

        // Load teacher data
        async function loadTeacherData() {
            try {
                // Load statistics
                const { data: students } = await supabase.from('students').select('*');
                const { data: tests } = await supabase.from('tests').select('*');
                const { data: results } = await supabase.from('test_results').select('*');
                
                document.getElementById('totalStudents').textContent = students?.length || 0;
                document.getElementById('activeTests').textContent = tests?.length || 0;
                
                const avgSuccess = results?.length > 0 
                    ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length)
                    : 0;
                document.getElementById('averageSuccess').textContent = `${avgSuccess}%`;
                
                await loadTestsList();
                await loadStudentsList();
                await loadResultsList();
                
            } catch (error) {
                console.error('Error loading teacher data:', error);
            }
        }

        // Tab functions
        function showTab(tabName) {
            // Student tabs
            const tabs = ['tests', 'badges', 'leaderboard'];
            tabs.forEach(tab => {
                const tabButton = document.getElementById(`${tab}Tab`);
                const tabContent = document.getElementById(`${tab}Content`);
                
                if (tab === tabName) {
                    tabButton.classList.add('border-blue-500', 'text-blue-600');
                    tabButton.classList.remove('border-transparent', 'text-gray-500');
                    tabContent.classList.remove('hidden');
                } else {
                    tabButton.classList.remove('border-blue-500', 'text-blue-600');
                    tabButton.classList.add('border-transparent', 'text-gray-500');
                    tabContent.classList.add('hidden');
                }
            });
        }

        function showTeacherTab(tabName) {
            // Teacher tabs
            const tabs = ['dashboard', 'tests', 'students', 'results', 'library', 'failedTests'];
            tabs.forEach(tab => {
                const tabButtonId = tab === 'dashboard' ? 'dashboardTab' : 
                                  tab === 'tests' ? 'testsManageTab' :
                                  tab === 'students' ? 'studentsManageTab' : 
                                  tab === 'results' ? 'resultsTab' : 
                                  tab === 'library' ? 'libraryTab' : 'failedTestsTab';
                const tabContentId = tab === 'dashboard' ? 'dashboardContent' : 
                                   tab === 'tests' ? 'testsManageContent' :
                                   tab === 'students' ? 'studentsManageContent' : 
                                   tab === 'results' ? 'resultsContent' : 
                                   tab === 'library' ? 'libraryContent' : 'failedTestsContent';
                
                const tabButton = document.getElementById(tabButtonId);
                const tabContent = document.getElementById(tabContentId);
                
                // Check if elements exist before manipulating them
                if (tabButton && tabContent) {
                    if (tab === tabName) {
                        tabButton.classList.add('border-green-500', 'text-green-600');
                        tabButton.classList.remove('border-transparent', 'text-gray-500');
                        tabContent.classList.remove('hidden');
                    } else {
                        tabButton.classList.remove('border-green-500', 'text-green-600');
                        tabButton.classList.add('border-transparent', 'text-gray-500');
                        tabContent.classList.add('hidden');
                    }
                }
            });

            // Load library data if library tab is selected
            if (tabName === 'library') {
                loadLibraryStudents();
            }
            
            // Load failed tests data if failedTests tab is selected
            if (tabName === 'failedTests') {
                loadFailedTestsList();
            }
        }

        // Load tests list for teacher
        async function loadTestsList() {
            try {
                console.log('Loading tests list...');
                
                const { data: tests, error } = await supabase
                    .from('tests')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!tests || tests.length === 0) {
                    allTestsData = [];
                    displayFilteredTests([]);
                    return;
                }

                console.log('Tests loaded:', tests.length);

                // Get assignment counts for each test and store in allTestsData
                allTestsData = [];
                for (const test of tests) {
                    console.log(`Processing test: ${test.title} (ID: ${test.id})`);
                    
                    // Get assignments for this test
                    const { data: assignments, error: assignmentsError } = await supabase
                        .from('test_assignments')
                        .select('*')
                        .eq('test_id', test.id);

                    if (assignmentsError) {
                        console.error('Error loading assignments for test', test.id, assignmentsError);
                        continue;
                    }

                    console.log(`Assignments for test ${test.id}:`, assignments?.length || 0);

                    // Get test results for this test
                    const { data: results, error: resultsError } = await supabase
                        .from('test_results')
                        .select('*')
                        .eq('test_id', test.id);

                    if (resultsError) {
                        console.error('Error loading results for test', test.id, resultsError);
                    }

                    console.log(`Results for test ${test.id}:`, results?.length || 0);

                    const totalAssignments = assignments?.length || 0;
                    const completedAssignments = results?.length || 0;
                    const successfulAssignments = results?.filter(r => r.score >= 70).length || 0;

                    console.log(`Test ${test.id} stats:`, {
                        totalAssignments,
                        completedAssignments,
                        successfulAssignments
                    });

                    allTestsData.push({
                        ...test,
                        totalAssignments,
                        completedAssignments,
                        successfulAssignments
                    });
                }

                console.log('All tests data prepared:', allTestsData.length);

                // Apply current filters
                filterTests();

            } catch (error) {
                console.error('Error loading tests:', error);
                const container = document.getElementById('testsList');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                        <p class="text-red-600">Testler y√ºklenirken hata olu≈ütu.</p>
                        <button onclick="loadTestsList()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }

        // Display filtered tests
        function displayFilteredTests(filteredTests) {
            const container = document.getElementById('testsList');
            container.innerHTML = '';

            if (filteredTests.length === 0) {
                const message = currentTestSearch || currentTestFilter !== 'all' 
                    ? 'Arama kriterlerinize uygun test bulunamadƒ±.' 
                    : 'Hen√ºz test bulunmuyor.';
                container.innerHTML = `<p class="text-gray-500 text-center py-8">${message}</p>`;
                return;
            }

            filteredTests.forEach(test => {
                const testCard = document.createElement('div');
                testCard.className = 'bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200';
                testCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <h4 class="font-semibold text-gray-900 text-lg">${test.title}</h4>
                            </div>
                            <p class="text-gray-600 text-sm mb-3">${test.description || ''}</p>
                            
                            <!-- Test Statistics -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                                <div class="bg-gray-50 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-gray-800">${test.time_limit}</div>
                                    <div class="text-xs text-gray-600">Dakika</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-blue-800">${test.totalAssignments}</div>
                                    <div class="text-xs text-blue-600">Atanmƒ±≈ü</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-yellow-800">${test.completedAssignments}</div>
                                    <div class="text-xs text-yellow-600">Tamamlanmƒ±≈ü</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-2 text-center">
                                    <div class="text-lg font-bold text-green-800">${test.successfulAssignments}</div>
                                    <div class="text-xs text-green-600">Ba≈üarƒ±lƒ±</div>
                                </div>
                            </div>
                            
                            <div class="text-xs text-gray-500">
                                <i class="fas fa-calendar mr-1"></i>
                                Olu≈üturulma: ${new Date(test.created_at).toLocaleDateString('tr-TR')}
                            </div>
                        </div>
                        
                        <div class="ml-6 flex flex-col space-y-2">
                            <button onclick="showAssignmentModal(${test.id}, '${test.title.replace(/'/g, "\\'")}', ${test.totalAssignments}, ${test.completedAssignments})" 
                                    class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition duration-200 flex items-center">
                                <i class="fas fa-clipboard-list mr-2"></i>
                                üîÑ Atamalar
                            </button>
                            <button onclick="showEditTestModal(${test.id})" 
                                    class="px-4 py-2 bg-orange-600 text-white text-sm rounded-lg hover:bg-orange-700 transition duration-200 flex items-center">
                                <i class="fas fa-edit mr-2"></i>
                                D√ºzenle
                            </button>
                            <button onclick="showJSONEditModal(${test.id})" 
                                    class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center">
                                <i class="fas fa-code mr-2"></i>
                                JSON D√ºzenle
                            </button>
                            <button onclick="showJSONEditModal(${test.id})" 
                                    class="px-4 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center">
                                <i class="fas fa-code mr-2"></i>
                                JSON D√ºzenle
                            </button>
                            <button onclick="deleteTest(${test.id})" 
                                    class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition duration-200 flex items-center">
                                <i class="fas fa-trash mr-2"></i>
                                Sil
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(testCard);
            });

            // Update filter info
            updateTestFilterInfo(filteredTests.length);
        }

        // Function to switch to student dashboard
        async function impersonateStudent(studentId, studentName) {
            if (!confirm(`√ñƒüretmen olarak "${studentName}" adlƒ± √∂ƒürencinin aray√ºz√ºne ge√ßmek istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                // Get student data
                const { data: student, error } = await supabase
                    .from('students')
                    .select('*')
                    .eq('id', studentId)
                    .single();

                if (error) throw error;

                // Set global state for impersonation
                impersonatedStudent = student;
                
                // Save original user before switching
                window.originalUser = currentUser;
                currentUser = student; // Temporarily set current user to student

                // Show student dashboard
                showStudentDashboard();
                showNotification(`‚úÖ √ñƒürenci aray√ºz√ºne ge√ßildi: ${studentName}`, 'success');

            } catch (error) {
                console.error('Error impersonating student:', error);
                showNotification('√ñƒürenci aray√ºz√ºne ge√ßilirken hata olu≈ütu: ' + error.message, 'error');
                currentUser = window.originalUser; // Revert on error
            }
        }

        // Function to exit student impersonation
        function exitImpersonation() {
            if (window.originalUser) {
                currentUser = window.originalUser;
                impersonatedStudent = null;
                window.originalUser = null;
                showTeacherDashboard();
                showNotification('‚úÖ √ñƒüretmen paneline geri d√∂n√ºld√º.', 'success');
            }
        }

        // Load students list for teacher
        async function loadStudentsList() {
            try {
                const { data: students, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (error) throw error;

                const container = document.getElementById('studentsList');
                container.innerHTML = '';

                if (!students || students.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Hen√ºz √∂ƒürenci bulunmuyor.</p>';
                    return;
                }

                students.forEach(student => {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'bg-white border border-gray-200 rounded-lg p-4 cursor-pointer hover:shadow-lg transition duration-200';
                    studentCard.setAttribute('onclick', `impersonateStudent('${student.id}', '${student.name.replace(/'/g, "\\'")}')`);
                    studentCard.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-semibold text-gray-900">${student.name} <i class="fas fa-external-link-alt text-xs text-blue-500 ml-2"></i></h4>
                                <p class="text-gray-600 text-sm">√ñƒürenci No: ${student.student_no}</p>
                                <p class="text-gray-600 text-sm">Sƒ±nƒ±f: ${student.class}</p>
                                <p class="text-gray-600 text-sm">TC: ${student.tc_no}</p>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); editStudent(${student.id}, '${student.name.replace(/'/g, "\\'")}', '${student.tc_no}', '${student.student_no}', '${student.class}')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-edit mr-1"></i>D√ºzenle
                                </button>
                                <button onclick="event.stopPropagation(); deleteStudent(${student.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-trash mr-1"></i>Sil
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(studentCard);
                });

            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        // Load results list for teacher with comprehensive student-based data
        async function loadResultsList() {
            try {
                console.log('Loading results list...');
                
                // Load all students first
                console.log('Fetching students...');
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (studentsError) {
                    console.error('Students error:', studentsError);
                    throw studentsError;
                }
                console.log('Students loaded:', students?.length || 0);

                // Load all test results - simplified query first
                console.log('Fetching test results...');
                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*')
                    .order('completed_at', { ascending: false });

                if (resultsError) {
                    console.error('Results error:', resultsError);
                    throw resultsError;
                }
                console.log('Test results loaded:', results?.length || 0);

                // Load tests separately to avoid join issues
                console.log('Fetching tests...');
                const { data: allTests, error: testsError } = await supabase
                    .from('tests')
                    .select('*');

                if (testsError) {
                    console.error('Tests error:', testsError);
                    throw testsError;
                }
                console.log('Tests loaded:', allTests?.length || 0);

                // Load all test assignments to get assignment dates
                console.log('Fetching assignments...');
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('test_assignments')
                    .select('*');

                if (assignmentsError) {
                    console.error('Assignments error:', assignmentsError);
                    throw assignmentsError;
                }
                console.log('Assignments loaded:', assignments?.length || 0);

                const container = document.getElementById('resultsList');
                container.innerHTML = '';

                if (!students || students.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">Hen√ºz √∂ƒürenci bulunmuyor.</p>
                            <p class="text-gray-400 text-sm mt-2">√ñnce √∂ƒürenci ekleyin, sonra testler atayƒ±n.</p>
                        </div>
                    `;
                    return;
                }

                // Calculate comprehensive statistics
                const totalResults = results?.length || 0;
                const passedResults = results?.filter(r => r.score >= 70).length || 0;
                const excellentResults = results?.filter(r => r.score >= 90).length || 0;
                const perfectResults = results?.filter(r => r.score === 100).length || 0;
                const averageScore = totalResults > 0 ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / totalResults) : 0;
                const highestScore = totalResults > 0 ? Math.max(...results.map(r => r.score)) : 0;
                const lowestScore = totalResults > 0 ? Math.min(...results.map(r => r.score)) : 0;

                // Create test lookup map
                const testLookup = {};
                allTests?.forEach(test => {
                    testLookup[test.id] = test;
                });
                console.log('Test lookup created:', Object.keys(testLookup).length);

                // Enrich results with test information
                const enrichedResults = results?.map(result => ({
                    ...result,
                    test: testLookup[result.test_id] || { title: 'Unknown Test', time_limit: 30 }
                })) || [];
                console.log('Enriched results:', enrichedResults.length);

                // Group results by student for comprehensive student-based view
                const studentResults = {};
                students.forEach(student => {
                    const studentTestResults = enrichedResults.filter(r => r.student_id === student.id) || [];
                    const studentAssignments = assignments?.filter(a => a.student_id === student.id) || [];
                    
                    console.log(`Student ${student.name}: ${studentTestResults.length} results, ${studentAssignments.length} assignments`);
                    
                    // Calculate detailed performance metrics
                    const scores = studentTestResults.map(r => r.score);
                    const averageScore = scores.length > 0 ? Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length) : 0;
                    const highestScore = scores.length > 0 ? Math.max(...scores) : 0;
                    const lowestScore = scores.length > 0 ? Math.min(...scores) : 0;
                    const passedTests = studentTestResults.filter(r => r.score >= 70).length;
                    const excellentTests = studentTestResults.filter(r => r.score >= 90).length;
                    const perfectScores = studentTestResults.filter(r => r.score === 100).length;
                    const failedTests = studentTestResults.filter(r => r.score < 70).length;
                    
                    // Calculate improvement trend (last 3 tests vs first 3 tests)
                    let improvementTrend = 'stable';
                    if (scores.length >= 3) {
                        const recentScores = scores.slice(0, 3);
                        const oldScores = scores.slice(-3);
                        const recentAvg = recentScores.reduce((sum, score) => sum + score, 0) / recentScores.length;
                        const oldAvg = oldScores.reduce((sum, score) => sum + score, 0) / oldScores.length;
                        
                        if (recentAvg > oldAvg + 5) improvementTrend = 'improving';
                        else if (recentAvg < oldAvg - 5) improvementTrend = 'declining';
                    }
                    
                    // Calculate consistency (standard deviation)
                    let consistency = 'stable';
                    if (scores.length >= 3) {
                        const mean = averageScore;
                        const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
                        const stdDev = Math.sqrt(variance);
                        
                        if (stdDev < 10) consistency = 'very_consistent';
                        else if (stdDev < 20) consistency = 'consistent';
                        else if (stdDev < 30) consistency = 'moderate';
                        else consistency = 'inconsistent';
                    }
                    
                    // Calculate time-based performance
                    const lastWeekResults = studentTestResults.filter(r => {
                        const testDate = new Date(r.completed_at);
                        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        return testDate >= weekAgo;
                    });
                    
                    const lastMonthResults = studentTestResults.filter(r => {
                        const testDate = new Date(r.completed_at);
                        const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                        return testDate >= monthAgo;
                    });
                    
                    studentResults[student.id] = {
                        student: student,
                        results: studentTestResults,
                        assignments: studentAssignments,
                        
                        // Basic metrics
                        totalTests: studentTestResults.length,
                        totalAssignments: studentAssignments.length,
                        pendingTests: studentAssignments.length - studentTestResults.length,
                        
                        // Score metrics
                        averageScore: averageScore,
                        highestScore: highestScore,
                        lowestScore: lowestScore,
                        
                        // Performance categories
                        passedTests: passedTests,
                        failedTests: failedTests,
                        excellentTests: excellentTests,
                        perfectScores: perfectScores,
                        
                        // Success rates
                        passRate: studentTestResults.length > 0 ? Math.round((passedTests / studentTestResults.length) * 100) : 0,
                        excellenceRate: studentTestResults.length > 0 ? Math.round((excellentTests / studentTestResults.length) * 100) : 0,
                        
                        // Trends and patterns
                        improvementTrend: improvementTrend,
                        consistency: consistency,
                        
                        // Time-based performance
                        lastWeekTests: lastWeekResults.length,
                        lastMonthTests: lastMonthResults.length,
                        lastWeekAverage: lastWeekResults.length > 0 ? 
                            Math.round(lastWeekResults.reduce((sum, r) => sum + r.score, 0) / lastWeekResults.length) : 0,
                        lastMonthAverage: lastMonthResults.length > 0 ? 
                            Math.round(lastMonthResults.reduce((sum, r) => sum + r.score, 0) / lastMonthResults.length) : 0,
                        
                        // Activity metrics
                        firstTestDate: studentTestResults.length > 0 ? 
                            new Date(Math.min(...studentTestResults.map(r => new Date(r.completed_at)))).toLocaleDateString('tr-TR') : null,
                        lastTestDate: studentTestResults.length > 0 ? 
                            new Date(Math.max(...studentTestResults.map(r => new Date(r.completed_at)))).toLocaleDateString('tr-TR') : null,
                        
                        // Detailed test breakdown by difficulty/type
                        testsByScore: {
                            perfect: perfectScores,
                            excellent: excellentTests - perfectScores,
                            good: passedTests - excellentTests,
                            needsWork: failedTests
                        }
                    };
                });

                // Enhanced statistics header
                const activeStudents = Object.values(studentResults).filter(s => s.totalTests > 0).length;
                const totalAssignments = Object.values(studentResults).reduce((sum, s) => sum + s.totalAssignments, 0);
                const pendingAssignments = Object.values(studentResults).reduce((sum, s) => sum + s.pendingTests, 0);
                const improvingStudents = Object.values(studentResults).filter(s => s.improvementTrend === 'improving').length;
                const consistentStudents = Object.values(studentResults).filter(s => s.consistency === 'very_consistent' || s.consistency === 'consistent').length;
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'mb-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100';
                statsDiv.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-chart-line text-blue-600 mr-3"></i>
                        Sƒ±nƒ±f Performans √ñzeti
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-blue-600">${students.length}</div>
                            <div class="text-sm text-gray-600 font-medium">Toplam √ñƒürenci</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-green-600">${activeStudents}</div>
                            <div class="text-sm text-gray-600 font-medium">Aktif √ñƒürenci</div>
                            <div class="text-xs text-gray-500 mt-1">Test √ß√∂zen</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-purple-600">${totalResults}</div>
                            <div class="text-sm text-gray-600 font-medium">Toplam Test</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-yellow-600">${passedResults}</div>
                            <div class="text-sm text-gray-600 font-medium">Ba≈üarƒ±lƒ± (‚â•70)</div>
                            <div class="text-xs text-gray-500 mt-1">${totalResults > 0 ? Math.round((passedResults/totalResults)*100) : 0}%</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-indigo-600">${averageScore}</div>
                            <div class="text-sm text-gray-600 font-medium">Sƒ±nƒ±f Ortalamasƒ±</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-orange-600">${pendingAssignments}</div>
                            <div class="text-sm text-gray-600 font-medium">Bekleyen Test</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-emerald-600">${improvingStudents}</div>
                            <div class="text-sm text-gray-600 font-medium">Geli≈üen √ñƒürenci</div>
                            <div class="text-xs text-gray-500 mt-1">üìà Trend</div>
                        </div>
                        <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                            <div class="text-2xl font-bold text-teal-600">${consistentStudents}</div>
                            <div class="text-sm text-gray-600 font-medium">Tutarlƒ± √ñƒürenci</div>
                            <div class="text-xs text-gray-500 mt-1">üéØ Kararlƒ±</div>
                        </div>
                    </div>
                    
                    <!-- Performance Distribution -->
                    <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-chart-pie text-indigo-600 mr-2"></i>
                            Performans Daƒüƒ±lƒ±mƒ±
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-purple-600">${perfectResults}</div>
                                <div class="text-sm text-gray-600">M√ºkemmel (100)</div>
                                <div class="text-xs text-purple-600">üèÜ Tam Puan</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600">${excellentResults}</div>
                                <div class="text-sm text-gray-600">Harika (90-99)</div>
                                <div class="text-xs text-green-600">‚≠ê M√ºkemmel</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600">${passedResults - excellentResults}</div>
                                <div class="text-sm text-gray-600">ƒ∞yi (70-89)</div>
                                <div class="text-xs text-blue-600">üëç Ba≈üarƒ±lƒ±</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-red-600">${totalResults - passedResults}</div>
                                <div class="text-sm text-gray-600">Geli≈ümeli (<70)</div>
                                <div class="text-xs text-red-600">üìö √áalƒ±≈ümalƒ±</div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(statsDiv);

                // Enhanced filter and search controls
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'mb-6 p-4 bg-gray-50 border border-gray-200 rounded-lg';
                controlsDiv.innerHTML = `
                    <div class="space-y-4">
                        <!-- Search Bar -->
                        <div class="flex items-center space-x-4">
                            <div class="flex-1 relative">
                                <input type="text" id="resultsSearchInput" placeholder="√ñƒürenci adƒ±, sƒ±nƒ±f, √∂ƒürenci no ile ara..." 
                                       class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                       onkeyup="filterStudentResults()">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                            <button onclick="exportStudentResults()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">
                                <i class="fas fa-file-excel mr-2"></i>Excel ƒ∞ndir
                            </button>
                            <button onclick="exportStudentResultsPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200">
                                <i class="fas fa-file-pdf mr-2"></i>PDF ƒ∞ndir
                            </button>
                        </div>
                        
                        <!-- Filter Options -->
                        <div class="flex flex-wrap gap-2">
                            <select id="resultsFilterSelect" onchange="filterStudentResults()" 
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">üéØ T√ºm √ñƒürenciler</option>
                                <option value="active">‚úÖ Test √á√∂zenler</option>
                                <option value="inactive">‚è≥ Test √á√∂zmeyenler</option>
                                <option value="high_performers">üåü Y√ºksek Performans (‚â•85)</option>
                                <option value="excellent_performers">üèÜ M√ºkemmel Performans (‚â•90)</option>
                                <option value="low_performers">üìö Geli≈ümeli (<70)</option>
                                <option value="improving">üìà Geli≈üen √ñƒürenciler</option>
                                <option value="declining">üìâ D√º≈üen Performans</option>
                                <option value="consistent">üéØ Tutarlƒ± √ñƒürenciler</option>
                                <option value="inconsistent">üîÑ Deƒüi≈üken Performans</option>
                                <option value="pending">‚è∞ Bekleyen Testi Olanlar</option>
                                <option value="recent_active">üî• Son Hafta Aktif</option>
                            </select>
                            
                            <select id="resultsSortSelect" onchange="filterStudentResults()" 
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="name_asc">üìù ƒ∞sim (A-Z)</option>
                                <option value="name_desc">üìù ƒ∞sim (Z-A)</option>
                                <option value="average_desc">üìä En Y√ºksek Ortalama</option>
                                <option value="average_asc">üìä En D√º≈ü√ºk Ortalama</option>
                                <option value="test_count_desc">üìà En √áok Test</option>
                                <option value="test_count_asc">üìâ En Az Test</option>
                                <option value="recent_activity">üïí Son Aktivite</option>
                                <option value="improvement_desc">üìà En √áok Geli≈üen</option>
                                <option value="consistency_desc">üéØ En Tutarlƒ±</option>
                            </select>
                            
                            <select id="resultsClassFilter" onchange="filterStudentResults()" 
                                    class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="all">üè´ T√ºm Sƒ±nƒ±flar</option>
                                ${[...new Set(students.map(s => s.class))].sort().map(className => 
                                    `<option value="${className}">üìö ${className}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <!-- Quick Stats -->
                        <div id="filterResultsInfo" class="text-sm text-gray-600 flex justify-between items-center">
                            <span>T√ºm √∂ƒürenciler g√∂steriliyor</span>
                            <button onclick="clearStudentFilters()" class="text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-times mr-1"></i>Filtreleri Temizle
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(controlsDiv);

                // Results container
                const resultsContainer = document.createElement('div');
                resultsContainer.id = 'filteredStudentResultsContainer';
                container.appendChild(resultsContainer);

                // Store all student results for filtering
                window.allStudentResultsData = Object.values(studentResults);
                console.log('Final student results data:', window.allStudentResultsData.length);
                
                // Debug: Log first student's data
                if (window.allStudentResultsData.length > 0) {
                    console.log('Sample student data:', window.allStudentResultsData[0]);
                }
                
                // Display all student results initially
                displayFilteredStudentResults(Object.values(studentResults));

            } catch (error) {
                console.error('Error loading results:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details
                });
                
                const container = document.getElementById('resultsList');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                        <p class="text-red-600 mb-3">Sonu√ßlar y√ºklenirken hata olu≈ütu.</p>
                        <p class="text-sm text-gray-600 mb-4">${error.message || 'Bilinmeyen hata'}</p>
                        <div class="space-y-2">
                            <button onclick="loadResultsList()" class="block mx-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-sync mr-2"></i>Tekrar Dene
                            </button>
                            <button onclick="showSimpleResults()" class="block mx-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-list mr-2"></i>Basit G√∂r√ºn√ºm
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Display comprehensive filtered student results
        function displayFilteredStudentResults(studentResults) {
            const container = document.getElementById('filteredStudentResultsContainer');
            if (!container) return;
            
            container.innerHTML = '';

            if (studentResults.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-search text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-lg">Arama kriterlerinize uygun √∂ƒürenci bulunamadƒ±.</p>
                        <p class="text-gray-400 text-sm mt-2">Farklƒ± filtreler deneyebilir veya arama terimini deƒüi≈ütirebilirsiniz.</p>
                    </div>
                `;
                return;
            }

            studentResults.forEach((studentData, index) => {
                const student = studentData.student;
                const results = studentData.results;
                
                // Determine performance level and styling
                let performanceLevel, performanceColor, performanceIcon, rankIcon, trendIcon, consistencyIcon;
                
                if (studentData.averageScore >= 95) {
                    performanceLevel = 'M√ºkemmel';
                    performanceColor = 'from-purple-500 to-pink-500';
                    performanceIcon = 'üèÜ';
                    rankIcon = 'üëë';
                } else if (studentData.averageScore >= 85) {
                    performanceLevel = '√áok ƒ∞yi';
                    performanceColor = 'from-green-500 to-emerald-500';
                    performanceIcon = '‚≠ê';
                    rankIcon = 'üåü';
                } else if (studentData.averageScore >= 70) {
                    performanceLevel = 'ƒ∞yi';
                    performanceColor = 'from-blue-500 to-cyan-500';
                    performanceIcon = 'üëç';
                    rankIcon = '‚úÖ';
                } else if (studentData.totalTests > 0) {
                    performanceLevel = 'Geli≈ümeli';
                    performanceColor = 'from-orange-500 to-red-500';
                    performanceIcon = 'üìö';
                    rankIcon = 'üìñ';
                } else {
                    performanceLevel = 'Hen√ºz Test Yok';
                    performanceColor = 'from-gray-400 to-gray-500';
                    performanceIcon = '‚è≥';
                    rankIcon = '‚ö™';
                }

                // Trend and consistency icons
                switch (studentData.improvementTrend) {
                    case 'improving': trendIcon = 'üìà'; break;
                    case 'declining': trendIcon = 'üìâ'; break;
                    default: trendIcon = '‚û°Ô∏è'; break;
                }

                switch (studentData.consistency) {
                    case 'very_consistent': consistencyIcon = 'üéØ'; break;
                    case 'consistent': consistencyIcon = 'üîµ'; break;
                    case 'moderate': consistencyIcon = 'üü°'; break;
                    case 'inconsistent': consistencyIcon = 'üîÑ'; break;
                    default: consistencyIcon = '‚ö™'; break;
                }

                const studentDiv = document.createElement('div');
                studentDiv.className = 'mb-8 bg-white border-2 border-gray-200 rounded-2xl overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1';
                
                studentDiv.innerHTML = `
                    <!-- Enhanced Student Header -->
                    <div class="bg-gradient-to-r ${performanceColor} p-6 text-white relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white bg-opacity-10 rounded-full -mr-16 -mt-16"></div>
                        <div class="absolute bottom-0 left-0 w-24 h-24 bg-white bg-opacity-10 rounded-full -ml-12 -mb-12"></div>
                        
                        <div class="relative z-10">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center space-x-4">
                                    <div class="text-5xl">${rankIcon}</div>
                                    <div>
                                        <h4 class="text-2xl font-bold">${student.name}</h4>
                                        <div class="flex items-center space-x-4 mt-2 text-sm opacity-90">
                                            <span class="bg-white bg-opacity-20 px-2 py-1 rounded">No: ${student.student_no}</span>
                                            <span class="bg-white bg-opacity-20 px-2 py-1 rounded">Sƒ±nƒ±f: ${student.class}</span>
                                            <span class="bg-white bg-opacity-30 px-3 py-1 rounded-full font-medium">
                                                ${performanceIcon} ${performanceLevel}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Main Score Display -->
                                <div class="text-right">
                                    <div class="text-5xl font-bold mb-1">${studentData.averageScore || 0}</div>
                                    <div class="text-sm opacity-90 font-medium">Ortalama Puan</div>
                                    <div class="flex items-center justify-end space-x-2 mt-2">
                                        <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">${trendIcon} Trend</span>
                                        <span class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded">${consistencyIcon} Tutarlƒ±lƒ±k</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Quick Performance Indicators -->
                            <div class="flex items-center space-x-6 text-sm">
                                <div class="flex items-center space-x-1">
                                    <span class="text-lg">üéØ</span>
                                    <span>Ba≈üarƒ±: %${studentData.passRate}</span>
                                </div>
                                <div class="flex items-center space-x-1">
                                    <span class="text-lg">‚≠ê</span>
                                    <span>M√ºkemmellik: %${studentData.excellenceRate}</span>
                                </div>
                                ${studentData.lastWeekTests > 0 ? `
                                    <div class="flex items-center space-x-1">
                                        <span class="text-lg">üî•</span>
                                        <span>Bu hafta: ${studentData.lastWeekTests} test</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Comprehensive Statistics Grid -->
                    <div class="p-6 bg-gradient-to-br from-gray-50 to-blue-50">
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-4">
                            <!-- Basic Stats -->
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-blue-100">
                                <div class="text-2xl font-bold text-blue-600">${studentData.totalTests}</div>
                                <div class="text-xs text-gray-600 font-medium">√á√∂z√ºlen Test</div>
                                <div class="text-xs text-blue-500 mt-1">üìä Toplam</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-green-100">
                                <div class="text-2xl font-bold text-green-600">${studentData.passedTests}</div>
                                <div class="text-xs text-gray-600 font-medium">Ba≈üarƒ±lƒ± (‚â•70)</div>
                                <div class="text-xs text-green-500 mt-1">‚úÖ %${studentData.passRate}</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-purple-100">
                                <div class="text-2xl font-bold text-purple-600">${studentData.perfectScores}</div>
                                <div class="text-xs text-gray-600 font-medium">Tam Puan</div>
                                <div class="text-xs text-purple-500 mt-1">üèÜ 100 Puan</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-yellow-100">
                                <div class="text-2xl font-bold text-yellow-600">${studentData.excellentTests}</div>
                                <div class="text-xs text-gray-600 font-medium">M√ºkemmel (‚â•90)</div>
                                <div class="text-xs text-yellow-500 mt-1">‚≠ê Harika</div>
                            </div>
                            
                            <!-- Performance Range -->
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-emerald-100">
                                <div class="text-2xl font-bold text-emerald-600">${studentData.highestScore || 0}</div>
                                <div class="text-xs text-gray-600 font-medium">En Y√ºksek</div>
                                <div class="text-xs text-emerald-500 mt-1">üìà Zirve</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-red-100">
                                <div class="text-2xl font-bold text-red-600">${studentData.lowestScore || 0}</div>
                                <div class="text-xs text-gray-600 font-medium">En D√º≈ü√ºk</div>
                                <div class="text-xs text-red-500 mt-1">üìâ Minimum</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-orange-100">
                                <div class="text-2xl font-bold text-orange-600">${studentData.pendingTests}</div>
                                <div class="text-xs text-gray-600 font-medium">Bekleyen</div>
                                <div class="text-xs text-orange-500 mt-1">‚è∞ Atanmƒ±≈ü</div>
                            </div>
                            <div class="bg-white rounded-xl p-4 text-center shadow-sm border border-red-100">
                                <div class="text-2xl font-bold text-red-600">${studentData.failedTests}</div>
                                <div class="text-xs text-gray-600 font-medium">Geli≈ümeli (<70)</div>
                                <div class="text-xs text-red-500 mt-1">üìö √áalƒ±≈ümalƒ±</div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Analytics Section -->
                    ${studentData.totalTests > 0 ? `
                        <div class="p-6 bg-white border-t border-gray-100">
                            <h5 class="font-bold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-chart-line text-indigo-600 mr-2"></i>
                                Performans Analizi
                            </h5>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <!-- Trend Analysis -->
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100">
                                    <h6 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        ${trendIcon} Geli≈üim Trendi
                                    </h6>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Durum:</span>
                                            <span class="text-sm font-medium ${
                                                studentData.improvementTrend === 'improving' ? 'text-green-600' :
                                                studentData.improvementTrend === 'declining' ? 'text-red-600' : 'text-gray-600'
                                            }">
                                                ${studentData.improvementTrend === 'improving' ? 'Geli≈üiyor' :
                                                  studentData.improvementTrend === 'declining' ? 'D√º≈ü√ºyor' : 'Stabil'}
                                            </span>
                                        </div>
                                        ${studentData.lastWeekAverage > 0 ? `
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Bu hafta:</span>
                                                <span class="text-sm font-medium text-blue-600">${studentData.lastWeekAverage}</span>
                                            </div>
                                        ` : ''}
                                        ${studentData.lastMonthAverage > 0 ? `
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Bu ay:</span>
                                                <span class="text-sm font-medium text-indigo-600">${studentData.lastMonthAverage}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <!-- Consistency Analysis -->
                                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100">
                                    <h6 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        ${consistencyIcon} Tutarlƒ±lƒ±k
                                    </h6>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Seviye:</span>
                                            <span class="text-sm font-medium ${
                                                studentData.consistency === 'very_consistent' ? 'text-green-600' :
                                                studentData.consistency === 'consistent' ? 'text-blue-600' :
                                                studentData.consistency === 'moderate' ? 'text-yellow-600' : 'text-red-600'
                                            }">
                                                ${studentData.consistency === 'very_consistent' ? '√áok Tutarlƒ±' :
                                                  studentData.consistency === 'consistent' ? 'Tutarlƒ±' :
                                                  studentData.consistency === 'moderate' ? 'Orta' : 'Deƒüi≈üken'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Ba≈üarƒ± oranƒ±:</span>
                                            <span class="text-sm font-medium text-green-600">%${studentData.passRate}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">M√ºkemmellik:</span>
                                            <span class="text-sm font-medium text-purple-600">%${studentData.excellenceRate}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Activity Timeline -->
                                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-100">
                                    <h6 class="font-semibold text-gray-800 mb-3 flex items-center">
                                        üìÖ Aktivite Zaman √áizelgesi
                                    </h6>
                                    <div class="space-y-2">
                                        ${studentData.firstTestDate ? `
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">ƒ∞lk test:</span>
                                                <span class="text-sm font-medium text-purple-600">${studentData.firstTestDate}</span>
                                            </div>
                                        ` : ''}
                                        ${studentData.lastTestDate ? `
                                            <div class="flex justify-between">
                                                <span class="text-sm text-gray-600">Son test:</span>
                                                <span class="text-sm font-medium text-pink-600">${studentData.lastTestDate}</span>
                                            </div>
                                        ` : ''}
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Bu hafta:</span>
                                            <span class="text-sm font-medium text-indigo-600">${studentData.lastWeekTests} test</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-sm text-gray-600">Bu ay:</span>
                                            <span class="text-sm font-medium text-blue-600">${studentData.lastMonthTests} test</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Test Results Details -->
                    ${results.length > 0 ? `
                        <div class="p-6 bg-gray-50 border-t border-gray-200">
                            <div class="flex justify-between items-center mb-4">
                                <h5 class="font-bold text-gray-900 flex items-center">
                                    <i class="fas fa-list-alt text-blue-600 mr-2"></i>
                                    Test Sonu√ßlarƒ± Detayƒ± (${results.length})
                                </h5>
                                <div class="flex space-x-2">
                                    <button onclick="exportStudentDetail(${student.id})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition duration-200">
                                        <i class="fas fa-download mr-1"></i>Excel
                                    </button>
                                    <button onclick="toggleStudentDetails(${student.id})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition duration-200">
                                        <i class="fas fa-eye mr-1"></i>Detaylarƒ± G√∂ster
                                    </button>
                                </div>
                            </div>
                            
                            <div id="studentDetails_${student.id}" class="hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${results.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at)).map((result, idx) => `
                                        <div class="bg-white border-2 ${
                                            result.score === 100 ? 'border-purple-200 bg-purple-50' :
                                            result.score >= 90 ? 'border-green-200 bg-green-50' :
                                            result.score >= 70 ? 'border-blue-200 bg-blue-50' : 'border-red-200 bg-red-50'
                                        } rounded-xl p-4 hover:shadow-md transition-all duration-200">
                                            <div class="flex justify-between items-start mb-3">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2 mb-2">
                                                        <span class="text-lg">
                                                            ${result.score === 100 ? 'üèÜ' :
                                                              result.score >= 90 ? '‚≠ê' :
                                                              result.score >= 70 ? '‚úÖ' : 'üìö'}
                                                        </span>
                                                        <h6 class="font-bold text-gray-900 text-sm">${result.test?.title || 'Unknown Test'}</h6>
                                                    </div>
                                                    <div class="space-y-1 text-xs text-gray-600">
                                                        <div class="flex items-center">
                                                            <i class="fas fa-calendar-alt mr-2 w-3"></i>
                                                            <span>${new Date(result.completed_at).toLocaleDateString('tr-TR', { 
                                                                weekday: 'short', 
                                                                year: 'numeric', 
                                                                month: 'short', 
                                                                day: 'numeric' 
                                                            })}</span>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <i class="fas fa-clock mr-2 w-3"></i>
                                                            <span>${result.test?.time_limit || 30} dakika s√ºre</span>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <i class="fas fa-hashtag mr-2 w-3"></i>
                                                            <span>${idx + 1}. test (kronolojik)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-3xl font-bold ${
                                                        result.score === 100 ? 'text-purple-600' :
                                                        result.score >= 90 ? 'text-green-600' :
                                                        result.score >= 70 ? 'text-blue-600' : 'text-red-600'
                                                    }">${result.score}</div>
                                                    <div class="text-xs font-medium ${
                                                        result.score === 100 ? 'text-purple-600' :
                                                        result.score >= 90 ? 'text-green-600' :
                                                        result.score >= 70 ? 'text-blue-600' : 'text-red-600'
                                                    }">
                                                        ${result.score === 100 ? 'M√ºkemmel' :
                                                          result.score >= 90 ? 'Harika' :
                                                          result.score >= 70 ? 'Ba≈üarƒ±lƒ±' : 'Geli≈ümeli'}
                                                    </div>
                                                    <div class="text-xs text-gray-500 mt-1">
                                                        ${(() => {
                                            try {
                                                if (result.test && result.test.questions) {
                                                    const questions = typeof result.test.questions === 'string' ? 
                                                        JSON.parse(result.test.questions) : result.test.questions;
                                                    const totalQuestions = Array.isArray(questions) ? questions.length : 7;
                                                    const correctAnswers = Math.round((result.score / 100) * totalQuestions);
                                                    return `${correctAnswers}/${totalQuestions} doƒüru`;
                                                } else {
                                                    return `${Math.round((result.score / 100) * 7)}/7 doƒüru`;
                                                }
                                            } catch (e) {
                                                return `${Math.round((result.score / 100) * 7)}/7 doƒüru`;
                                            }
                                        })()}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Performance indicator bar -->
                                            <div class="w-full bg-gray-200 rounded-full h-2 mt-3">
                                                <div class="h-2 rounded-full transition-all duration-300 ${
                                                    result.score === 100 ? 'bg-purple-500' :
                                                    result.score >= 90 ? 'bg-green-500' :
                                                    result.score >= 70 ? 'bg-blue-500' : 'bg-red-500'
                                                }" style="width: ${result.score}%"></div>
                                            </div>
                                            
                                            <!-- Action Buttons -->
                                            <div class="mt-3 flex gap-2">
                                                <button onclick="showDetailedResults(${result.id}, ${student.id}, '${student.name.replace(/'/g, "\\'")}', '${result.test?.title?.replace(/'/g, "\\'") || "Test"}')" 
                                                        class="flex-1 px-3 py-2 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                                                    <i class="fas fa-clipboard-check mr-2"></i>
                                                    Detaylƒ± Sonu√ßlar
                                                </button>
                                                <button onclick="deleteTestResult(${result.id}, '${student.name.replace(/'/g, "\\'")}', '${result.test?.title?.replace(/'/g, "\\'") || "Test"}')" 
                                                        class="px-3 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Test Summary Stats -->
                                <div class="mt-6 p-4 bg-white rounded-xl border border-gray-200">
                                    <h6 class="font-semibold text-gray-800 mb-3">üìä Test Performans √ñzeti</h6>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-purple-600">${studentData.testsByScore.perfect}</div>
                                            <div class="text-xs text-gray-600">M√ºkemmel (100)</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-green-600">${studentData.testsByScore.excellent}</div>
                                            <div class="text-xs text-gray-600">Harika (90-99)</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-blue-600">${studentData.testsByScore.good}</div>
                                            <div class="text-xs text-gray-600">ƒ∞yi (70-89)</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-red-600">${studentData.testsByScore.needsWork}</div>
                                            <div class="text-xs text-gray-600">Geli≈ümeli (<70)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="p-8 text-center bg-gray-50 border-t border-gray-200">
                            <div class="text-gray-400 mb-4">
                                <i class="fas fa-clipboard-list text-6xl"></i>
                            </div>
                            <h5 class="text-lg font-semibold text-gray-700 mb-2">Hen√ºz test sonucu bulunmuyor</h5>
                            <p class="text-gray-600 mb-4">
                                ${studentData.totalAssignments > 0 ? 
                                    `${studentData.totalAssignments} test atanmƒ±≈ü, hen√ºz √ß√∂z√ºlmemi≈ü` : 
                                    'Hen√ºz test atanmamƒ±≈ü'}
                            </p>
                            ${studentData.totalAssignments > 0 ? `
                                <div class="inline-flex items-center px-4 py-2 bg-yellow-100 text-yellow-800 rounded-lg">
                                    <i class="fas fa-hourglass-half mr-2"></i>
                                    <span class="font-medium">${studentData.pendingTests} test √ß√∂z√ºlmeyi bekliyor</span>
                                </div>
                            ` : `
                                <div class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-800 rounded-lg">
                                    <i class="fas fa-plus-circle mr-2"></i>
                                    <span class="font-medium">Test atayarak ba≈ülayabilirsiniz</span>
                                </div>
                            `}
                        </div>
                    `}
                `;
                
                container.appendChild(studentDiv);
            });

            // Update filter info
            updateStudentFilterInfo(studentResults.length);
        }

        // Toggle student details
        function toggleStudentDetails(studentId) {
            const detailsDiv = document.getElementById(`studentDetails_${studentId}`);
            const button = detailsDiv.previousElementSibling.querySelector('button');
            
            if (detailsDiv.classList.contains('hidden')) {
                detailsDiv.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Detaylarƒ± Gizle';
            } else {
                detailsDiv.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-eye mr-1"></i>Detaylarƒ± G√∂ster';
            }
        }

        // Enhanced filter student results function
        function filterStudentResults() {
            if (!window.allStudentResultsData) return;

            const searchTerm = document.getElementById('resultsSearchInput')?.value.toLowerCase().trim() || '';
            const filterType = document.getElementById('resultsFilterSelect')?.value || 'all';
            const sortType = document.getElementById('resultsSortSelect')?.value || 'name_asc';
            const classFilter = document.getElementById('resultsClassFilter')?.value || 'all';

            let filteredResults = [...window.allStudentResultsData];

            // Apply search filter
            if (searchTerm) {
                filteredResults = filteredResults.filter(studentData => 
                    studentData.student.name.toLowerCase().includes(searchTerm) ||
                    studentData.student.student_no.toLowerCase().includes(searchTerm) ||
                    studentData.student.class.toLowerCase().includes(searchTerm)
                );
            }

            // Apply class filter
            if (classFilter !== 'all') {
                filteredResults = filteredResults.filter(s => s.student.class === classFilter);
            }

            // Apply category filter
            switch (filterType) {
                case 'active':
                    filteredResults = filteredResults.filter(s => s.totalTests > 0);
                    break;
                case 'inactive':
                    filteredResults = filteredResults.filter(s => s.totalTests === 0);
                    break;
                case 'high_performers':
                    filteredResults = filteredResults.filter(s => s.averageScore >= 85);
                    break;
                case 'excellent_performers':
                    filteredResults = filteredResults.filter(s => s.averageScore >= 90);
                    break;
                case 'low_performers':
                    filteredResults = filteredResults.filter(s => s.totalTests > 0 && s.averageScore < 70);
                    break;
                case 'improving':
                    filteredResults = filteredResults.filter(s => s.improvementTrend === 'improving');
                    break;
                case 'declining':
                    filteredResults = filteredResults.filter(s => s.improvementTrend === 'declining');
                    break;
                case 'consistent':
                    filteredResults = filteredResults.filter(s => s.consistency === 'very_consistent' || s.consistency === 'consistent');
                    break;
                case 'inconsistent':
                    filteredResults = filteredResults.filter(s => s.consistency === 'inconsistent');
                    break;
                case 'pending':
                    filteredResults = filteredResults.filter(s => s.pendingTests > 0);
                    break;
                case 'recent_active':
                    filteredResults = filteredResults.filter(s => s.lastWeekTests > 0);
                    break;
            }

            // Apply sorting
            switch (sortType) {
                case 'name_desc':
                    filteredResults.sort((a, b) => b.student.name.localeCompare(a.student.name, 'tr'));
                    break;
                case 'average_desc':
                    filteredResults.sort((a, b) => b.averageScore - a.averageScore);
                    break;
                case 'average_asc':
                    filteredResults.sort((a, b) => a.averageScore - b.averageScore);
                    break;
                case 'test_count_desc':
                    filteredResults.sort((a, b) => b.totalTests - a.totalTests);
                    break;
                case 'test_count_asc':
                    filteredResults.sort((a, b) => a.totalTests - b.totalTests);
                    break;
                case 'recent_activity':
                    filteredResults.sort((a, b) => {
                        const aLastTest = a.results.length > 0 ? new Date(Math.max(...a.results.map(r => new Date(r.completed_at)))) : new Date(0);
                        const bLastTest = b.results.length > 0 ? new Date(Math.max(...b.results.map(r => new Date(r.completed_at)))) : new Date(0);
                        return bLastTest - aLastTest;
                    });
                    break;
                case 'improvement_desc':
                    filteredResults.sort((a, b) => {
                        const improvementOrder = { 'improving': 3, 'stable': 2, 'declining': 1 };
                        return (improvementOrder[b.improvementTrend] || 0) - (improvementOrder[a.improvementTrend] || 0);
                    });
                    break;
                case 'consistency_desc':
                    filteredResults.sort((a, b) => {
                        const consistencyOrder = { 'very_consistent': 4, 'consistent': 3, 'moderate': 2, 'inconsistent': 1 };
                        return (consistencyOrder[b.consistency] || 0) - (consistencyOrder[a.consistency] || 0);
                    });
                    break;
                case 'name_asc':
                default:
                    filteredResults.sort((a, b) => a.student.name.localeCompare(b.student.name, 'tr'));
                    break;
            }

            displayFilteredStudentResults(filteredResults);
        }

        // Update student filter info
        function updateStudentFilterInfo(filteredCount) {
            const totalCount = window.allStudentResultsData?.length || 0;
            const infoElement = document.getElementById('filterResultsInfo');
            
            if (!infoElement) return;
            
            const searchTerm = document.getElementById('resultsSearchInput')?.value.trim() || '';
            const filterType = document.getElementById('resultsFilterSelect')?.value || 'all';
            const classFilter = document.getElementById('resultsClassFilter')?.value || 'all';
            
            let infoText = '';
            
            if (searchTerm && filterType !== 'all' && classFilter !== 'all') {
                infoText = `"${searchTerm}" aramasƒ±, ${getStudentFilterDisplayName(filterType)} ve ${classFilter} sƒ±nƒ±fƒ±: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (searchTerm && filterType !== 'all') {
                infoText = `"${searchTerm}" aramasƒ± ve ${getStudentFilterDisplayName(filterType)}: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (searchTerm && classFilter !== 'all') {
                infoText = `"${searchTerm}" aramasƒ± ve ${classFilter} sƒ±nƒ±fƒ±: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (filterType !== 'all' && classFilter !== 'all') {
                infoText = `${getStudentFilterDisplayName(filterType)} ve ${classFilter} sƒ±nƒ±fƒ±: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (searchTerm) {
                infoText = `"${searchTerm}" aramasƒ±: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (filterType !== 'all') {
                infoText = `${getStudentFilterDisplayName(filterType)}: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else if (classFilter !== 'all') {
                infoText = `${classFilter} sƒ±nƒ±fƒ±: ${filteredCount}/${totalCount} √∂ƒürenci`;
            } else {
                infoText = `T√ºm √∂ƒürenciler g√∂steriliyor: ${filteredCount} √∂ƒürenci`;
            }
            
            infoElement.querySelector('span').textContent = infoText;
        }

        // Get student filter display name
        function getStudentFilterDisplayName(filter) {
            const names = {
                'active': 'Test √á√∂zenler',
                'inactive': 'Test √á√∂zmeyenler',
                'high_performers': 'Y√ºksek Performans (‚â•85)',
                'excellent_performers': 'M√ºkemmel Performans (‚â•90)',
                'low_performers': 'Geli≈ümeli (<70)',
                'improving': 'Geli≈üen √ñƒürenciler',
                'declining': 'D√º≈üen Performans',
                'consistent': 'Tutarlƒ± √ñƒürenciler',
                'inconsistent': 'Deƒüi≈üken Performans',
                'pending': 'Bekleyen Testi Olanlar',
                'recent_active': 'Son Hafta Aktif'
            };
            return names[filter] || filter;
        }

        // Clear student filters
        function clearStudentFilters() {
            document.getElementById('resultsSearchInput').value = '';
            document.getElementById('resultsFilterSelect').value = 'all';
            document.getElementById('resultsSortSelect').value = 'name_asc';
            document.getElementById('resultsClassFilter').value = 'all';
            filterStudentResults();
        }

        // Export student results (placeholder)
        async function exportStudentResults() {
            try {
                showNotification('Excel dosyasƒ± hazƒ±rlanƒ±yor...', 'info');

                // Get all data
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (studentsError) throw studentsError;

                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*');

                if (resultsError) throw resultsError;

                const { data: tests, error: testsError } = await supabase
                    .from('tests')
                    .select('*');

                if (testsError) throw testsError;

                const { data: assignments, error: assignmentsError } = await supabase
                    .from('test_assignments')
                    .select('*');

                if (assignmentsError) throw assignmentsError;

                // Total active tests in the system
                const totalActiveTests = tests.length;

                // Create CSV content with UTF-8 BOM for proper Turkish character support in Excel
                let csvContent = '\uFEFF';
                
                // Header row
                csvContent += '√ñƒürencinin Adƒ± Soyadƒ±,';
                csvContent += 'Ba≈üarƒ±lƒ± Testler (‚â•70),';
                csvContent += 'Ba≈üarƒ±sƒ±z Testler (<70),';
                csvContent += 'Aktif Testler (Sistemdeki Toplam),';
                csvContent += '√á√∂zmediƒüi Testler (Bekleyen),';
                csvContent += '√ñƒürenciye Atanmamƒ±≈ü Testler\n';

                // Process each student
                students.forEach(student => {
                    // Get student's completed tests
                    const studentResults = results.filter(r => r.student_id === student.id);
                    const completedTestIds = studentResults.map(r => r.test_id);
                    
                    // Calculate statistics
                    const successfulTests = studentResults.filter(r => r.score >= 70).length;
                    const failedTests = studentResults.filter(r => r.score < 70).length;
                    
                    // Find assigned and unsolved tests
                    const studentAssignments = assignments.filter(a => a.student_id === student.id);
                    const assignedTestIds = studentAssignments.map(a => a.test_id);
                    const unsolvedTestIds = assignedTestIds.filter(id => !completedTestIds.includes(id));
                    
                    // Get unsolved test names (assigned but not completed)
                    const unsolvedTestNames = unsolvedTestIds
                        .map(testId => {
                            const test = tests.find(t => t.id === testId);
                            return test ? test.title : `Test #${testId}`;
                        })
                        .join('; ');
                    
                    // Find unassigned tests (tests in system but not assigned to this student)
                    const allTestIds = tests.map(t => t.id);
                    const unassignedTestIds = allTestIds.filter(id => !assignedTestIds.includes(id));
                    
                    // Get unassigned test names
                    const unassignedTestNames = unassignedTestIds
                        .map(testId => {
                            const test = tests.find(t => t.id === testId);
                            return test ? test.title : `Test #${testId}`;
                        })
                        .join('; ');
                    
                    // Build CSV row
                    csvContent += `"${student.name}",`;
                    csvContent += `${successfulTests},`;
                    csvContent += `${failedTests},`;
                    csvContent += `${totalActiveTests},`;
                    csvContent += `"${unsolvedTestNames || 'Yok'}",`;
                    csvContent += `"${unassignedTestNames || 'Yok'}"\n`;
                });

                // Add summary section
                csvContent += '\n';
                csvContent += '√ñZET ƒ∞STATƒ∞STƒ∞KLER\n';
                csvContent += `Toplam √ñƒürenci Sayƒ±sƒ±,${students.length}\n`;
                csvContent += `Sistemdeki Toplam Test Sayƒ±sƒ±,${totalActiveTests}\n`;
                csvContent += `√á√∂z√ºlen Toplam Test,${results.length}\n`;
                
                const totalSuccessful = results.filter(r => r.score >= 70).length;
                const totalFailed = results.filter(r => r.score < 70).length;
                csvContent += `Ba≈üarƒ±lƒ± Test Sayƒ±sƒ± (‚â•70),${totalSuccessful}\n`;
                csvContent += `Ba≈üarƒ±sƒ±z Test Sayƒ±sƒ± (<70),${totalFailed}\n`;
                
                const allScores = results.map(r => r.score);
                const classAvg = allScores.length > 0 ? Math.round(allScores.reduce((a, b) => a + b, 0) / allScores.length) : 0;
                csvContent += `Sƒ±nƒ±f Ortalamasƒ±,${classAvg}\n`;
                
                const totalPendingTests = assignments.length - results.length;
                csvContent += `Toplam Bekleyen Test,${totalPendingTests}\n`;

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const timestamp = new Date().toISOString().slice(0, 10);
                link.setAttribute('href', url);
                link.setAttribute('download', `ogrenci-test-raporu-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('‚úÖ Excel dosyasƒ± ba≈üarƒ±yla indirildi!', 'success');

            } catch (error) {
                console.error('Excel export error:', error);
                showNotification('Excel dosyasƒ± olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Export student results as PDF
        async function exportStudentResultsPDF() {
            try {
                showNotification('PDF dosyasƒ± hazƒ±rlanƒ±yor...', 'info');

                // Get all data
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (studentsError) throw studentsError;

                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*');

                if (resultsError) throw resultsError;

                const { data: tests, error: testsError } = await supabase
                    .from('tests')
                    .select('*');

                if (testsError) throw testsError;

                const { data: assignments, error: assignmentsError } = await supabase
                    .from('test_assignments')
                    .select('*');

                if (assignmentsError) throw assignmentsError;

                // Total active tests in the system
                const totalActiveTests = tests.length;

                // Create HTML content for PDF
                let htmlContent = `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>√ñƒürenci Test Raporu</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            font-size: 12px;
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 10px;
        }
        .header-info {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 11px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th {
            background-color: #2563eb;
            color: white;
            padding: 8px;
            text-align: left;
            font-size: 11px;
            border: 1px solid #1e40af;
        }
        td {
            padding: 6px 8px;
            border: 1px solid #ddd;
            font-size: 10px;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .summary {
            background-color: #eff6ff;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        .summary h2 {
            color: #1e40af;
            margin-top: 0;
            font-size: 14px;
        }
        .summary-item {
            margin: 5px 0;
            font-size: 11px;
        }
        .summary-item strong {
            color: #1e40af;
        }
        .test-list {
            font-size: 9px;
            color: #666;
            max-width: 200px;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>üìä √ñƒürenci Test Performans Raporu</h1>
    <div class="header-info">
        Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}<br>
        T√ºrk√ße Okuma Anlama Test Sistemi
    </div>
    
    <table>
        <thead>
            <tr>
                <th>√ñƒürencinin Adƒ± Soyadƒ±</th>
                <th>Ba≈üarƒ±lƒ±<br>Testler<br>(‚â•70)</th>
                <th>Ba≈üarƒ±sƒ±z<br>Testler<br>(<70)</th>
                <th>Aktif<br>Testler</th>
                <th>√á√∂zmediƒüi Testler (Bekleyen)</th>
                <th>√ñƒürenciye Atanmamƒ±≈ü Testler</th>
            </tr>
        </thead>
        <tbody>
`;

                // Process each student
                students.forEach(student => {
                    // Get student's completed tests
                    const studentResults = results.filter(r => r.student_id === student.id);
                    const completedTestIds = studentResults.map(r => r.test_id);
                    
                    // Calculate statistics
                    const successfulTests = studentResults.filter(r => r.score >= 70).length;
                    const failedTests = studentResults.filter(r => r.score < 70).length;
                    
                    // Find assigned and unsolved tests
                    const studentAssignments = assignments.filter(a => a.student_id === student.id);
                    const assignedTestIds = studentAssignments.map(a => a.test_id);
                    const unsolvedTestIds = assignedTestIds.filter(id => !completedTestIds.includes(id));
                    
                    // Get unsolved test names
                    const unsolvedTestNames = unsolvedTestIds
                        .map(testId => {
                            const test = tests.find(t => t.id === testId);
                            return test ? test.title : `Test #${testId}`;
                        })
                        .join(', ');
                    
                    // Find unassigned tests
                    const allTestIds = tests.map(t => t.id);
                    const unassignedTestIds = allTestIds.filter(id => !assignedTestIds.includes(id));
                    
                    // Get unassigned test names
                    const unassignedTestNames = unassignedTestIds
                        .map(testId => {
                            const test = tests.find(t => t.id === testId);
                            return test ? test.title : `Test #${testId}`;
                        })
                        .join(', ');
                    
                    htmlContent += `
            <tr>
                <td><strong>${student.name}</strong></td>
                <td style="text-align: center; color: green;"><strong>${successfulTests}</strong></td>
                <td style="text-align: center; color: red;"><strong>${failedTests}</strong></td>
                <td style="text-align: center;"><strong>${totalActiveTests}</strong></td>
                <td class="test-list">${unsolvedTestNames || 'Yok'}</td>
                <td class="test-list">${unassignedTestNames || 'Yok'}</td>
            </tr>
`;
                });

                htmlContent += `
        </tbody>
    </table>
    
    <div class="summary">
        <h2>üìà √ñzet ƒ∞statistikler</h2>
        <div class="summary-item"><strong>Toplam √ñƒürenci Sayƒ±sƒ±:</strong> ${students.length}</div>
        <div class="summary-item"><strong>Sistemdeki Toplam Test Sayƒ±sƒ±:</strong> ${totalActiveTests}</div>
        <div class="summary-item"><strong>√á√∂z√ºlen Toplam Test:</strong> ${results.length}</div>
        <div class="summary-item"><strong>Ba≈üarƒ±lƒ± Test Sayƒ±sƒ± (‚â•70):</strong> ${results.filter(r => r.score >= 70).length}</div>
        <div class="summary-item"><strong>Ba≈üarƒ±sƒ±z Test Sayƒ±sƒ± (<70):</strong> ${results.filter(r => r.score < 70).length}</div>
        <div class="summary-item"><strong>Sƒ±nƒ±f Ortalamasƒ±:</strong> ${results.length > 0 ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length) : 0}</div>
        <div class="summary-item"><strong>Toplam Bekleyen Test:</strong> ${assignments.length - results.length}</div>
    </div>
</body>
</html>
`;

                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                
                // Wait for content to load, then trigger print dialog
                setTimeout(() => {
                    printWindow.print();
                    showNotification('‚úÖ PDF yazdƒ±rma penceresi a√ßƒ±ldƒ±! "PDF olarak kaydet" se√ßeneƒüini kullanƒ±n.', 'success');
                }, 500);

            } catch (error) {
                console.error('PDF export error:', error);
                showNotification('PDF dosyasƒ± olu≈üturulurken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Export individual student detail (placeholder)
        function exportStudentDetail(studentId) {
            showNotification('√ñƒürenci detay export √∂zelliƒüi yakƒ±nda eklenecek.', 'info');
        }

        // Show simple results view as fallback
        async function showSimpleResults() {
            try {
                console.log('Loading simple results view...');
                
                // Simple query to get basic data
                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*')
                    .order('completed_at', { ascending: false });

                if (resultsError) throw resultsError;

                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*');

                if (studentsError) throw studentsError;

                const { data: tests, error: testsError } = await supabase
                    .from('tests')
                    .select('*');

                if (testsError) throw testsError;

                const container = document.getElementById('resultsList');
                container.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">üìä Test Sonu√ßlarƒ± (Basit G√∂r√ºn√ºm)</h3>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${students?.length || 0}</div>
                                    <div class="text-sm text-gray-600">Toplam √ñƒürenci</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600">${tests?.length || 0}</div>
                                    <div class="text-sm text-gray-600">Toplam Test</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-600">${results?.length || 0}</div>
                                    <div class="text-sm text-gray-600">Tamamlanan Test</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-600">${results?.filter(r => r.score >= 70).length || 0}</div>
                                    <div class="text-sm text-gray-600">Ba≈üarƒ±lƒ± Sonu√ß</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                if (!results || results.length === 0) {
                    container.innerHTML += `
                        <div class="text-center py-12">
                            <i class="fas fa-clipboard-list text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">Hen√ºz test sonucu bulunmuyor.</p>
                            <p class="text-gray-400 text-sm mt-2">√ñƒürenciler test √ß√∂zd√ºk√ße sonu√ßlar burada g√∂r√ºnecek.</p>
                        </div>
                    `;
                    return;
                }

                // Create lookup maps
                const studentLookup = {};
                students?.forEach(s => studentLookup[s.id] = s);
                
                const testLookup = {};
                tests?.forEach(t => testLookup[t.id] = t);

                // Display results in simple table format
                const resultsHtml = results.map(result => {
                    const student = studentLookup[result.student_id] || { name: 'Unknown Student', student_no: 'N/A', class: 'N/A' };
                    const test = testLookup[result.test_id] || { title: 'Unknown Test' };
                    
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-center">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-2">
                                        <div class="text-2xl">
                                            ${result.score === 100 ? 'üèÜ' :
                                              result.score >= 90 ? '‚≠ê' :
                                              result.score >= 70 ? '‚úÖ' : 'üìö'}
                                        </div>
                                        <div>
                                            <h4 class="font-semibold text-gray-900">${student.name}</h4>
                                            <p class="text-sm text-gray-600">No: ${student.student_no} | Sƒ±nƒ±f: ${student.class}</p>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-700">
                                        <strong>Test:</strong> ${test.title}
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${new Date(result.completed_at).toLocaleDateString('tr-TR', { 
                                            weekday: 'short', 
                                            year: 'numeric', 
                                            month: 'short', 
                                            day: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        })}
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold ${
                                        result.score === 100 ? 'text-purple-600' :
                                        result.score >= 90 ? 'text-green-600' :
                                        result.score >= 70 ? 'text-blue-600' : 'text-red-600'
                                    }">${result.score}</div>
                                    <div class="text-sm font-medium ${
                                        result.score === 100 ? 'text-purple-600' :
                                        result.score >= 90 ? 'text-green-600' :
                                        result.score >= 70 ? 'text-blue-600' : 'text-red-600'
                                    }">
                                        ${result.score === 100 ? 'M√ºkemmel' :
                                          result.score >= 90 ? 'Harika' :
                                          result.score >= 70 ? 'Ba≈üarƒ±lƒ±' : 'Geli≈ümeli'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                container.innerHTML += `
                    <div class="space-y-4">
                        ${resultsHtml}
                    </div>
                    
                    <div class="mt-8 text-center">
                        <button onclick="loadResultsList()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-chart-bar mr-2"></i>Detaylƒ± G√∂r√ºn√ºme Ge√ß
                        </button>
                    </div>
                `;

                console.log('Simple results loaded successfully');

            } catch (error) {
                console.error('Error loading simple results:', error);
                showNotification('Basit g√∂r√ºn√ºm y√ºklenirken hata olu≈ütu.', 'error');
            }
        }

        // Display filtered results (legacy function - keeping for compatibility)
        function displayFilteredResults(results) {
            const container = document.getElementById('filteredResultsContainer');
            if (!container) return;
            
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-search text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-500">Arama kriterlerinize uygun sonu√ß bulunamadƒ±.</p>
                    </div>
                `;
                return;
            }

            // Group results by test for better organization
            const resultsByTest = {};
            results.forEach(result => {
                const testId = result.test_id;
                if (!resultsByTest[testId]) {
                    resultsByTest[testId] = {
                        testInfo: result.tests,
                        results: []
                    };
                }
                resultsByTest[testId].results.push(result);
            });

            Object.values(resultsByTest).forEach(testGroup => {
                const testResults = testGroup.results;
                const testAverage = Math.round(testResults.reduce((sum, r) => sum + r.score, 0) / testResults.length);
                const testPassRate = Math.round((testResults.filter(r => r.score >= 70).length / testResults.length) * 100);

                // Test group header
                const testGroupDiv = document.createElement('div');
                testGroupDiv.className = 'mb-8';
                testGroupDiv.innerHTML = `
                    <div class="bg-white border-2 border-gray-200 rounded-xl overflow-hidden">
                        <!-- Test Header -->
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 p-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-900 flex items-center">
                                        <i class="fas fa-clipboard-list text-blue-600 mr-2"></i>
                                        ${testGroup.testInfo.title}
                                    </h4>
                                    <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                                        <span><i class="fas fa-users mr-1"></i>${testResults.length} √∂ƒürenci</span>
                                        <span><i class="fas fa-clock mr-1"></i>${testGroup.testInfo.time_limit} dakika</span>
                                        <span><i class="fas fa-chart-line mr-1"></i>Ortalama: ${testAverage}</span>
                                        <span><i class="fas fa-percentage mr-1"></i>Ba≈üarƒ±: %${testPassRate}</span>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <button onclick="exportTestResults(${testGroup.results[0].test_id})" 
                                            class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition duration-200">
                                        <i class="fas fa-download mr-1"></i>Excel
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Results List -->
                        <div class="divide-y divide-gray-100">
                `;

                // Sort results by score (highest first) within each test
                testResults.sort((a, b) => b.score - a.score);

                testResults.forEach((result, index) => {
                    const completedDate = new Date(result.completed_at);
                    const timeAgo = getTimeAgo(completedDate);
                    
                    // Determine performance level and styling
                    let performanceLevel, performanceColor, performanceIcon, rankIcon;
                    
                    if (result.score === 100) {
                        performanceLevel = 'M√ºkemmel';
                        performanceColor = 'text-purple-600 bg-purple-50 border-purple-200';
                        performanceIcon = 'üèÜ';
                        rankIcon = 'üëë';
                    } else if (result.score >= 90) {
                        performanceLevel = 'Harika';
                        performanceColor = 'text-green-600 bg-green-50 border-green-200';
                        performanceIcon = '‚≠ê';
                        rankIcon = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üåü';
                    } else if (result.score >= 70) {
                        performanceLevel = 'Ba≈üarƒ±lƒ±';
                        performanceColor = 'text-blue-600 bg-blue-50 border-blue-200';
                        performanceIcon = 'üëç';
                        rankIcon = '‚úÖ';
                    } else {
                        performanceLevel = 'Geli≈ümeli';
                        performanceColor = 'text-red-600 bg-red-50 border-red-200';
                        performanceIcon = 'üìö';
                        rankIcon = 'üìñ';
                    }

                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'p-4 hover:bg-gray-50 transition-colors duration-200';
                    resultDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <!-- Left: Student Info -->
                            <div class="flex items-center space-x-4">
                                <div class="text-2xl">${rankIcon}</div>
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <h5 class="font-semibold text-gray-900">${result.students.name}</h5>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full border ${performanceColor}">
                                            ${performanceIcon} ${performanceLevel}
                                        </span>
                                    </div>
                                    <div class="flex items-center space-x-3 mt-1 text-sm text-gray-600">
                                        <span>No: ${result.students.student_no}</span>
                                        <span>Sƒ±nƒ±f: ${result.students.class}</span>
                                        <span><i class="fas fa-calendar mr-1"></i>${timeAgo}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Right: Score and Actions -->
                            <div class="flex items-center space-x-4">
                                <!-- Score Display -->
                                <div class="text-center">
                                    <div class="text-3xl font-bold ${
                                        result.score === 100 ? 'text-purple-600' :
                                        result.score >= 90 ? 'text-green-600' :
                                        result.score >= 70 ? 'text-blue-600' : 'text-red-600'
                                    }">${result.score}</div>
                                    <div class="text-xs text-gray-600 font-medium">puan</div>
                                </div>

                                <!-- Action Button -->
                                <button onclick="showDetailedResult(${result.id})" 
                                        class="px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-eye mr-1"></i>Detay
                                </button>
                            </div>
                        </div>
                    `;
                    
                    testGroupDiv.querySelector('.divide-y').appendChild(resultDiv);
                });

                testGroupDiv.innerHTML += `
                        </div>
                    </div>
                `;

                container.appendChild(testGroupDiv);
            });
        }

        // Filter results function
        function filterResults() {
            if (!window.allResultsData) return;

            const searchTerm = document.getElementById('resultsSearchInput')?.value.toLowerCase().trim() || '';
            const filterType = document.getElementById('resultsFilterSelect')?.value || 'all';
            const sortType = document.getElementById('resultsSortSelect')?.value || 'newest';

            let filteredResults = [...window.allResultsData];

            // Apply search filter
            if (searchTerm) {
                filteredResults = filteredResults.filter(result => 
                    result.students.name.toLowerCase().includes(searchTerm) ||
                    result.tests.title.toLowerCase().includes(searchTerm) ||
                    result.students.student_no.toLowerCase().includes(searchTerm)
                );
            }

            // Apply category filter
            switch (filterType) {
                case 'passed':
                    filteredResults = filteredResults.filter(result => result.score >= 70);
                    break;
                case 'failed':
                    filteredResults = filteredResults.filter(result => result.score < 70);
                    break;
                case 'excellent':
                    filteredResults = filteredResults.filter(result => result.score >= 90);
                    break;
                case 'perfect':
                    filteredResults = filteredResults.filter(result => result.score === 100);
                    break;
            }

            // Apply sorting
            switch (sortType) {
                case 'oldest':
                    filteredResults.sort((a, b) => new Date(a.completed_at) - new Date(b.completed_at));
                    break;
                case 'highest_score':
                    filteredResults.sort((a, b) => b.score - a.score);
                    break;
                case 'lowest_score':
                    filteredResults.sort((a, b) => a.score - b.score);
                    break;
                case 'student_name':
                    filteredResults.sort((a, b) => a.students.name.localeCompare(b.students.name, 'tr'));
                    break;
                case 'newest':
                default:
                    filteredResults.sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
                    break;
            }

            displayFilteredResults(filteredResults);
        }

        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Az √∂nce';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} dakika √∂nce`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} saat √∂nce`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} g√ºn √∂nce`;
            
            return date.toLocaleDateString('tr-TR');
        }

        // Show detailed result (placeholder for future implementation)
        function showDetailedResult(resultId) {
            showNotification('Detaylƒ± sonu√ß g√∂r√ºnt√ºleme √∂zelliƒüi yakƒ±nda eklenecek.', 'info');
        }

        // Export test results to Excel (placeholder for future implementation)
        function exportTestResults(testId) {
            showNotification('Excel export √∂zelliƒüi yakƒ±nda eklenecek.', 'info');
        }

        // Display student badges
        async function displayStudentBadges(badges) {
            const container = document.getElementById('studentBadges');
            container.innerHTML = '';

            // Get current test count and scores for progress calculation
            const { data: results } = await supabase
                .from('test_results')
                .select('*')
                .eq('student_id', currentUser.id);
            
            const totalTestCount = results?.length || 0;
            const successfulTestCount = results?.filter(r => r.score >= 70).length || 0;
            const maxScore = results?.length > 0 ? Math.max(...results.map(r => r.score)) : 0;
            const hasHighScore = results?.some(r => r.score >= 90) || false;
            const hasPerfectScore = results?.some(r => r.score === 100) || false;

            const allBadges = [
                { type: 'first_step', name: 'üê£ ƒ∞lk Adƒ±m', description: 'ƒ∞lk testi tamamla', requirement: 1, current: totalTestCount },
                { type: 'bright_star', name: 'üåà Parlak Yƒ±ldƒ±z', description: '90+ puan al', requirement: '90+ puan', current: hasHighScore ? 'Kazanƒ±ldƒ±' : 'Hen√ºz yok' },
                { type: 'perfect_hit', name: 'ü•á Tam ƒ∞sabet', description: '%100 puan al', requirement: '100 puan', current: hasPerfectScore ? 'Kazanƒ±ldƒ±' : 'Hen√ºz yok' },
                { type: 'speed_fingers', name: '‚ö° Hƒ±zlƒ± Parmaklar', description: 'Hƒ±zlƒ± test bitir', requirement: '<5 dk', current: 'S√ºre bazlƒ±' },
                { type: 'patient_hero', name: 'üê¢ Sabƒ±rlƒ± Kahraman', description: '5 ba≈üarƒ±lƒ± test', requirement: 5, current: successfulTestCount },
                { type: 'super_student', name: 'ü¶∏ S√ºper √ñƒürenci', description: '10 ba≈üarƒ±lƒ± test', requirement: 10, current: successfulTestCount },
                { type: 'knowledge_dragon', name: 'üêâ Bilgi Ejderhasƒ±', description: '25 ba≈üarƒ±lƒ± test', requirement: 25, current: successfulTestCount },
                { type: 'shining_mind', name: 'üåü Parlayan Zihin', description: '50 ba≈üarƒ±lƒ± test', requirement: 50, current: successfulTestCount },
                { type: 'class_leader', name: 'üëë Sƒ±nƒ±f Lideri', description: '100 ba≈üarƒ±lƒ± test', requirement: 100, current: successfulTestCount },
                { type: 'book_worm', name: 'üìöüêõ Kitap Kurdu', description: '150 ba≈üarƒ±lƒ± test', requirement: 150, current: successfulTestCount }
            ];

            allBadges.forEach(badge => {
                // Check if badge is earned based on actual conditions
                let earned = false;
                
                if (badge.type === 'first_step' && totalTestCount >= 1) earned = true;
                else if (badge.type === 'bright_star' && hasHighScore) earned = true;
                else if (badge.type === 'perfect_hit' && hasPerfectScore) earned = true;
                else if (badge.type === 'patient_hero' && successfulTestCount >= 5) earned = true;
                else if (badge.type === 'super_student' && successfulTestCount >= 10) earned = true;
                else if (badge.type === 'knowledge_dragon' && successfulTestCount >= 25) earned = true;
                else if (badge.type === 'shining_mind' && successfulTestCount >= 50) earned = true;
                else if (badge.type === 'class_leader' && successfulTestCount >= 100) earned = true;
                else if (badge.type === 'book_worm' && successfulTestCount >= 150) earned = true;
                else if (badges?.some(b => b.badge_type === badge.type)) earned = true;
                
                const progress = typeof badge.requirement === 'number' ? 
                    Math.min(100, (badge.current / badge.requirement) * 100) : 0;
                
                const badgeDiv = document.createElement('div');
                badgeDiv.className = `relative text-center p-6 rounded-xl transition-all duration-300 transform hover:scale-105 ${
                    earned ? 'badge-earned' : 'badge-locked'
                } text-white cursor-pointer`;
                
                badgeDiv.innerHTML = `
                    <div class="text-4xl mb-3">${badge.name.split(' ')[0]}</div>
                    <h4 class="font-bold text-sm mb-1">${badge.name.substring(2)}</h4>
                    <p class="text-xs opacity-90 mb-2">${badge.description}</p>
                    
                    ${!earned && typeof badge.requirement === 'number' ? `
                        <div class="mt-3">
                            <div class="bg-black bg-opacity-20 rounded-full h-2 mb-1">
                                <div class="bg-white rounded-full h-2 transition-all duration-300" style="width: ${progress}%"></div>
                            </div>
                            <div class="text-xs opacity-75">${badge.current}/${badge.requirement}</div>
                        </div>
                    ` : earned ? `
                        <div class="mt-3">
                            <div class="text-xs font-bold opacity-90">‚ú® KAZANILDI ‚ú®</div>
                        </div>
                    ` : ''}
                    
                    ${earned ? `
                        <div class="absolute -top-2 -right-2 bg-green-500 rounded-full w-6 h-6 flex items-center justify-center">
                            <i class="fas fa-check text-xs text-white"></i>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(badgeDiv);
            });
        }
        // Load leaderboard by querying the 'leaderboard_stats' view (Optimized)
        async function loadLeaderboard() {
            try {
                // 1. Doƒürudan 'leaderboard_stats' g√∂r√ºn√ºm√ºn√º sorgula
                // Sƒ±ralama (ORDER BY) ve limit (limit(15)) veritabanƒ±nda yapƒ±ldƒ±ƒüƒ± i√ßin √ßok hƒ±zlƒ±dƒ±r.
                const { data: leaderboard, error } = await supabase
                    .from('leaderboard_stats')
                    .select('*')
                    .order('successful_tests_count', { ascending: false }) // Ana sƒ±ralama: Ba≈üarƒ±lƒ± test sayƒ±sƒ±
                    .order('average_score', { ascending: false })        // ƒ∞kincil sƒ±ralama: Ortalama puan
                    .limit(28); // Sadece ilk 15 √∂ƒürenciyi getir

                if (error) {
                    // Eƒüer g√∂r√ºn√ºm bulunamazsa veya bir hata olursa, eski y√∂ntemi dene (g√ºvenlik aƒüƒ±)
                    console.warn("leaderboard_stats g√∂r√ºn√ºm√º sorgulanamadƒ±, eski y√∂nteme ge√ßiliyor. Hata:", error.message);
                    return await loadLeaderboardLegacy(); // Eski fonksiyonu √ßaƒüƒ±r (adƒ±nƒ± deƒüi≈ütirdik)
                }

                const container = document.getElementById('leaderboardList');
                container.innerHTML = '';

                if (leaderboard.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12">
                            <i class="fas fa-trophy text-6xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500 text-lg">Hen√ºz liderlik tablosu verisi bulunmuyor.</p>
                            <p class="text-gray-400 text-sm mt-2">ƒ∞lk testler tamamlandƒ±ƒüƒ±nda liderlik tablosu burada g√∂r√ºnecek.</p>
                        </div>
                    `;
                    return;
                }

                // Aray√ºz√º olu≈üturma (UI Rendering)
                addLeaderboardHeader(container);

                leaderboard.forEach((student, index) => {
                    const position = index + 1;
                    const isCurrentUser = currentUser.type === 'student' && student.student_id === currentUser.id;
                    
                    const averageScore = Math.round(student.average_score || 0);

                    // Performans seviyesini belirle
                    let performanceLevel, performanceIcon, performanceColor;
                    if (averageScore >= 95) {
                        performanceLevel = 'M√ºkemmel'; performanceIcon = 'üî•'; performanceColor = 'text-red-600 bg-red-50';
                    } else if (averageScore >= 90) {
                        performanceLevel = 'Harika'; performanceIcon = '‚≠ê'; performanceColor = 'text-yellow-600 bg-yellow-50';
                    } else if (averageScore >= 80) {
                        performanceLevel = 'ƒ∞yi'; performanceIcon = 'üëç'; performanceColor = 'text-green-600 bg-green-50';
                    } else {
                        performanceLevel = 'Geli≈üiyor'; performanceIcon = 'üìö'; performanceColor = 'text-blue-600 bg-blue-50';
                    }

                    // Madalya ve sƒ±ralama ikonu
                    let medalColor, medalIcon;
                    if (position === 1) { medalColor = 'bg-gradient-to-br from-yellow-400 to-yellow-600'; medalIcon = 'üëë'; } 
                    else if (position === 2) { medalColor = 'bg-gradient-to-br from-gray-300 to-gray-500'; medalIcon = 'ü•à'; } 
                    else if (position === 3) { medalColor = 'bg-gradient-to-br from-orange-400 to-orange-600'; medalIcon = 'ü•â'; } 
                    else { medalColor = 'bg-gradient-to-br from-blue-400 to-blue-600'; medalIcon = position.toString(); }
                    
                    const studentDiv = document.createElement('div');
                    studentDiv.className = `mb-4 p-5 rounded-xl border-2 transition-all duration-300 hover:shadow-lg ${isCurrentUser ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-300 shadow-md' : 'bg-white border-gray-200 hover:border-gray-300'}`;
                    
                    studentDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <div class="w-12 h-12 rounded-full ${medalColor} flex items-center justify-center text-white font-bold shadow-lg">${medalIcon}</div>
                                </div>
                                <div>
                                    <div class="flex items-center space-x-2">
                                        <h4 class="font-bold text-lg text-gray-900">${student.student_name}</h4>
                                        ${isCurrentUser ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-medium">SEN</span>' : ''}
                                    </div>
                                    <div class="flex items-center space-x-3 mt-1">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${performanceColor}">${performanceIcon} ${performanceLevel}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold ${averageScore >= 90 ? 'text-green-600' : 'text-blue-600'}">${averageScore}</div>
                                <div class="text-sm text-gray-600 font-medium">Ortalama Puan</div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <div class="grid grid-cols-3 gap-3 text-center">
                                <div class="bg-green-50 rounded-lg p-3 border-2 border-green-200">
                                    <div class="text-xl font-bold text-green-700">${student.successful_tests_count || 0} ‚úÖ</div>
                                    <div class="text-xs text-green-700 font-medium">Ba≈üarƒ±lƒ± Test</div>
                                </div>
                                <div class="bg-yellow-50 rounded-lg p-3">
                                    <div class="text-xl font-bold text-yellow-700">${student.perfect_scores_count || 0} üíØ</div>
                                    <div class="text-xs text-yellow-700 font-medium">Tam Puan</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-3">
                                    <div class="text-xl font-bold text-blue-700">${student.speed_bonuses_count || 0} ‚ö°</div>
                                    <div class="text-xs text-blue-700 font-medium">Hƒ±z Bonusu</div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(studentDiv);
                });

            } catch (error) {
                console.error('Liderlik tablosu y√ºklenirken hata olu≈ütu:', error);
                const container = document.getElementById('leaderboardList');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                        <p class="text-red-600">Liderlik tablosu y√ºklenirken bir hata olu≈ütu.</p>
                        <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }

        // Liderlik tablosu i√ßin ba≈ülƒ±k ve a√ßƒ±klama ekleyen yardƒ±mcƒ± fonksiyon
        function addLeaderboardHeader(container) {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'mb-6 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100';
            headerDiv.innerHTML = `
                <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    Liderlik Tablosu
                </h3>
                <div class="mb-4 p-3 bg-blue-100 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-900 mb-2 flex items-center">
                        üèÜ Yeni Sƒ±ralama Sistemi
                    </h4>
                    <div class="text-sm text-blue-800 space-y-1">
                        <div><strong>√ñncelik:</strong> Ba≈üarƒ±lƒ± (70 puan ve √ºzeri) Test Sayƒ±sƒ±</div>
                        <div><strong>E≈üitlik Durumunda:</strong> Ortalama Puan</div>
                    </div>
                </div>
            `;
            container.appendChild(headerDiv);
        }

        // G√ºvenlik aƒüƒ± olarak eski fonksiyonu yeniden adlandƒ±rarak saklayalƒ±m
        async function loadLeaderboardLegacy() {
            // Bu fonksiyon, eski kodunuzun i√ßeriƒüini barƒ±ndƒ±rƒ±r.
            // Sadece bir sorun olursa devreye girmesi i√ßin burada tutulur.
            console.log("Eski liderlik tablosu y√ºkleme metodu √ßalƒ±≈ütƒ±rƒ±ldƒ±.");
        }

        // Modal functions
        function showUploadTest() {
            document.getElementById('uploadTestModal').classList.remove('hidden');
        }

        function showAddStudent() {
            document.getElementById('addStudentModal').classList.remove('hidden');
        }

        function showBulkUpload() {
            showNotification('Excel y√ºkleme √∂zelliƒüi yakƒ±nda eklenecek.', 'info');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Upload tab switching
        function switchUploadTab(tabType) {
            const fileTab = document.getElementById('fileUploadTab');
            const pasteTab = document.getElementById('pasteUploadTab');
            const fileContent = document.getElementById('fileUploadContent');
            const pasteContent = document.getElementById('pasteUploadContent');

            if (tabType === 'file') {
                fileTab.classList.add('border-green-500', 'text-green-600');
                fileTab.classList.remove('border-transparent', 'text-gray-500');
                pasteTab.classList.remove('border-green-500', 'text-green-600');
                pasteTab.classList.add('border-transparent', 'text-gray-500');
                fileContent.classList.remove('hidden');
                pasteContent.classList.add('hidden');
            } else {
                pasteTab.classList.add('border-green-500', 'text-green-600');
                pasteTab.classList.remove('border-transparent', 'text-gray-500');
                fileTab.classList.remove('border-green-500', 'text-green-600');
                fileTab.classList.add('border-transparent', 'text-gray-500');
                pasteContent.classList.remove('hidden');
                fileContent.classList.add('hidden');
            }
        }

        // Get example JSON with proper question formats
        function getExampleJSON() {
            return {
                title: "T√ºrk√ße Okuma Anlama Testi",
                description: "2. Sƒ±nƒ±f T√ºrk√ße Okuma Anlama Testi",
                readingText: `Kitap okumak, insanƒ±n zihinsel geli≈üimi i√ßin en √∂nemli faaliyetlerden biridir. Kitaplar sayesinde farklƒ± d√ºnyalarƒ± ke≈üfeder, yeni bilgiler √∂ƒürenir ve hayal g√ºc√ºm√ºz√º geli≈ütiririz. D√ºzenli kitap okuma alƒ±≈ükanlƒ±ƒüƒ± olan √ßocuklar, hem akademik ba≈üarƒ±larƒ±nda hem de sosyal ili≈ükilerinde daha ba≈üarƒ±lƒ± olurlar.

Ara≈ütƒ±rmalar g√∂steriyor ki, g√ºnde en az 30 dakika kitap okuyan √∂ƒürencilerin kelime hazinesi daha geni≈ü oluyor. Ayrƒ±ca kitap okuma, empati yeteneƒüini de geli≈ütiriyor. Farklƒ± karakterlerin duygularƒ±nƒ± anlayarak, ger√ßek hayatta da insanlarƒ± daha iyi anlayabiliyoruz.

Teknolojinin hƒ±zla geli≈ütiƒüi g√ºn√ºm√ºzde, dijital kitaplar da pop√ºler hale geldi. Ancak basƒ±lƒ± kitaplarƒ±n da kendine √∂zg√º avantajlarƒ± var. Hangi t√ºr√º tercih ederseniz edin, √∂nemli olan d√ºzenli okuma alƒ±≈ükanlƒ±ƒüƒ± kazanmaktƒ±r.`,
                textDisplayMode: "first_page_only",
                timeLimit: 25,
                questions: [
                    {
                        type: "multiple_choice",
                        question: "Metne g√∂re, kitap okumanƒ±n faydalarƒ± arasƒ±nda hangisi yer almaz?",
                        options: ["A) Zihinsel geli≈üimi destekler", "B) Hayal g√ºc√ºn√º geli≈ütirir", "C) Fiziksel g√º√ß√º artƒ±rƒ±r"],
                        correct: 2,
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "multiple_choice",
                        question: "Metne g√∂re, g√ºnde ka√ß dakika kitap okumak kelime hazinesini geni≈ületir?",
                        options: ["A) 15 dakika", "B) 30 dakika", "C) 45 dakika"],
                        correct: 1,
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "multiple_choice",
                        question: "Metinde 'empati' kelimesi hangi anlamda kullanƒ±lmƒ±≈ütƒ±r?",
                        options: ["A) Ba≈ükalarƒ±nƒ± ele≈ütirme", "B) Ba≈ükalarƒ±nƒ± anlama", "C) Ba≈ükalarƒ±ndan ka√ßƒ±nma"],
                        correct: 1,
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "true_false",
                        question: "Metne g√∂re, d√ºzenli kitap okuyan √ßocuklar sadece akademik ba≈üarƒ±da √∂ne √ßƒ±kar.",
                        correct: false,
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "true_false", 
                        question: "Metne g√∂re, dijital kitaplar g√ºn√ºm√ºzde pop√ºler hale gelmi≈ütir.",
                        correct: true,
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "fill_blank",
                        question: "Metne g√∂re, kitap okuma _____ yeteneƒüini geli≈ütiriyor.",
                        options: ["empati", "zeka", "g√º√ß"],
                        correct: "empati",
                        points: 5,
                        timeLimit: 75
                    },
                    {
                        type: "fill_blank",
                        question: "Metne g√∂re, √∂nemli olan d√ºzenli _____ alƒ±≈ükanlƒ±ƒüƒ± kazanmaktƒ±r.",
                        options: ["okuma", "yazma", "dinleme"],
                        correct: "okuma",
                        points: 5,
                        timeLimit: 75
                    }
                ]
            };
        }

        // Copy to clipboard
        async function copyToClipboard(data) {
            try {
                const text = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                await navigator.clipboard.writeText(text);
                showNotification('Panoya kopyalandƒ±!', 'success');
            } catch (error) {
                console.error('Copy failed:', error);
                showNotification('Kopyalama ba≈üarƒ±sƒ±z oldu.', 'error');
            }
        }

        // Copy example JSON to textarea
        function copyExampleJSON() {
            const exampleJSON = getExampleJSON();
            document.getElementById('jsonTextArea').value = JSON.stringify(exampleJSON, null, 2);
            showNotification('√ñrnek JSON yapƒ±≈ütƒ±rƒ±ldƒ±!', 'success');
        }

        // Validate JSON
        function validateJSON() {
            const jsonText = document.getElementById('jsonTextArea').value.trim();
            const resultDiv = document.getElementById('jsonValidationResult');
            
            if (!jsonText) {
                showValidationResult('JSON kodu bo≈ü olamaz.', 'error');
                return false;
            }

            try {
                const testData = JSON.parse(jsonText);
                const validation = validateTestStructure(testData);
                
                if (validation.isValid) {
                    showValidationResult('‚úÖ JSON formatƒ± ge√ßerli ve test yapƒ±sƒ± doƒüru!', 'success');
                    return true;
                } else {
                    showValidationResult(`‚ùå ${validation.errors.join(', ')}`, 'error');
                    return false;
                }
            } catch (error) {
                showValidationResult(`‚ùå Ge√ßersiz JSON formatƒ±: ${error.message}`, 'error');
                return false;
            }
        }

        // Validate test structure
        function validateTestStructure(testData) {
            const errors = [];
            
            // Check required fields
            if (!testData.title || typeof testData.title !== 'string') {
                errors.push('Test ba≈ülƒ±ƒüƒ± gerekli (string)');
            }
            
            if (!testData.readingText || typeof testData.readingText !== 'string') {
                errors.push('Okuma metni gerekli (string)');
            }
            
            if (!testData.timeLimit || typeof testData.timeLimit !== 'number') {
                errors.push('S√ºre limiti gerekli (number)');
            }
            
            if (!testData.questions || !Array.isArray(testData.questions)) {
                errors.push('Sorular dizisi gerekli (array)');
            } else {
                // Validate questions
                testData.questions.forEach((question, index) => {
                    const qErrors = validateQuestion(question, index + 1);
                    errors.push(...qErrors);
                });
            }
            
            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        // Validate individual question
        function validateQuestion(question, questionNumber) {
            const errors = [];
            const validTypes = ['multiple_choice', 'fill_blank', 'true_false'];
            
            if (!question.type || !validTypes.includes(question.type)) {
                errors.push(`Soru ${questionNumber}: Ge√ßersiz soru tipi`);
            }
            
            if (!question.question || typeof question.question !== 'string') {
                errors.push(`Soru ${questionNumber}: Soru metni gerekli`);
            }
            
            if (question.type === 'multiple_choice') {
                if (!question.options || !Array.isArray(question.options) || question.options.length < 2) {
                    errors.push(`Soru ${questionNumber}: En az 2 se√ßenek gerekli`);
                }
                if (typeof question.correct !== 'number' || question.correct < 0 || question.correct >= (question.options?.length || 0)) {
                    errors.push(`Soru ${questionNumber}: Ge√ßerli doƒüru cevap indeksi gerekli`);
                }
            } else if (question.type === 'fill_blank') {
                if (!question.correct || typeof question.correct !== 'string') {
                    errors.push(`Soru ${questionNumber}: Doƒüru cevap string olmalƒ±`);
                }
            } else if (question.type === 'true_false') {
                if (typeof question.correct !== 'boolean') {
                    errors.push(`Soru ${questionNumber}: Doƒüru cevap boolean olmalƒ±`);
                }
            }
            
            return errors;
        }

        // Show validation result
        function showValidationResult(message, type) {
            const resultDiv = document.getElementById('jsonValidationResult');
            resultDiv.className = `mt-2 text-sm p-2 rounded ${
                type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
            }`;
            resultDiv.textContent = message;
            resultDiv.classList.remove('hidden');
        }

        // Format JSON
        function formatJSON() {
            const jsonText = document.getElementById('jsonTextArea').value.trim();
            
            if (!jsonText) {
                showNotification('JSON kodu bo≈ü olamaz.', 'error');
                return;
            }

            try {
                const parsed = JSON.parse(jsonText);
                const formatted = JSON.stringify(parsed, null, 2);
                document.getElementById('jsonTextArea').value = formatted;
                showNotification('JSON bi√ßimlendirildi!', 'success');
            } catch (error) {
                showNotification('Ge√ßersiz JSON formatƒ±!', 'error');
            }
        }

        // Clear JSON
        function clearJSON() {
            document.getElementById('jsonTextArea').value = '';
            document.getElementById('jsonValidationResult').classList.add('hidden');
            showNotification('JSON temizlendi!', 'info');
        }

        // Load sample test data
        function loadSampleTest() {
            const sampleTest = getExampleJSON();

            document.getElementById('testName').value = sampleTest.title;
            document.getElementById('testDescription').value = sampleTest.description;
            
            // Check which tab is active
            const pasteContent = document.getElementById('pasteUploadContent');
            if (!pasteContent.classList.contains('hidden')) {
                // If paste tab is active, fill the textarea
                document.getElementById('jsonTextArea').value = JSON.stringify(sampleTest, null, 2);
                showNotification('√ñrnek test verileri yapƒ±≈ütƒ±rƒ±ldƒ±!', 'success');
            } else {
                // If file tab is active, create a file
                const blob = new Blob([JSON.stringify(sampleTest, null, 2)], { type: 'application/json' });
                const file = new File([blob], 'sample-test.json', { type: 'application/json' });
                
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('testFile').files = dataTransfer.files;
                
                // Show selected file name
                document.getElementById('selectedFileName').textContent = 'Se√ßilen dosya: sample-test.json';
                document.getElementById('selectedFileName').classList.remove('hidden');
                
                showNotification('√ñrnek test dosyasƒ± y√ºklendi!', 'success');
            }
        }

        // File input change handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('testFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                const fileNameDiv = document.getElementById('selectedFileName');
                
                if (file) {
                    fileNameDiv.textContent = `Se√ßilen dosya: ${file.name}`;
                    fileNameDiv.classList.remove('hidden');
                } else {
                    fileNameDiv.classList.add('hidden');
                }
            });
        });

        // Upload test
        async function uploadTest(event) {
            event.preventDefault();
            
            console.log('Test y√ºkleme ba≈ülatƒ±ldƒ±...');
            
            const name = document.getElementById('testName').value;
            const description = document.getElementById('testDescription').value;
            
            console.log('Test bilgileri:', { name, description });
            
            if (!name.trim()) {
                showNotification('Test adƒ± bo≈ü olamaz!', 'error');
                return;
            }
            
            let testData;
            
            // Check which tab is active and get data accordingly
            const pasteContent = document.getElementById('pasteUploadContent');
            if (!pasteContent.classList.contains('hidden')) {
                // Paste tab is active
                const jsonText = document.getElementById('jsonTextArea').value.trim();
                
                if (!jsonText) {
                    showNotification('L√ºtfen JSON kodunu yapƒ±≈ütƒ±rƒ±n.', 'error');
                    return;
                }
                
                try {
                    testData = JSON.parse(jsonText);
                    console.log('JSON ba≈üarƒ±yla parse edildi:', testData);
                } catch (error) {
                    console.error('JSON parse hatasƒ±:', error);
                    showNotification(`Ge√ßersiz JSON formatƒ±: ${error.message}`, 'error');
                    return;
                }
            } else {
                // File tab is active
                const file = document.getElementById('testFile').files[0];
                
                if (!file) {
                    showNotification('L√ºtfen bir JSON dosyasƒ± se√ßin.', 'error');
                    return;
                }
                
                try {
                    const text = await file.text();
                    testData = JSON.parse(text);
                    console.log('Dosyadan JSON ba≈üarƒ±yla okundu:', testData);
                } catch (error) {
                    console.error('Dosya okuma hatasƒ±:', error);
                    showNotification(`Dosya okunamadƒ±: ${error.message}`, 'error');
                    return;
                }
            }
            
            // Validate test structure
            console.log('Test yapƒ±sƒ± doƒürulanƒ±yor...');
            const validation = validateTestStructure(testData);
            if (!validation.isValid) {
                console.error('Validasyon hatalarƒ±:', validation.errors);
                showNotification(`Test yapƒ±sƒ± ge√ßersiz: ${validation.errors.join(', ')}`, 'error');
                return;
            }
            console.log('Test yapƒ±sƒ± ge√ßerli ‚úì');
            

            
            // Get text display mode from form
            const textDisplayMode = document.querySelector('input[name="textDisplayMode"]:checked')?.value || 'first_page_only';
            
            // Prepare data for database
            const dbData = {
                title: name.trim(),
                description: description ? description.trim() : null,
                reading_text: testData.readingText || testData.reading_text || '',
                text_display_mode: testData.textDisplayMode || textDisplayMode,
                time_limit: parseInt(testData.timeLimit || testData.time_limit || 30),
                questions: JSON.stringify(testData.questions),
                created_by: currentUser?.id || null
            };
            
            console.log('Veritabanƒ±na g√∂nderilecek veri:', dbData);
            
            try {
                console.log('Supabase\'e veri g√∂nderiliyor...');
                const { data, error } = await supabase
                    .from('tests')
                    .insert(dbData)
                    .select();
                
                if (error) {
                    console.error('Supabase hatasƒ±:', error);
                    throw error;
                }
                
                console.log('Test ba≈üarƒ±yla kaydedildi:', data);
                showNotification('Test ba≈üarƒ±yla y√ºklendi!', 'success');
                closeModal('uploadTestModal');
                await loadTestsList();
                
                // Clear form
                document.getElementById('testName').value = '';
                document.getElementById('testDescription').value = '';
                document.getElementById('jsonTextArea').value = '';
                document.getElementById('testFile').value = '';
                document.getElementById('selectedFileName').classList.add('hidden');
                document.getElementById('jsonValidationResult').classList.add('hidden');
                
            } catch (error) {
                console.error('Test y√ºkleme hatasƒ±:', error);
                
                // Detailed error message
                let errorMessage = 'Test y√ºklenirken hata olu≈ütu.';
                if (error.message) {
                    errorMessage += ` Detay: ${error.message}`;
                }
                if (error.code) {
                    errorMessage += ` (Kod: ${error.code})`;
                }
                
                showNotification(errorMessage, 'error');
                
                // Show detailed error in console for debugging
                console.log('Hata detaylarƒ±:');
                console.log('- Error message:', error.message);
                console.log('- Error code:', error.code);
                console.log('- Error details:', error.details);
                console.log('- Error hint:', error.hint);
                console.log('- G√∂nderilen veri:', dbData);
            }
        }

        // Add student
        async function addStudent(event) {
            event.preventDefault();
            
            const name = document.getElementById('studentName').value;
            const tc = document.getElementById('studentTCAdd').value;
            const studentNo = document.getElementById('studentNoAdd').value;
            const studentClass = document.getElementById('studentClass').value;
            
            try {
                const { error } = await supabase
                    .from('students')
                    .insert({
                        name: name,
                        tc_no: tc,
                        student_no: studentNo,
                        class: studentClass
                    });
                
                if (error) throw error;
                
                showNotification('√ñƒürenci ba≈üarƒ±yla eklendi!', 'success');
                closeModal('addStudentModal');
                
                // Clear form
                document.getElementById('studentName').value = '';
                document.getElementById('studentTCAdd').value = '';
                document.getElementById('studentNoAdd').value = '';
                document.getElementById('studentClass').value = '';
                
                await loadStudentsList();
                
            } catch (error) {
                console.error('Error adding student:', error);
                if (error.code === '23505') {
                    showNotification('Bu TC kimlik numarasƒ± veya √∂ƒürenci numarasƒ± zaten kayƒ±tlƒ±!', 'error');
                } else {
                    showNotification('√ñƒürenci eklenirken hata olu≈ütu.', 'error');
                }
            }
        }

        // Edit student
        function editStudent(studentId, name, tcNo, studentNo, studentClass) {
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentName').value = name;
            document.getElementById('editStudentTC').value = tcNo;
            document.getElementById('editStudentNo').value = studentNo;
            document.getElementById('editStudentClass').value = studentClass;
            
            document.getElementById('editStudentModal').classList.remove('hidden');
        }

        // Update student
        async function updateStudent(event) {
            event.preventDefault();
            
            const studentId = document.getElementById('editStudentId').value;
            const name = document.getElementById('editStudentName').value;
            const tc = document.getElementById('editStudentTC').value;
            const studentNo = document.getElementById('editStudentNo').value;
            const studentClass = document.getElementById('editStudentClass').value;
            
            try {
                const { error } = await supabase
                    .from('students')
                    .update({
                        name: name,
                        tc_no: tc,
                        student_no: studentNo,
                        class: studentClass
                    })
                    .eq('id', studentId);
                
                if (error) throw error;
                
                showNotification('√ñƒürenci bilgileri ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeModal('editStudentModal');
                await loadStudentsList();
                
            } catch (error) {
                console.error('Error updating student:', error);
                if (error.code === '23505') {
                    showNotification('Bu TC kimlik numarasƒ± veya √∂ƒürenci numarasƒ± ba≈üka bir √∂ƒürenci tarafƒ±ndan kullanƒ±lƒ±yor!', 'error');
                } else {
                    showNotification('√ñƒürenci g√ºncellenirken hata olu≈ütu.', 'error');
                }
            }
        }

        // Global variables for assignment management
        let currentAssignmentTestId = null;
        let currentAssignmentFilter = 'all';

        // Show assignment management modal
        async function showAssignmentModal(testId, testTitle, totalAssignments, completedAssignments) {
            console.log('Opening assignment modal for test:', testId, testTitle);
            
            if (!testId) {
                showNotification('Ge√ßersiz test ID!', 'error');
                return;
            }
            
            currentAssignmentTestId = testId;
            currentAssignmentFilter = 'all';
            
            // Safely update title
            const titleElement = document.getElementById('assignmentTestTitle');
            if (titleElement) {
                titleElement.textContent = `${testTitle} - Atama Y√∂netimi`;
            }
            
            // Show modal
            const modal = document.getElementById('assignmentModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
            
            // Load students with error handling
            try {
                await loadAssignmentStudents();
            } catch (error) {
                console.error('Failed to load assignment students:', error);
                showNotification('Atama verileri y√ºklenemedi. L√ºtfen tekrar deneyin.', 'error');
            }
        }

        // Load students for assignment management
        async function loadAssignmentStudents() {
            console.log('Loading assignment students for test ID:', currentAssignmentTestId);
            
            try {
                // Load students with better error handling
                console.log('Fetching students...');
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (studentsError) {
                    console.error('Students fetch error:', studentsError);
                    throw studentsError;
                }
                console.log('Students loaded:', students?.length || 0);

                // Load assignments with safer query structure
                console.log('Fetching assignments...');
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('test_id', currentAssignmentTestId);

                if (assignmentsError) {
                    console.error('Assignments fetch error:', assignmentsError);
                    throw assignmentsError;
                }
                console.log('Assignments loaded:', assignments?.length || 0);

                // Load test results separately to avoid join issues
                console.log('Fetching test results...');
                const { data: testResults, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('test_id', currentAssignmentTestId);

                if (resultsError) {
                    console.error('Test results fetch error:', resultsError);
                    // Don't throw error for results, just log it
                    console.log('Continuing without test results...');
                }
                console.log('Test results loaded:', testResults?.length || 0);

                const container = document.getElementById('assignmentStudentsList');
                container.innerHTML = '';

                if (!students || students.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">Hen√ºz √∂ƒürenci bulunmuyor.</p>';
                    return;
                }

                let totalStudents = 0;
                let assignedStudents = 0;
                let completedStudents = 0;

                students.forEach(student => {
                    const assignment = assignments?.find(a => a.student_id === student.id);
                    // Find result by matching both student_id and test_id
                    const result = testResults?.find(r => r.student_id === student.id && r.test_id === currentAssignmentTestId);
                    
                    let status, statusColor, statusIcon, actionButton;
                    
                    if (!assignment) {
                        status = 'Atanmamƒ±≈ü';
                        statusColor = 'bg-gray-100 text-gray-600 border-gray-200';
                        statusIcon = '‚ö™';
                        actionButton = `
                            <button onclick="assignToStudent(${student.id})" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition duration-200">
                                üìã Ata
                            </button>
                        `;
                    } else if (!result) {
                        status = 'Bekliyor';
                        statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        statusIcon = 'üü°';
                        assignedStudents++;
                        actionButton = `
                            <button onclick="removeAssignment(${assignment.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-200">
                                üóëÔ∏è Kaldƒ±r
                            </button>
                        `;
                    } else if (result.score >= 70) {
                        status = `Ba≈üarƒ±lƒ± (${result.score})`;
                        statusColor = 'bg-green-100 text-green-800 border-green-200';
                        statusIcon = 'üü¢';
                        assignedStudents++;
                        completedStudents++;
                        actionButton = `
                            <div class="flex space-x-1">
                                <button onclick="reassignToStudent(${student.id})" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition duration-200">
                                    üîÑ Tekrar Ata
                                </button>
                                <button onclick="removeAssignment(${assignment.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-200">
                                    üóëÔ∏è Kaldƒ±r
                                </button>
                            </div>
                        `;
                    } else {
                        status = `D√º≈ü√ºk Puan (${result.score})`;
                        statusColor = 'bg-red-100 text-red-800 border-red-200';
                        statusIcon = 'üî¥';
                        assignedStudents++;
                        completedStudents++;
                        actionButton = `
                            <div class="flex space-x-1">
                                <button onclick="reassignToStudent(${student.id})" class="px-3 py-1 bg-orange-600 text-white text-sm rounded hover:bg-orange-700 transition duration-200">
                                    üîÑ Tekrar Ata
                                </button>
                                <button onclick="removeAssignment(${assignment.id})" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition duration-200">
                                    üóëÔ∏è Kaldƒ±r
                                </button>
                            </div>
                        `;
                    }

                    // Apply filter
                    let shouldShow = true;
                    switch (currentAssignmentFilter) {
                        case 'waiting':
                            // Show only students who have assignment but no result
                            shouldShow = assignment && !result;
                            break;
                        case 'completed':
                            // Show only students who have result with score >= 70
                            shouldShow = result && result.score >= 70;
                            break;
                        case 'failed':
                            // Show only students who have result with score < 70
                            shouldShow = result && result.score < 70;
                            break;
                        case 'not_assigned':
                            // Show only students who don't have assignment
                            shouldShow = !assignment;
                            break;
                        case 'all':
                        default:
                            // Show all students
                            shouldShow = true;
                            break;
                    }

                    if (shouldShow) {
                        const studentDiv = document.createElement('div');
                        studentDiv.className = `student-item bg-white border-2 ${statusColor.split(' ')[2]} rounded-lg p-4 hover:shadow-md transition-all duration-200`;
                        studentDiv.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="flex items-center space-x-3">
                                    <div class="text-2xl">${statusIcon}</div>
                                    <div>
                                        <h5 class="font-semibold text-gray-900">${student.name}</h5>
                                        <div class="text-sm text-gray-600">
                                            <span>No: ${student.student_no}</span>
                                            <span class="ml-3">Sƒ±nƒ±f: ${student.class}</span>
                                        </div>
                                        <div class="mt-1">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full border ${statusColor}">
                                                ${status}
                                            </span>
                                        </div>
                                        ${result ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                <i class="fas fa-clock mr-1"></i>
                                                ${new Date(result.completed_at).toLocaleDateString('tr-TR')}
                                            </div>
                                        ` : assignment ? `
                                            <div class="text-xs text-gray-500 mt-1">
                                                <i class="fas fa-calendar mr-1"></i>
                                                Atanma: ${new Date(assignment.assigned_at).toLocaleDateString('tr-TR')}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="ml-4">
                                    ${actionButton}
                                </div>
                            </div>
                        `;
                        container.appendChild(studentDiv);
                    }

                    totalStudents++;
                });

                // Update statistics
                document.getElementById('assignmentStats').textContent = 
                    `Toplam: ${totalStudents} | Atanmƒ±≈ü: ${assignedStudents} | Tamamlanmƒ±≈ü: ${completedStudents}`;

                // Update filter button states
                updateFilterButtons();

            } catch (error) {
                console.error('Error loading assignment students:', error);
                console.error('Error details:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
                
                // Show detailed error message
                let errorMessage = '√ñƒürenci listesi y√ºklenirken hata olu≈ütu.';
                if (error.message) {
                    errorMessage += ` Detay: ${error.message}`;
                }
                
                showNotification(errorMessage, 'error');
                
                // Show fallback content
                const container = document.getElementById('assignmentStudentsList');
                container.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
                        <p class="text-red-600 mb-3">Veri y√ºklenirken hata olu≈ütu</p>
                        <p class="text-sm text-gray-600 mb-4">${error.message || 'Bilinmeyen hata'}</p>
                        <button onclick="loadAssignmentStudents()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-sync mr-2"></i>Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }

        // Update filter button states
        function updateFilterButtons() {
            const buttons = ['filterAll', 'filterWaiting', 'filterCompleted', 'filterFailed', 'filterNotAssigned'];
            buttons.forEach(buttonId => {
                const button = document.getElementById(buttonId);
                const filterValue = buttonId.replace('filter', '').toLowerCase();
                const isActive = (filterValue === 'all' && currentAssignmentFilter === 'all') ||
                                (filterValue === 'waiting' && currentAssignmentFilter === 'waiting') ||
                                (filterValue === 'completed' && currentAssignmentFilter === 'completed') ||
                                (filterValue === 'failed' && currentAssignmentFilter === 'failed') ||
                                (filterValue === 'notassigned' && currentAssignmentFilter === 'not_assigned');
                
                if (isActive) {
                    button.classList.add('ring-2', 'ring-blue-500', 'font-semibold');
                } else {
                    button.classList.remove('ring-2', 'ring-blue-500', 'font-semibold');
                }
            });
        }

        // Filter assignments
        function filterAssignments(filter) {
            currentAssignmentFilter = filter;
            loadAssignmentStudents();
        }

        // Assign to single student
        async function assignToStudent(studentId) {
            try {
                // Check if already assigned
                const { data: existing } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('test_id', currentAssignmentTestId)
                    .eq('student_id', studentId);

                if (existing && existing.length > 0) {
                    showNotification('Bu √∂ƒürenciye test zaten atanmƒ±≈ü.', 'warning');
                    return;
                }

                const { error } = await supabase
                    .from('test_assignments')
                    .insert({
                        test_id: currentAssignmentTestId,
                        student_id: studentId,
                        assigned_at: new Date().toISOString()
                    });

                if (error) throw error;

                showNotification('Test √∂ƒürenciye atandƒ±!', 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error assigning to student:', error);
                showNotification('Test atanƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Reassign to student (for retakes)
        async function reassignToStudent(studentId) {
            try {
                // Remove existing assignment and result
                const { error: deleteAssignmentError } = await supabase
                    .from('test_assignments')
                    .delete()
                    .eq('test_id', currentAssignmentTestId)
                    .eq('student_id', studentId);

                if (deleteAssignmentError) throw deleteAssignmentError;

                const { error: deleteResultError } = await supabase
                    .from('test_results')
                    .delete()
                    .eq('test_id', currentAssignmentTestId)
                    .eq('student_id', studentId);

                if (deleteResultError) throw deleteResultError;

                // Create new assignment
                const { error: insertError } = await supabase
                    .from('test_assignments')
                    .insert({
                        test_id: currentAssignmentTestId,
                        student_id: studentId,
                        assigned_at: new Date().toISOString()
                    });

                if (insertError) throw insertError;

                showNotification('Test tekrar atandƒ±! √ñƒürenci yeniden √ß√∂zebilir.', 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error reassigning to student:', error);
                showNotification('Test tekrar atanƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Remove assignment
        async function removeAssignment(assignmentId) {
            if (!confirm('Bu atamayƒ± kaldƒ±rmak istediƒüinizden emin misiniz?')) return;

            try {
                const { error } = await supabase
                    .from('test_assignments')
                    .delete()
                    .eq('id', assignmentId);

                if (error) throw error;

                showNotification('Atama kaldƒ±rƒ±ldƒ±!', 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error removing assignment:', error);
                showNotification('Atama kaldƒ±rƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Assign to all students
        async function assignToAllStudents() {
            const confirmAssign = await showAssignmentConfirmDialog({
                title: 'üë• T√ºm √ñƒürencilere Atama',
                message: 'Bu testi t√ºm √∂ƒürencilere atamak istediƒüinizden emin misiniz?',
                warning: '‚ö†Ô∏è UYARI:\n‚Ä¢ Daha √∂nce atanmamƒ±≈ü t√ºm √∂ƒürencilere test atanacak\n‚Ä¢ Zaten atanmƒ±≈ü √∂ƒürenciler etkilenmeyecek\n‚Ä¢ √ñƒürenciler hemen teste ba≈ülayabilecek',
                confirmText: 'Evet, T√ºm √ñƒürencilere Ata',
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmAssign) return;

            try {
                const { data: students } = await supabase.from('students').select('*');
                
                if (!students || students.length === 0) {
                    showNotification('√ñnce √∂ƒürenci eklemelisiniz.', 'error');
                    return;
                }

                // Get existing assignments
                const { data: existingAssignments } = await supabase
                    .from('test_assignments')
                    .select('student_id')
                    .eq('test_id', currentAssignmentTestId);

                const existingStudentIds = existingAssignments?.map(a => a.student_id) || [];
                
                // Create assignments for students who don't have one
                const newAssignments = students
                    .filter(student => !existingStudentIds.includes(student.id))
                    .map(student => ({
                        test_id: currentAssignmentTestId,
                        student_id: student.id,
                        assigned_at: new Date().toISOString()
                    }));

                if (newAssignments.length === 0) {
                    showNotification('T√ºm √∂ƒürencilere zaten atanmƒ±≈ü.', 'info');
                    return;
                }

                const { error } = await supabase
                    .from('test_assignments')
                    .insert(newAssignments);

                if (error) throw error;

                showNotification(`Test ${newAssignments.length} yeni √∂ƒürenciye atandƒ±!`, 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error assigning to all students:', error);
                showNotification('Toplu atama yapƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Assign to class
        async function assignToClass() {
            // First get available classes
            const { data: students } = await supabase.from('students').select('class');
            const availableClasses = [...new Set(students?.map(s => s.class))].sort();
            
            if (availableClasses.length === 0) {
                showNotification('Hen√ºz √∂ƒürenci bulunmuyor.', 'error');
                return;
            }

            const className = await showClassSelectionDialog(availableClasses);
            if (!className) return;

            const confirmAssign = await showAssignmentConfirmDialog({
                title: `üè´ ${className} Sƒ±nƒ±fƒ±na Atama`,
                message: `Bu testi ${className} sƒ±nƒ±fƒ±ndaki √∂ƒürencilere atamak istediƒüinizden emin misiniz?`,
                warning: `‚ö†Ô∏è UYARI:\n‚Ä¢ ${className} sƒ±nƒ±fƒ±ndaki t√ºm √∂ƒürencilere test atanacak\n‚Ä¢ Zaten atanmƒ±≈ü √∂ƒürenciler etkilenmeyecek\n‚Ä¢ √ñƒürenciler hemen teste ba≈ülayabilecek`,
                confirmText: `Evet, ${className} Sƒ±nƒ±fƒ±na Ata`,
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmAssign) return;

            try {
                const { data: classStudents } = await supabase
                    .from('students')
                    .select('*')
                    .eq('class', className);

                if (!classStudents || classStudents.length === 0) {
                    showNotification(`${className} sƒ±nƒ±fƒ±nda √∂ƒürenci bulunamadƒ±.`, 'error');
                    return;
                }

                // Get existing assignments
                const { data: existingAssignments } = await supabase
                    .from('test_assignments')
                    .select('student_id')
                    .eq('test_id', currentAssignmentTestId);

                const existingStudentIds = existingAssignments?.map(a => a.student_id) || [];
                
                // Create assignments for students who don't have one
                const newAssignments = classStudents
                    .filter(student => !existingStudentIds.includes(student.id))
                    .map(student => ({
                        test_id: currentAssignmentTestId,
                        student_id: student.id,
                        assigned_at: new Date().toISOString()
                    }));

                if (newAssignments.length === 0) {
                    showNotification(`${className} sƒ±nƒ±fƒ±ndaki t√ºm √∂ƒürencilere zaten atanmƒ±≈ü.`, 'info');
                    return;
                }

                const { error } = await supabase
                    .from('test_assignments')
                    .insert(newAssignments);

                if (error) throw error;

                showNotification(`Test ${className} sƒ±nƒ±fƒ±ndaki ${newAssignments.length} √∂ƒürenciye atandƒ±!`, 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error assigning to class:', error);
                showNotification('Sƒ±nƒ±fa atama yapƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Remove all assignments
        async function removeAllAssignments() {
            const confirmRemove = await showAssignmentConfirmDialog({
                title: 'üóëÔ∏è T√ºm Atamalarƒ± Kaldƒ±r',
                message: 'Bu testin T√úM atamalarƒ±nƒ± kaldƒ±rmak istediƒüinizden emin misiniz?',
                warning: '‚ö†Ô∏è UYARI:\n‚Ä¢ Bu i≈ülem GERƒ∞ ALINAMAZ!\n‚Ä¢ T√ºm √∂ƒürenci atamalarƒ± silinecek\n‚Ä¢ Test sonu√ßlarƒ± etkilenmeyecek\n‚Ä¢ √ñƒürenciler artƒ±k bu testi g√∂remeyecek',
                confirmText: 'Evet, T√ºm Atamalarƒ± Kaldƒ±r',
                cancelText: 'ƒ∞ptal',
                isDestructive: true
            });

            if (!confirmRemove) return;

            try {
                const { error } = await supabase
                    .from('test_assignments')
                    .delete()
                    .eq('test_id', currentAssignmentTestId);

                if (error) throw error;

                showNotification('T√ºm atamalar kaldƒ±rƒ±ldƒ±!', 'success');
                await loadAssignmentStudents();

            } catch (error) {
                console.error('Error removing all assignments:', error);
                showNotification('Atamalar kaldƒ±rƒ±lƒ±rken hata olu≈ütu.', 'error');
            }
        }

        // Refresh assignments
        async function refreshAssignments() {
            await loadAssignmentStudents();
            showNotification('Liste yenilendi!', 'info');
        }

        // Delete test with enhanced confirmation dialog
        async function deleteTest(testId) {
            // Create custom confirmation modal
            const confirmDelete = await showDeleteConfirmDialog({
                title: 'üóëÔ∏è Test Silme Onayƒ±',
                message: 'Bu testi silmek istediƒüinizden emin misiniz?',
                warning: '‚ö†Ô∏è UYARI:\n‚Ä¢ Bu i≈ülem geri alƒ±namaz\n‚Ä¢ Test ile ilgili t√ºm atamalar silinecek\n‚Ä¢ √ñƒürenci sonu√ßlarƒ± da silinecek',
                confirmText: 'Evet, Sil',
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmDelete) return;
            
            try {
                const { error } = await supabase
                    .from('tests')
                    .delete()
                    .eq('id', testId);
                
                if (error) throw error;
                
                showNotification('Test ba≈üarƒ±yla silindi!', 'success');
                await loadTestsList();
                
            } catch (error) {
                console.error('Error deleting test:', error);
                showNotification('Test silinirken hata olu≈ütu.', 'error');
            }
        }

        // Delete student with enhanced confirmation dialog
        async function deleteStudent(studentId) {
            // Create custom confirmation modal
            const confirmDelete = await showDeleteConfirmDialog({
                title: 'üóëÔ∏è √ñƒürenci Silme Onayƒ±',
                message: 'Bu √∂ƒürenciyi silmek istediƒüinizden emin misiniz?',
                warning: '‚ö†Ô∏è UYARI:\n‚Ä¢ Bu i≈ülem geri alƒ±namaz\n‚Ä¢ √ñƒürencinin t√ºm test sonu√ßlarƒ± silinecek\n‚Ä¢ T√ºm atamalarƒ± kaldƒ±rƒ±lacak',
                confirmText: 'Evet, Sil',
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmDelete) return;
            
            try {
                const { error } = await supabase
                    .from('students')
                    .delete()
                    .eq('id', studentId);
                
                if (error) throw error;
                
                showNotification('√ñƒürenci ba≈üarƒ±yla silindi!', 'success');
                await loadStudentsList();
                
            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification('√ñƒürenci silinirken hata olu≈ütu.', 'error');
            }
        }

        // Enhanced delete confirmation dialog
        function showDeleteConfirmDialog({ title, message, warning, confirmText, cancelText }) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm text-blue-800">${message}</div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm text-red-800 whitespace-pre-line">${warning}</div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="handleDeleteResponse(false)" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 font-semibold">
                                ${cancelText}
                            </button>
                            <button onclick="handleDeleteResponse(true)" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300 font-semibold">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                
                // Add response handler to window temporarily
                window.handleDeleteResponse = (response) => {
                    modal.remove();
                    delete window.handleDeleteResponse;
                    resolve(response);
                };
                
                document.body.appendChild(modal);
                
                // Auto-focus on cancel button for safety
                setTimeout(() => {
                    const cancelBtn = modal.querySelector('button:first-child');
                    if (cancelBtn) cancelBtn.focus();
                }, 100);
            });
        }

        // Assignment confirmation dialog
        function showAssignmentConfirmDialog({ title, message, warning, confirmText, cancelText, isDestructive = false }) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm text-blue-800">${message}</div>
                            </div>
                            
                            <div class="${isDestructive ? 'bg-red-50 border-red-200' : 'bg-yellow-50 border-yellow-200'} border rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm ${isDestructive ? 'text-red-800' : 'text-yellow-800'} whitespace-pre-line">${warning}</div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="handleAssignmentResponse(false)" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 font-semibold">
                                ${cancelText}
                            </button>
                            <button onclick="handleAssignmentResponse(true)" class="flex-1 px-6 py-3 ${isDestructive ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg transition duration-300 font-semibold">
                                ${confirmText}
                            </button>
                        </div>
                    </div>
                `;
                
                // Add response handler to window temporarily
                window.handleAssignmentResponse = (response) => {
                    modal.remove();
                    delete window.handleAssignmentResponse;
                    resolve(response);
                };
                
                document.body.appendChild(modal);
                
                // Auto-focus on cancel button for safety
                setTimeout(() => {
                    const cancelBtn = modal.querySelector('button:first-child');
                    if (cancelBtn) cancelBtn.focus();
                }, 100);
            });
        }

        // Class selection dialog
        function showClassSelectionDialog(availableClasses) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">üè´ Sƒ±nƒ±f Se√ßimi</h3>
                            <p class="text-gray-600 mb-4">Hangi sƒ±nƒ±fa test atamak istiyorsunuz?</p>
                            
                            <div class="space-y-2">
                                ${availableClasses.map(className => `
                                    <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                                        <input type="radio" name="selectedClass" value="${className}" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                        <span class="ml-3 text-gray-900 font-medium">${className}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="handleClassSelection(null)" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 font-semibold">
                                ƒ∞ptal
                            </button>
                            <button onclick="handleClassSelection(getSelectedClass())" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                                Se√ß
                            </button>
                        </div>
                    </div>
                `;
                
                // Add helper functions to window temporarily
                window.getSelectedClass = () => {
                    const selected = modal.querySelector('input[name="selectedClass"]:checked');
                    return selected ? selected.value : null;
                };
                
                window.handleClassSelection = (selectedClass) => {
                    modal.remove();
                    delete window.getSelectedClass;
                    delete window.handleClassSelection;
                    resolve(selectedClass);
                };
                
                document.body.appendChild(modal);
                
                // Auto-focus on first radio button
                setTimeout(() => {
                    const firstRadio = modal.querySelector('input[type="radio"]');
                    if (firstRadio) firstRadio.focus();
                }, 100);
            });
        }

        // Logout
        function logout() {
            // Show logout confirmation with remember me option
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
                    <div class="mb-6">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center">
                            <i class="fas fa-sign-out-alt text-2xl text-blue-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">√áƒ±kƒ±≈ü Yapƒ±yor Musunuz?</h3>
                        <p class="text-gray-600 mb-4">Oturumunuz sonlandƒ±rƒ±lacak.</p>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="forgetCredentials" class="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                <label for="forgetCredentials" class="ml-2 block text-sm text-yellow-800">
                                    <i class="fas fa-trash mr-1"></i>
                                    Hatƒ±rlanan giri≈ü bilgilerimi sil
                                </label>
                            </div>
                            <p class="text-xs text-yellow-700 mt-1 ml-6">
                                Bu se√ßeneƒüi i≈üaretlerseniz bir dahaki sefere bilgilerinizi tekrar girmeniz gerekecek.
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="cancelLogout()" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 font-semibold">
                            ƒ∞ptal
                        </button>
                        <button onclick="confirmLogout()" class="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300 font-semibold">
                            √áƒ±kƒ±≈ü Yap
                        </button>
                    </div>
                </div>
            `;
            
            // Add logout handlers to window temporarily
            window.cancelLogout = () => {
                modal.remove();
                delete window.cancelLogout;
                delete window.confirmLogout;
            };
            
            window.confirmLogout = () => {
                const forgetCredentials = document.getElementById('forgetCredentials').checked;
                
                if (forgetCredentials) {
                    // Clear all remembered credentials
                    clearRememberedCredentials('student');
                    clearRememberedCredentials('teacher');
                    showNotification('Hatƒ±rlanan giri≈ü bilgileri silindi! üóëÔ∏è', 'info');
                }
                
                // Perform logout
                currentUser = null;
                currentTest = null;
                if (testTimer) clearInterval(testTimer);
                
                modal.remove();
                delete window.cancelLogout;
                delete window.confirmLogout;
                
                showMainLogin();
                showNotification('Ba≈üarƒ±yla √ßƒ±kƒ±≈ü yaptƒ±nƒ±z! üëã', 'success');
            };
            
            document.body.appendChild(modal);
        }

        // Show badge notification
        function showBadgeNotification(badgeName) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-8 rounded-2xl shadow-2xl text-center badge-new';
            notification.innerHTML = `
                <div class="text-6xl mb-4">${badgeName.split(' ')[0]}</div>
                <h3 class="text-2xl font-bold mb-2">Yeni Rozet Kazandƒ±n!</h3>
                <p class="text-lg">${badgeName}</p>
                <div class="mt-4">
                    <i class="fas fa-sparkles text-2xl animate-pulse"></i>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translate(-50%, -50%) scale(0.5)';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // Mobile-friendly confirmation dialog
        function showMobileConfirmDialog({ title, message, warning, question }) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 text-center">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">${title}</h3>
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm text-blue-800 whitespace-pre-line">${message}</div>
                            </div>
                            
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 text-left">
                                <div class="text-sm text-red-800 whitespace-pre-line">${warning}</div>
                            </div>
                            
                            <p class="text-gray-700 font-medium">${question}</p>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="handleConfirmResponse(false)" class="flex-1 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-300 font-semibold">
                                ƒ∞ptal
                            </button>
                            <button onclick="handleConfirmResponse(true)" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                                Teste Ba≈üla
                            </button>
                        </div>
                    </div>
                `;
                
                // Add response handler to window temporarily
                window.handleConfirmResponse = (response) => {
                    modal.remove();
                    delete window.handleConfirmResponse;
                    resolve(response);
                };
                
                document.body.appendChild(modal);
                
                // Auto-focus on confirm button for better UX
                setTimeout(() => {
                    const confirmBtn = modal.querySelector('button:last-child');
                    if (confirmBtn) confirmBtn.focus();
                }, 100);
            });
        }

        // Show retake message for failed tests
        function showRetakeMessage() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 text-center">
                    <div class="mb-6">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-red-100 flex items-center justify-center">
                            <i class="fas fa-lock text-3xl text-red-600"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">Test Tamamlandƒ±</h3>
                        <p class="text-gray-600">Bu testi zaten √ß√∂zd√ºn√ºz ve d√º≈ü√ºk puan aldƒ±nƒ±z.</p>
                    </div>
                    
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-triangle text-red-600 mr-3 mt-1"></i>
                            <div class="text-left">
                                <h4 class="font-semibold text-red-800 mb-1">Tekrar √á√∂zme Ko≈üullarƒ±</h4>
                                <ul class="text-sm text-red-700 space-y-1">
                                    <li>‚Ä¢ Her test sadece 1 kez √ß√∂z√ºlebilir</li>
                                    <li>‚Ä¢ D√º≈ü√ºk puan aldƒ±ƒüƒ±nƒ±z testler i√ßin √∂ƒüretmeninizin yeniden atama yapmasƒ± gerekir</li>
                                    <li>‚Ä¢ √ñƒüretmeniniz size tekrar ≈üans verirse test yeniden g√∂r√ºnecektir</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            <strong>ƒ∞pucu:</strong> Diƒüer testleri √ß√∂zerek kendinizi geli≈ütirebilirsiniz!
                        </div>
                        
                        <button onclick="this.closest('.fixed').remove()" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                            Anladƒ±m
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.remove();
                }
            }, 10000);
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white max-w-sm ${
                type === 'success' ? 'bg-green-600' : 
                type === 'error' ? 'bg-red-600' : 
                type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Filter tests based on search and filter criteria
        function filterTests() {
            currentTestSearch = document.getElementById('testSearchInput')?.value.toLowerCase().trim() || '';
            const sortBy = document.getElementById('testSortSelect')?.value || 'newest';
            
            let filteredTests = [...allTestsData];

            // Apply search filter
            if (currentTestSearch) {
                filteredTests = filteredTests.filter(test => 
                    test.title.toLowerCase().includes(currentTestSearch) ||
                    (test.description && test.description.toLowerCase().includes(currentTestSearch))
                );
            }

            // Apply category filter
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

            switch (currentTestFilter) {
                case 'recent':
                    filteredTests = filteredTests.filter(test => 
                        new Date(test.created_at) >= sevenDaysAgo
                    );
                    break;
                case 'active':
                    filteredTests = filteredTests.filter(test => 
                        test.totalAssignments > 0 && test.completedAssignments < test.totalAssignments
                    );
                    break;
                case 'completed':
                    filteredTests = filteredTests.filter(test => 
                        test.totalAssignments > 0 && test.completedAssignments === test.totalAssignments
                    );
                    break;
                case 'no_assignments':
                    filteredTests = filteredTests.filter(test => 
                        test.totalAssignments === 0
                    );
                    break;
                case 'all':
                default:
                    // No additional filtering
                    break;
            }

            // Apply sorting
            switch (sortBy) {
                case 'oldest':
                    filteredTests.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    break;
                case 'name_asc':
                    filteredTests.sort((a, b) => a.title.localeCompare(b.title, 'tr'));
                    break;
                case 'name_desc':
                    filteredTests.sort((a, b) => b.title.localeCompare(a.title, 'tr'));
                    break;
                case 'most_assigned':
                    filteredTests.sort((a, b) => b.totalAssignments - a.totalAssignments);
                    break;
                case 'least_assigned':
                    filteredTests.sort((a, b) => a.totalAssignments - b.totalAssignments);
                    break;
                case 'newest':
                default:
                    filteredTests.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }

            displayFilteredTests(filteredTests);
        }

        // Set test filter
        function setTestFilter(filter) {
            currentTestFilter = filter;
            
            // Update button states
            const buttons = document.querySelectorAll('.test-filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-green-100', 'text-green-800', 'border-green-200', 'font-medium');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-200');
            });
            
            const activeButton = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1).replace('_', '')}Tests`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-200');
                activeButton.classList.add('bg-green-100', 'text-green-800', 'border-green-200', 'font-medium');
            }
            
            filterTests();
        }

        // Clear all filters
        function clearTestFilters() {
            currentTestFilter = 'all';
            currentTestSearch = '';
            
            document.getElementById('testSearchInput').value = '';
            document.getElementById('testSortSelect').value = 'newest';
            
            setTestFilter('all');
        }

        // Update filter info
        function updateTestFilterInfo(filteredCount) {
            const totalCount = allTestsData.length;
            const infoElement = document.getElementById('testFilterInfo');
            
            if (!infoElement) return;
            
            let infoText = '';
            
            if (currentTestSearch && currentTestFilter !== 'all') {
                infoText = `"${currentTestSearch}" aramasƒ± ve ${getFilterDisplayName(currentTestFilter)} filtresi: ${filteredCount}/${totalCount} test`;
            } else if (currentTestSearch) {
                infoText = `"${currentTestSearch}" aramasƒ±: ${filteredCount}/${totalCount} test`;
            } else if (currentTestFilter !== 'all') {
                infoText = `${getFilterDisplayName(currentTestFilter)} filtresi: ${filteredCount}/${totalCount} test`;
            } else {
                infoText = `T√ºm testler g√∂steriliyor: ${filteredCount} test`;
            }
            
            infoElement.textContent = infoText;
        }

        // Get filter display name
        function getFilterDisplayName(filter) {
            const names = {
                'recent': 'Son Eklenenler',
                'active': 'Aktif Testler',
                'completed': 'Tamamlananlar',
                'no_assignments': 'Atanmamƒ±≈ü Testler'
            };
            return names[filter] || filter;
        }

        // Global variable for current test data being edited
        let currentTestData = null;

        // Preview test function
        function previewTest() {
            const testData = getTestDataFromForm();
            if (!testData) return;

            currentTestData = testData;
            displayTestPreview(testData);
            document.getElementById('testPreviewModal').classList.remove('hidden');
        }

        // Edit test function
        function editTest() {
            const testData = getTestDataFromForm();
            if (!testData) return;

            currentTestData = testData;
            populateEditForm(testData);
            document.getElementById('testEditModal').classList.remove('hidden');
        }

        // Edit from preview
        function editFromPreview() {
            closeModal('testPreviewModal');
            populateEditForm(currentTestData);
            document.getElementById('testEditModal').classList.remove('hidden');
        }

        // Get test data from upload form
        function getTestDataFromForm() {
            const name = document.getElementById('testName').value.trim();
            const description = document.getElementById('testDescription').value.trim();

            if (!name) {
                showNotification('Test adƒ± bo≈ü olamaz!', 'error');
                return null;
            }

            let testData;
            const pasteContent = document.getElementById('pasteUploadContent');
            
            if (!pasteContent.classList.contains('hidden')) {
                // Paste tab is active
                const jsonText = document.getElementById('jsonTextArea').value.trim();
                if (!jsonText) {
                    showNotification('L√ºtfen JSON kodunu yapƒ±≈ütƒ±rƒ±n.', 'error');
                    return null;
                }

                try {
                    testData = JSON.parse(jsonText);
                } catch (error) {
                    showNotification(`Ge√ßersiz JSON formatƒ±: ${error.message}`, 'error');
                    return null;
                }
            } else {
                // File tab is active
                const file = document.getElementById('testFile').files[0];
                if (!file) {
                    showNotification('L√ºtfen bir JSON dosyasƒ± se√ßin veya JSON kodunu yapƒ±≈ütƒ±rƒ±n.', 'error');
                    return null;
                }

                showNotification('Dosya √∂nizlemesi i√ßin JSON kodunu yapƒ±≈ütƒ±rma sekmesini kullanƒ±n.', 'info');
                return null;
            }

            // Validate test structure
            const validation = validateTestStructure(testData);
            if (!validation.isValid) {
                showNotification(`Test yapƒ±sƒ± ge√ßersiz: ${validation.errors.join(', ')}`, 'error');
                return null;
            }

            // Merge form data with JSON data
            return {
                title: name,
                description: description || testData.description || '',
                readingText: testData.readingText || testData.reading_text || '',
                timeLimit: parseInt(testData.timeLimit || testData.time_limit || 30),
                questions: testData.questions || []
            };
        }

        // Display test preview
        function displayTestPreview(testData) {
            document.getElementById('previewTitle').textContent = testData.title;
            document.getElementById('previewDescription').textContent = testData.description || 'A√ßƒ±klama bulunmuyor';
            document.getElementById('previewTimeLimit').textContent = testData.timeLimit;
            
            // Calculate and display total points
            const totalPoints = testData.questions.reduce((sum, q) => sum + (q.points || 5), 0);
            document.getElementById('previewQuestionCount').innerHTML = `${testData.questions.length}<br><small class="text-sm text-purple-500">${totalPoints} toplam puan</small>`;
            
            document.getElementById('previewReadingText').textContent = testData.readingText;

            const questionsContainer = document.getElementById('previewQuestions');
            questionsContainer.innerHTML = '';

            testData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                
                let questionTypeText = '';
                let questionTypeColor = '';
                let optionsHtml = '';

                switch (question.type) {
                    case 'multiple_choice':
                        questionTypeText = '√áoktan Se√ßmeli';
                        questionTypeColor = 'bg-blue-100 text-blue-800';
                        optionsHtml = question.options.map((option, i) => 
                            `<div class="flex items-center space-x-2 ${i === question.correct ? 'font-semibold text-green-700' : ''}">
                                <span class="w-6 h-6 rounded-full border-2 ${i === question.correct ? 'bg-green-500 border-green-500' : 'border-gray-300'} flex items-center justify-center text-xs text-white">
                                    ${String.fromCharCode(65 + i)}
                                </span>
                                <span>${option.replace(/^[A-C]\)\s*/, '')}</span>
                                ${i === question.correct ? '<i class="fas fa-check text-green-600 ml-2"></i>' : ''}
                            </div>`
                        ).join('');
                        break;
                    case 'fill_blank':
                        questionTypeText = 'Bo≈üluk Doldurma';
                        questionTypeColor = 'bg-yellow-100 text-yellow-800';
                        optionsHtml = `
                            <div class="bg-white p-3 rounded border">
                                <p class="mb-2"><strong>Doƒüru Cevap:</strong> <span class="text-green-700 font-semibold">${question.correct}</span></p>
                                ${question.options ? `<p><strong>Se√ßenekler:</strong> ${question.options.join(', ')}</p>` : ''}
                            </div>
                        `;
                        break;
                    case 'true_false':
                        questionTypeText = 'Doƒüru/Yanlƒ±≈ü';
                        questionTypeColor = 'bg-green-100 text-green-800';
                        optionsHtml = `
                            <div class="flex space-x-4">
                                <div class="flex items-center space-x-2 ${question.correct ? 'font-semibold text-green-700' : ''}">
                                    <div class="w-8 h-8 rounded-full ${question.correct ? 'bg-green-500' : 'bg-gray-300'} flex items-center justify-center">
                                        <i class="fas fa-check text-white text-sm"></i>
                                    </div>
                                    <span>DOƒûRU</span>
                                    ${question.correct ? '<i class="fas fa-check text-green-600 ml-2"></i>' : ''}
                                </div>
                                <div class="flex items-center space-x-2 ${!question.correct ? 'font-semibold text-green-700' : ''}">
                                    <div class="w-8 h-8 rounded-full ${!question.correct ? 'bg-red-500' : 'bg-gray-300'} flex items-center justify-center">
                                        <i class="fas fa-times text-white text-sm"></i>
                                    </div>
                                    <span>YANLI≈û</span>
                                    ${!question.correct ? '<i class="fas fa-check text-green-600 ml-2"></i>' : ''}
                                </div>
                            </div>
                        `;
                        break;
                }

                questionDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center space-x-3">
                            <h5 class="font-semibold text-gray-900">Soru ${index + 1}</h5>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${questionTypeColor}">
                                ${questionTypeText}
                            </span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                                ${question.points || 5} puan
                            </span>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700">
                                ${question.timeLimit || 75}s
                            </span>
                        </div>
                    </div>
                    <p class="text-gray-800 mb-4 font-medium">${question.question}</p>
                    <div class="space-y-2">
                        ${optionsHtml}
                    </div>
                `;

                questionsContainer.appendChild(questionDiv);
            });
        }

        // Populate edit form
        function populateEditForm(testData) {
            document.getElementById('editTestName').value = testData.title;
            document.getElementById('editTestDescription').value = testData.description || '';
            document.getElementById('editTimeLimit').value = testData.timeLimit;
            document.getElementById('editReadingText').value = testData.readingText;

            const questionsEditor = document.getElementById('questionsEditor');
            questionsEditor.innerHTML = '';

            testData.questions.forEach((question, index) => {
                addQuestionToEditor(question, index);
            });
        }

        // Add question to editor
        function addQuestionToEditor(question = null, index = null) {
            const questionsEditor = document.getElementById('questionsEditor');
            const questionIndex = index !== null ? index : questionsEditor.children.length;
            
            const questionDiv = document.createElement('div');
            questionDiv.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
            questionDiv.dataset.questionIndex = questionIndex;

            const questionType = question?.type || 'multiple_choice';
            const questionText = question?.question || '';
            const questionOptions = question?.options || ['', '', ''];
            const questionCorrect = question?.correct !== undefined ? question.correct : 0;

            questionDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h5 class="font-semibold text-gray-900">Soru ${questionIndex + 1}</h5>
                    <div class="flex space-x-2">
                        <select onchange="changeQuestionType(${questionIndex}, this.value)" class="px-3 py-1 text-sm border border-gray-300 rounded">
                            <option value="multiple_choice" ${questionType === 'multiple_choice' ? 'selected' : ''}>√áoktan Se√ßmeli</option>
                            <option value="fill_blank" ${questionType === 'fill_blank' ? 'selected' : ''}>Bo≈üluk Doldurma</option>
                            <option value="true_false" ${questionType === 'true_false' ? 'selected' : ''}>Doƒüru/Yanlƒ±≈ü</option>
                        </select>
                        <button type="button" onclick="removeQuestion(${questionIndex})" class="px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Soru Metni</label>
                    <textarea rows="2" class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" required>${questionText}</textarea>
                </div>

                <!-- Question Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Puan Deƒüeri</label>
                        <input type="number" min="1" max="20" value="${question?.points || 5}" 
                               class="question-points w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                               placeholder="5">
                        <p class="text-xs text-gray-500 mt-1">1-20 arasƒ± puan deƒüeri</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">S√ºre Limiti (saniye)</label>
                        <input type="number" min="30" max="300" value="${question?.timeLimit || 75}" 
                               class="question-time-limit w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                               placeholder="75">
                        <p class="text-xs text-gray-500 mt-1">30-300 saniye arasƒ±</p>
                    </div>
                </div>

                <div class="question-options-container">
                    ${generateQuestionOptionsEditor(questionType, questionOptions, questionCorrect)}
                </div>
            `;

            questionsEditor.appendChild(questionDiv);
        }

        // Generate question options editor based on type
        function generateQuestionOptionsEditor(type, options, correct) {
            switch (type) {
                case 'multiple_choice':
                    return `
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Se√ßenekler</label>
                            ${options.slice(0, 3).map((option, i) => `
                                <div class="flex items-center space-x-3">
                                    <input type="radio" name="correct_${Date.now()}_${Math.random()}" value="${i}" ${i === correct ? 'checked' : ''} class="correct-answer">
                                    <span class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center font-semibold text-sm">
                                        ${String.fromCharCode(65 + i)}
                                    </span>
                                    <input type="text" class="option-text flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                           placeholder="Se√ßenek ${String.fromCharCode(65 + i)}" value="${option.replace(/^[A-C]\)\s*/, '')}" required>
                                </div>
                            `).join('')}
                            <p class="text-xs text-gray-600">Doƒüru cevabƒ± se√ßmek i√ßin sol taraftaki radio butonlarƒ± kullanƒ±n.</p>
                        </div>
                    `;
                case 'fill_blank':
                    return `
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Doƒüru Cevap</label>
                                <input type="text" class="correct-answer w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                       value="${typeof correct === 'string' ? correct : ''}" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Se√ßenekler (virg√ºlle ayƒ±rƒ±n)</label>
                                <input type="text" class="question-options w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                       value="${Array.isArray(options) ? options.join(', ') : ''}" placeholder="se√ßenek1, se√ßenek2, se√ßenek3">
                            </div>
                        </div>
                    `;
                case 'true_false':
                    return `
                        <div class="space-y-3">
                            <label class="block text-sm font-medium text-gray-700">Doƒüru Cevap</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="tf_correct_${Date.now()}_${Math.random()}" value="true" ${correct === true ? 'checked' : ''} class="correct-answer">
                                    <span class="text-green-700 font-semibold">DOƒûRU</span>
                                </label>
                                <label class="flex items-center space-x-2">
                                    <input type="radio" name="tf_correct_${Date.now()}_${Math.random()}" value="false" ${correct === false ? 'checked' : ''} class="correct-answer">
                                    <span class="text-red-700 font-semibold">YANLI≈û</span>
                                </label>
                            </div>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Change question type
        function changeQuestionType(questionIndex, newType) {
            const questionDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
            const optionsContainer = questionDiv.querySelector('.question-options-container');
            
            // Reset options based on new type
            let options, correct;
            switch (newType) {
                case 'multiple_choice':
                    options = ['', '', ''];
                    correct = 0;
                    break;
                case 'fill_blank':
                    options = [];
                    correct = '';
                    break;
                case 'true_false':
                    options = [];
                    correct = true;
                    break;
            }
            
            optionsContainer.innerHTML = generateQuestionOptionsEditor(newType, options, correct);
        }

        // Add new question
        function addNewQuestion() {
            addQuestionToEditor();
        }

        // Remove question
        function removeQuestion(questionIndex) {
            if (!confirm('Bu soruyu silmek istediƒüinizden emin misiniz?')) return;
            
            const questionDiv = document.querySelector(`[data-question-index="${questionIndex}"]`);
            questionDiv.remove();
            
            // Reindex remaining questions
            const questionsEditor = document.getElementById('questionsEditor');
            Array.from(questionsEditor.children).forEach((div, index) => {
                div.dataset.questionIndex = index;
                div.querySelector('h5').textContent = `Soru ${index + 1}`;
                
                // Update remove button onclick
                const removeBtn = div.querySelector('button[onclick*="removeQuestion"]');
                removeBtn.setAttribute('onclick', `removeQuestion(${index})`);
                
                // Update change type select
                const typeSelect = div.querySelector('select[onchange*="changeQuestionType"]');
                typeSelect.setAttribute('onchange', `changeQuestionType(${index}, this.value)`);
            });
        }

        // Preview edited test
        function previewEditedTest() {
            const testData = getEditedTestData();
            if (!testData) return;

            currentTestData = testData;
            displayTestPreview(testData);
            closeModal('testEditModal');
            document.getElementById('testPreviewModal').classList.remove('hidden');
        }

        // Get edited test data
        function getEditedTestData() {
            const title = document.getElementById('editTestName').value.trim();
            const description = document.getElementById('editTestDescription').value.trim();
            const timeLimit = parseInt(document.getElementById('editTimeLimit').value);
            const readingText = document.getElementById('editReadingText').value.trim();

            if (!title || !readingText || !timeLimit) {
                showNotification('L√ºtfen t√ºm gerekli alanlarƒ± doldurun.', 'error');
                return null;
            }

            const questions = [];
            const questionDivs = document.querySelectorAll('#questionsEditor > div');

            for (let i = 0; i < questionDivs.length; i++) {
                const questionDiv = questionDivs[i];
                const questionText = questionDiv.querySelector('.question-text').value.trim();
                const typeSelect = questionDiv.querySelector('select');
                const questionType = typeSelect.value;

                if (!questionText) {
                    showNotification(`Soru ${i + 1} metni bo≈ü olamaz.`, 'error');
                    return null;
                }

                const question = {
                    type: questionType,
                    question: questionText
                };

                // Get question settings (points and time limit)
                const pointsInput = questionDiv.querySelector('.question-points');
                const timeLimitInput = questionDiv.querySelector('.question-time-limit');
                
                question.points = pointsInput ? parseInt(pointsInput.value) || 5 : 5;
                question.timeLimit = timeLimitInput ? parseInt(timeLimitInput.value) || 75 : 75;

                // Get type-specific data
                switch (questionType) {
                    case 'multiple_choice':
                        const optionInputs = questionDiv.querySelectorAll('.option-text');
                        const correctRadio = questionDiv.querySelector('.correct-answer:checked');
                        
                        question.options = Array.from(optionInputs).map(input => input.value.trim());
                        question.correct = correctRadio ? parseInt(correctRadio.value) : 0;
                        
                        if (question.options.some(opt => !opt)) {
                            showNotification(`Soru ${i + 1} se√ßenekleri bo≈ü olamaz.`, 'error');
                            return null;
                        }
                        break;
                        
                    case 'fill_blank':
                        const correctInput = questionDiv.querySelector('.correct-answer');
                        const optionsInput = questionDiv.querySelector('.question-options');
                        
                        question.correct = correctInput.value.trim();
                        question.options = optionsInput.value.trim() ? 
                            optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt) : 
                            [question.correct];
                        
                        if (!question.correct) {
                            showNotification(`Soru ${i + 1} doƒüru cevabƒ± bo≈ü olamaz.`, 'error');
                            return null;
                        }
                        break;
                        
                    case 'true_false':
                        const tfRadio = questionDiv.querySelector('.correct-answer:checked');
                        question.correct = tfRadio ? tfRadio.value === 'true' : true;
                        break;
                }

                questions.push(question);
            }

            if (questions.length === 0) {
                showNotification('En az bir soru eklemelisiniz.', 'error');
                return null;
            }

            return {
                title,
                description,
                timeLimit,
                readingText,
                questions
            };
        }

        // Save edited test
        function saveEditedTest(event) {
            event.preventDefault();
            
            const testData = getEditedTestData();
            if (!testData) return;

            // Update the upload form with edited data
            document.getElementById('testName').value = testData.title;
            document.getElementById('testDescription').value = testData.description;
            
            // Update JSON textarea
            const jsonData = {
                title: testData.title,
                description: testData.description,
                readingText: testData.readingText,
                timeLimit: testData.timeLimit,
                questions: testData.questions
            };
            
            document.getElementById('jsonTextArea').value = JSON.stringify(jsonData, null, 2);
            
            // Switch to paste tab if not already active
            switchUploadTab('paste');
            
            closeModal('testEditModal');
            showNotification('Test d√ºzenlemeleri kaydedildi! Artƒ±k y√ºkleyebilirsiniz.', 'success');
        }

        // Set student test filter
        function setStudentTestFilter(filter) {
            currentStudentTestFilter = filter;
            
            // Update button states
            const buttons = document.querySelectorAll('.student-test-filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-100', 'text-blue-800', 'border-blue-200', 'font-medium');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-200');
            });
            
            const activeButton = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1).replace('_', '')}StudentTests`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-200');
                activeButton.classList.add('bg-blue-100', 'text-blue-800', 'border-blue-200', 'font-medium');
            }
            
            // Apply filter
            filterStudentTests();
        }

        // Clear student test filters
        function clearStudentTestFilters() {
            setStudentTestFilter('all');
        }

        // Update student test filter info
        function updateStudentTestFilterInfo(filteredCount, totalCount) {
            const infoElement = document.getElementById('studentTestFilterInfo');
            if (!infoElement) return;
            
            let infoText = '';
            
            switch (currentStudentTestFilter) {
                case 'waiting':
                    infoText = `üü° Bekleyen testler: ${filteredCount}/${totalCount}`;
                    break;
                case 'successful':
                    infoText = `üü¢ Ba≈üarƒ±lƒ± testler: ${filteredCount}/${totalCount}`;
                    break;
                case 'low_score':
                    infoText = `üî¥ D√º≈ü√ºk puan alan testler: ${filteredCount}/${totalCount}`;
                    break;
                case 'all':
                default:
                    infoText = `T√ºm testler g√∂steriliyor: ${filteredCount} test`;
                    break;
            }
            
            infoElement.textContent = infoText;
        }

        // Refresh student tests
        async function refreshStudentTests() {
            try {
                showNotification('Testler yenileniyor...', 'info');
                await loadStudentData();
                showNotification('Testler ba≈üarƒ±yla yenilendi!', 'success');
            } catch (error) {
                console.error('Error refreshing student tests:', error);
                showNotification('Testler yenilenirken hata olu≈ütu.', 'error');
            }
        }

        // Initialize tabs
        document.addEventListener('DOMContentLoaded', function() {
            showTab('tests');
            showTeacherTab('dashboard');
        });

        // ============================================
        // YEDEKLEME FONKSƒ∞YONLARI
        // ============================================

        // T√ºm verileri yedekleme fonksiyonu
        async function backupAllData() {
            const confirmBackup = await showAssignmentConfirmDialog({
                title: 'üì• T√ºm Verileri Yedekle',
                message: 'Sistemdeki t√ºm verileri JSON formatƒ±nda yedeklemek istediƒüinizden emin misiniz?',
                warning: '‚ö†Ô∏è UYARI:\n‚Ä¢ Bu i≈ülem t√ºm tablolarƒ± (√∂ƒüretmenler, √∂ƒürenciler, testler, atamalar, sonu√ßlar, rozetler) i√ßerecektir.\n‚Ä¢ ƒ∞≈ülem, veri miktarƒ±na baƒülƒ± olarak biraz zaman alabilir.',
                confirmText: 'Evet, Yedekle',
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmBackup) {
                showNotification('Yedekleme i≈ülemi iptal edildi.', 'info');
                return;
            }

            showNotification('Yedekleme i≈ülemi ba≈ülatƒ±ldƒ±, l√ºtfen bekleyin...', 'info');

            try {
                const tablesToBackup = [
                    'teachers',
                    'students',
                    'tests',
                    'test_assignments',
                    'test_results',
                    'student_badges'
                ];

                const backupData = {
                    backup_date: new Date().toISOString(),
                    backup_version: '1.0',
                    system_name: 'T√ºrk√ße Okuma Anlama Test Sistemi',
                    tables: {}
                };
                
                let hasError = false;
                let totalRecords = 0;

                for (const tableName of tablesToBackup) {
                    try {
                        const { data, error } = await supabase.from(tableName).select('*');
                        if (error) {
                            console.error(`'${tableName}' tablosu yedeklenirken hata olu≈ütu:`, error);
                            showNotification(`'${tableName}' tablosu yedeklenemedi.`, 'error');
                            hasError = true;
                            continue;
                        }
                        backupData.tables[tableName] = data;
                        totalRecords += data.length;
                        console.log(`‚úì ${tableName}: ${data.length} kayƒ±t yedeklendi`);
                    } catch (error) {
                        console.error(`'${tableName}' tablosu yedeklenirken beklenmeyen hata:`, error);
                        hasError = true;
                    }
                }

                if (hasError) {
                    showNotification('Yedekleme sƒ±rasƒ±nda bazƒ± hatalar olu≈ütu, ancak mevcut veriler indiriliyor.', 'warning');
                }

                if (Object.keys(backupData.tables).length === 0) {
                    showNotification('Yedeklenecek veri bulunamadƒ±.', 'error');
                    return;
                }

                // JSON dosyasƒ±nƒ± olu≈ütur ve indir
                const timestamp = new Date().toISOString().slice(0, 19).replace('T', '_').replace(/:/g, '-');
                const fileName = `test-sistemi-yedek-${timestamp}.json`;
                downloadObjectAsJson(backupData, fileName);

                showNotification(`‚úÖ Toplam ${totalRecords} kayƒ±t ba≈üarƒ±yla yedeklendi ve indirildi!`, 'success');
                console.log('Yedekleme √∂zeti:', {
                    tarih: backupData.backup_date,
                    toplam_tablo: Object.keys(backupData.tables).length,
                    toplam_kayit: totalRecords,
                    dosya_adi: fileName
                });

            } catch (error) {
                console.error('Yedekleme sƒ±rasƒ±nda genel bir hata olu≈ütu:', error);
                showNotification('Yedekleme i≈ülemi sƒ±rasƒ±nda bir hata olu≈ütu.', 'error');
            }
        }

        // Veriyi JSON dosyasƒ± olarak indirme yardƒ±mcƒ± fonksiyonu
        function downloadObjectAsJson(exportObj, exportName) {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", exportName);
            document.body.appendChild(downloadAnchorNode); // Firefox i√ßin gerekli
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // ============================================
        // SINIF Kƒ∞TAPLIƒûI FONKSƒ∞YONLARI
        // ============================================

        // Load students for library dropdown
        async function loadLibraryStudents() {
            try {
                const { data: students, error } = await supabase
                    .from('students')
                    .select('*')
                    .order('name');

                if (error) throw error;

                const select = document.getElementById('libraryStudentSelect');
                select.innerHTML = '<option value="">-- √ñƒürenci Se√ßin --</option>';
                
                if (!students || students.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Hen√ºz √∂ƒürenci eklenmemi≈ü';
                    option.disabled = true;
                    select.appendChild(option);
                    return;
                }
                
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (${student.class})`;
                    select.appendChild(option);
                });

                console.log(`‚úì ${students.length} √∂ƒürenci y√ºklendi`);

            } catch (error) {
                console.error('Error loading library students:', error);
                showNotification('√ñƒürenciler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Load library for selected student
        async function loadLibraryForStudent() {
            const studentId = document.getElementById('libraryStudentSelect').value;
            
            if (!studentId) {
                // Reset view
                document.getElementById('libraryLegend').classList.add('hidden');
                document.getElementById('libraryStats').classList.add('hidden');
                document.getElementById('librarySearchFilter').classList.add('hidden');
                document.getElementById('libraryTestsGrid').innerHTML = `
                    <div class="text-center text-gray-500 py-8 col-span-full">
                        <i class="fas fa-book text-4xl mb-2"></i>
                        <p>Yukarƒ±dan bir √∂ƒürenci se√ßin</p>
                    </div>
                `;
                return;
            }

            try {
                showNotification('Kitaplƒ±k y√ºkleniyor...', 'info');

                // Get all tests
                const { data: tests, error: testsError } = await supabase
                    .from('tests')
                    .select('*')
                    .order('title');

                if (testsError) throw testsError;

                // Get student's assignments
                const { data: assignments, error: assignmentsError } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('student_id', studentId);

                if (assignmentsError) throw assignmentsError;

                // Get student's results
                const { data: results, error: resultsError } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('student_id', studentId);

                if (resultsError) throw resultsError;

                // Show legend, stats, and search/filter
                document.getElementById('libraryLegend').classList.remove('hidden');
                document.getElementById('libraryStats').classList.remove('hidden');
                document.getElementById('librarySearchFilter').classList.remove('hidden');
                
                // Reset search and filter
                document.getElementById('librarySearchInput').value = '';
                window.currentLibraryFilter = 'all';
                updateFilterButtons();

                // Calculate stats
                const assignedTestIds = assignments.map(a => a.test_id);
                const completedTestIds = results.map(r => r.test_id);
                
                let successCount = 0;
                let failedCount = 0;
                let pendingCount = 0;
                let unassignedCount = 0;

                tests.forEach(test => {
                    const result = results.find(r => r.test_id === test.id);
                    const isAssigned = assignedTestIds.includes(test.id);
                    
                    if (result) {
                        if (result.score >= 70) successCount++;
                        else failedCount++;
                    } else if (isAssigned) {
                        pendingCount++;
                    } else {
                        unassignedCount++;
                    }
                });

                // Update stats
                document.getElementById('libTotalTests').textContent = tests.length;
                document.getElementById('libSuccessTests').textContent = successCount;
                document.getElementById('libFailedTests').textContent = failedCount;
                document.getElementById('libPendingTests').textContent = pendingCount;
                document.getElementById('libUnassignedTests').textContent = unassignedCount;

                // Render tests grid
                const grid = document.getElementById('libraryTestsGrid');
                grid.innerHTML = '';

                tests.forEach(test => {
                    const result = results.find(r => r.test_id === test.id);
                    const isAssigned = assignedTestIds.includes(test.id);
                    
                    let status = 'unassigned';
                    let bgColor = 'bg-gray-100';
                    let borderColor = 'border-gray-300';
                    let textColor = 'text-gray-700';
                    let statusText = '‚ö™ Atanmamƒ±≈ü';
                    let statusIcon = 'fa-circle';
                    let clickable = true;
                    
                    if (result) {
                        if (result.score >= 70) {
                            status = 'success';
                            bgColor = 'bg-green-50';
                            borderColor = 'border-green-400';
                            textColor = 'text-green-700';
                            statusText = `üü¢ Ba≈üarƒ±lƒ± (${result.score})`;
                            statusIcon = 'fa-check-circle';
                            clickable = false;
                        } else {
                            status = 'failed';
                            bgColor = 'bg-red-50';
                            borderColor = 'border-red-400';
                            textColor = 'text-red-700';
                            statusText = `üî¥ Ba≈üarƒ±sƒ±z (${result.score})`;
                            statusIcon = 'fa-times-circle';
                            clickable = false;
                        }
                    } else if (isAssigned) {
                        status = 'pending';
                        bgColor = 'bg-yellow-50';
                        borderColor = 'border-yellow-400';
                        textColor = 'text-yellow-700';
                        statusText = 'üü° Bekleyen';
                        statusIcon = 'fa-clock';
                        clickable = false;
                    }

                    const card = document.createElement('div');
                    card.className = `library-test-card ${bgColor} border-2 ${borderColor} rounded-lg p-4 transition-all ${clickable ? 'cursor-pointer hover:shadow-lg hover:scale-105' : ''}`;
                    card.setAttribute('data-status', status);
                    card.setAttribute('data-title', test.title.toLowerCase());
                    
                    if (clickable) {
                        card.onclick = () => quickAssignTest(studentId, test.id, test.title);
                    }

                    card.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex-1">
                                <h4 class="font-semibold ${textColor} text-sm mb-1">${test.title}</h4>
                                <p class="text-xs text-gray-600">${test.question_count} Soru</p>
                            </div>
                            <i class="fas ${statusIcon} ${textColor} text-lg"></i>
                        </div>
                        <div class="mt-3 pt-3 border-t ${borderColor}">
                            <p class="text-xs ${textColor} font-medium">${statusText}</p>
                            ${clickable ? '<p class="text-xs text-gray-500 mt-1">Tƒ±klayarak atayƒ±n</p>' : ''}
                        </div>
                    `;

                    grid.appendChild(card);
                });
                
                // Store tests data globally for filtering
                window.libraryTestsData = { tests, results, assignments, studentId };

                showNotification('‚úÖ Kitaplƒ±k y√ºklendi!', 'success');

            } catch (error) {
                console.error('Error loading library:', error);
                showNotification('Kitaplƒ±k y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Quick assign test from library
        async function quickAssignTest(studentId, testId, testTitle) {
            const confirmAssign = await showAssignmentConfirmDialog({
                title: 'üìö Hƒ±zlƒ± Test Atamasƒ±',
                message: `"${testTitle}" testini se√ßili √∂ƒürenciye atamak istiyor musunuz?`,
                confirmText: 'Evet, Ata',
                cancelText: 'ƒ∞ptal'
            });

            if (!confirmAssign) return;

            try {
                showNotification('Test atanƒ±yor...', 'info');

                // Check if already assigned
                const { data: existing, error: checkError } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('student_id', studentId)
                    .eq('test_id', testId)
                    .single();

                if (existing) {
                    showNotification('Bu test zaten √∂ƒürenciye atanmƒ±≈ü.', 'warning');
                    return;
                }

                // Assign test
                const { error: assignError } = await supabase
                    .from('test_assignments')
                    .insert([{
                        student_id: studentId,
                        test_id: testId,
                        assigned_by: currentUser.id,
                        assigned_at: new Date().toISOString()
                    }]);

                if (assignError) throw assignError;

                showNotification('‚úÖ Test ba≈üarƒ±yla atandƒ±!', 'success');
                
                // Reload library
                loadLibraryForStudent();

            } catch (error) {
                console.error('Error assigning test:', error);
                showNotification('Test atanƒ±rken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Set library filter
        function setLibraryFilter(filterType) {
            window.currentLibraryFilter = filterType;
            updateFilterButtons();
            filterLibraryTests();
        }

        // Update filter button styles
        function updateFilterButtons() {
            const buttons = {
                'all': document.getElementById('filterAll'),
                'success': document.getElementById('filterSuccess'),
                'failed': document.getElementById('filterFailed'),
                'pending': document.getElementById('filterPending'),
                'unassigned': document.getElementById('filterUnassigned')
            };

            Object.keys(buttons).forEach(key => {
                const btn = buttons[key];
                if (btn) {
                    if (key === window.currentLibraryFilter) {
                        btn.classList.remove('bg-gray-200', 'text-gray-700');
                        btn.classList.add('bg-purple-600', 'text-white');
                    } else {
                        btn.classList.remove('bg-purple-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    }
                }
            });
        }

        // Filter library tests based on search and status
        function filterLibraryTests() {
            const searchTerm = document.getElementById('librarySearchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.library-test-card');
            
            let visibleCount = 0;

            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const title = card.getAttribute('data-title');
                
                // Check status filter
                let statusMatch = window.currentLibraryFilter === 'all' || status === window.currentLibraryFilter;
                
                // Check search term
                let searchMatch = !searchTerm || title.includes(searchTerm);
                
                // Show/hide card
                if (statusMatch && searchMatch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show message if no results
            const grid = document.getElementById('libraryTestsGrid');
            let noResultsMsg = grid.querySelector('.no-results-message');
            
            if (visibleCount === 0) {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('div');
                    noResultsMsg.className = 'no-results-message text-center text-gray-500 py-8 col-span-full';
                    noResultsMsg.innerHTML = `
                        <i class="fas fa-search text-4xl mb-2"></i>
                        <p>Arama kriterlerine uygun test bulunamadƒ±</p>
                        <button onclick="resetLibraryFilters()" class="mt-3 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Filtreleri Temizle
                        </button>
                    `;
                    grid.appendChild(noResultsMsg);
                }
            } else {
                if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }
        }

        // Reset library filters
        function resetLibraryFilters() {
            document.getElementById('librarySearchInput').value = '';
            window.currentLibraryFilter = 'all';
            updateFilterButtons();
            filterLibraryTests();
        }

        // ============================================
        // DETAYLI SONU√áLAR FONKSƒ∞YONLARI
        // ============================================

        // Show detailed results modal (using student result view)
        async function showDetailedResults(resultId, studentId, studentName, testTitle) {
            try {
                showNotification('Detaylƒ± sonu√ßlar y√ºkleniyor...', 'info');

                // Get test result with test data
                const { data: result, error: resultError } = await supabase
                    .from('test_results')
                    .select('*')
                    .eq('id', resultId)
                    .single();

                if (resultError) throw resultError;

                // Get test data
                const { data: test, error: testError } = await supabase
                    .from('tests')
                    .select('*')
                    .eq('id', result.test_id)
                    .single();

                if (testError) throw testError;

                // Parse questions and student answers
                const questions = JSON.parse(test.questions);
                let answersData = result.answers ? JSON.parse(result.answers) : {};
                
                // Extract answers array from nested structure
                let studentAnswers = [];
                if (answersData.answers) {
                    // New format: {answers: {...} or [...], earnedPoints: ..., totalPoints: ...}
                    if (Array.isArray(answersData.answers)) {
                        studentAnswers = answersData.answers;
                    } else if (typeof answersData.answers === 'object') {
                        // Convert object to array: {"0": 2, "1": 1, ...} -> [2, 1, ...]
                        const answersArray = [];
                        for (let i = 0; i < questions.length; i++) {
                            answersArray[i] = answersData.answers[i] !== undefined ? answersData.answers[i] : answersData.answers[String(i)];
                        }
                        studentAnswers = answersArray;
                    }
                } else if (Array.isArray(answersData)) {
                    // Old format: direct array
                    studentAnswers = answersData;
                } else {
                    // Object format: convert to array
                    const answersArray = [];
                    for (let i = 0; i < questions.length; i++) {
                        answersArray[i] = answersData[i] !== undefined ? answersData[i] : answersData[String(i)];
                    }
                    studentAnswers = answersArray;
                }
                
                console.log('Parsed answers data:', answersData);
                console.log('Student answers array:', studentAnswers);
                
                // Calculate time
                const timeSpent = result.time_spent || 0;
                const minutes = Math.floor(timeSpent / 60);
                const seconds = timeSpent % 60;

                // Calculate statistics - exactly like student submitTest
                let totalPoints = 0;
                let earnedPoints = 0;
                let correctCount = 0;
                const totalQuestions = questions.length;

                questions.forEach((question, index) => {
                    const userAnswer = studentAnswers[index];
                    const questionPoints = question.points || 10;
                    totalPoints += questionPoints;
                    
                    let isCorrect = false;
                    
                    // Use correct field (not correct_answer)
                    const correctAnswer = question.correct !== undefined ? question.correct : question.correct_answer;
                    
                    if (question.type === 'multiple_choice') {
                        isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
                    } else if (question.type === 'fill_blank') {
                        // Handle both word selection and text input formats
                        if (typeof userAnswer === 'string') {
                            isCorrect = userAnswer.toLowerCase().trim() === String(correctAnswer).toLowerCase().trim();
                        } else if (question.options && question.options.length > 0) {
                            isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
                        }
                    } else if (question.type === 'true_false') {
                        // Handle both boolean and string formats
                        if (typeof userAnswer === 'string') {
                            isCorrect = (userAnswer === 'true') === correctAnswer;
                        } else {
                            isCorrect = userAnswer === correctAnswer;
                        }
                    } else {
                        // Text questions
                        if (typeof userAnswer === 'string') {
                            isCorrect = userAnswer.toLowerCase().trim() === String(correctAnswer).toLowerCase().trim();
                        }
                    }
                    
                    if (isCorrect) {
                        correctCount++;
                        earnedPoints += questionPoints;
                    }
                });
                
                const score = result.score;
                const passed = score >= 70;

                // Create modal HTML (student result view style)
                const modalHTML = `
                    <div id="detailedResultsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-y-auto">
                        <div class="min-h-screen flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full my-8">
                                <!-- Header -->
                                <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-900 mb-2">
                                                <i class="fas fa-clipboard-check text-indigo-600 mr-2"></i>
                                                ${studentName} - Test Sonu√ßlarƒ±
                                            </h3>
                                            <div class="space-y-1 text-sm text-gray-600">
                                                <p><strong>Test:</strong> ${testTitle}</p>
                                                <p><strong>Tarih:</strong> ${new Date(result.completed_at).toLocaleDateString('tr-TR', {
                                                    weekday: 'long',
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                })}</p>
                                            </div>
                                        </div>
                                        <button onclick="closeDetailedResultsModal()" class="text-gray-400 hover:text-gray-600">
                                            <i class="fas fa-times text-2xl"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Content -->
                                <div class="p-6 max-h-[70vh] overflow-y-auto">
                                    <div class="text-center mb-6">
                                        <div class="w-20 h-20 mx-auto mb-4 rounded-full flex items-center justify-center ${passed ? 'bg-gradient-to-br from-green-400 to-green-600' : 'bg-gradient-to-br from-orange-400 to-red-500'} shadow-lg">
                                            <i class="fas ${passed ? 'fa-trophy' : 'fa-exclamation-triangle'} text-3xl text-white"></i>
                                        </div>
                                        <h3 class="text-xl font-bold ${passed ? 'text-green-600' : 'text-orange-600'} mb-2">
                                            ${passed ? 'üéâ Tebrikler!' : '‚ö†Ô∏è Test Tamamlandƒ±'}
                                        </h3>
                                        <div class="text-3xl font-bold ${passed ? 'text-green-700' : 'text-red-600'} mb-2">
                                            ${score}%
                                        </div>
                                        <p class="text-sm text-gray-600 mb-1">
                                            ${passed ? 'Ba≈üarƒ± puanƒ±na ula≈ütƒ±!' : 'Ba≈üarƒ± puanƒ±na ula≈üamadƒ±.'}
                                        </p>
                                        <p class="text-xs text-gray-500">
                                            S√ºre: ${minutes}dk ${seconds}sn
                                        </p>
                                    </div>
                                    
                                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 mb-4 border border-blue-100">
                                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                                <div class="text-2xl font-bold ${score >= 90 ? 'text-green-600' : score >= 70 ? 'text-blue-600' : 'text-red-600'}">${score}%</div>
                                                <div class="text-xs text-gray-600 font-medium">Ba≈üarƒ± Oranƒ±</div>
                                                <div class="text-xs text-gray-500">
                                                    ${score >= 90 ? 'üåü' : score >= 70 ? '‚úÖ' : '‚ùå'}
                                                </div>
                                            </div>
                                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                                <div class="text-2xl font-bold text-purple-600">${earnedPoints}</div>
                                                <div class="text-xs text-gray-600 font-medium">Kazanƒ±lan Puan</div>
                                                <div class="text-xs text-gray-500">
                                                    /${totalPoints} puan
                                                </div>
                                            </div>
                                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                                <div class="text-2xl font-bold text-green-600">${correctCount}</div>
                                                <div class="text-xs text-gray-600 font-medium">Doƒüru Cevap</div>
                                                <div class="text-xs text-gray-500">
                                                    /${totalQuestions} soru
                                                </div>
                                            </div>
                                            <div class="bg-white rounded-lg p-3 shadow-sm">
                                                <div class="text-2xl font-bold text-red-600">${totalQuestions - correctCount}</div>
                                                <div class="text-xs text-gray-600 font-medium">Yanlƒ±≈ü Cevap</div>
                                                <div class="text-xs text-gray-500">
                                                    ${totalQuestions - correctCount === 0 ? 'üéØ M√ºkemmel!' : 'üìö √áalƒ±≈ü'}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Detailed Question Breakdown -->
                                    <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-list-check text-blue-600 mr-2"></i>
                                            Soru Bazƒ±nda Detay
                                        </h4>
                                        <div class="space-y-2 max-h-96 overflow-y-auto">
                                            ${questions.map((question, index) => {
                                                const userAnswer = studentAnswers[index];
                                                const questionPoints = question.points || 10;
                                                let isCorrect = false;
                                                let userAnswerDisplay = '';
                                                let correctAnswerDisplay = '';
                                                
                                                // Get correct answer - try both field names
                                                const correctAnswer = question.correct !== undefined ? question.correct : question.correct_answer;
                                                
                                                if (question.type === 'multiple_choice') {
                                                    isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
                                                    userAnswerDisplay = userAnswer !== undefined && question.options[userAnswer] ? 
                                                        `${String.fromCharCode(65 + userAnswer)}) ${question.options[userAnswer]}` : 'Cevaplanmadƒ±';
                                                    correctAnswerDisplay = `${String.fromCharCode(65 + correctAnswer)}) ${question.options[correctAnswer]}`;
                                                } else if (question.type === 'fill_blank') {
                                                    if (question.options && question.options.length > 0) {
                                                        isCorrect = parseInt(userAnswer) === parseInt(correctAnswer);
                                                        userAnswerDisplay = userAnswer !== undefined && question.options[userAnswer] ? 
                                                            `${String.fromCharCode(65 + userAnswer)}) ${question.options[userAnswer]}` : 'Cevaplanmadƒ±';
                                                        correctAnswerDisplay = typeof correctAnswer === 'number' ? 
                                                            `${String.fromCharCode(65 + correctAnswer)}) ${question.options[correctAnswer]}` : correctAnswer;
                                                    } else {
                                                        isCorrect = userAnswer && userAnswer.toLowerCase().trim() === String(correctAnswer).toLowerCase().trim();
                                                        userAnswerDisplay = userAnswer || 'Cevaplanmadƒ±';
                                                        correctAnswerDisplay = correctAnswer;
                                                    }
                                                } else if (question.type === 'true_false') {
                                                    isCorrect = userAnswer === correctAnswer;
                                                    userAnswerDisplay = userAnswer === true ? 'Doƒüru' : userAnswer === false ? 'Yanlƒ±≈ü' : 'Cevaplanmadƒ±';
                                                    correctAnswerDisplay = correctAnswer === true ? 'Doƒüru' : 'Yanlƒ±≈ü';
                                                } else {
                                                    isCorrect = userAnswer && userAnswer.toLowerCase().trim() === String(correctAnswer).toLowerCase().trim();
                                                    userAnswerDisplay = userAnswer || 'Cevaplanmadƒ±';
                                                    correctAnswerDisplay = correctAnswer;
                                                }
                                                
                                                return `
                                                    <div class="flex justify-between items-center py-2 px-3 rounded ${isCorrect ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}">
                                                        <div class="flex items-center space-x-2 flex-1">
                                                            <span class="text-sm font-medium ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                                                ${isCorrect ? '‚úÖ' : '‚ùå'} Soru ${index + 1}
                                                            </span>
                                                            <span class="text-xs text-gray-600">
                                                                (${question.type === 'multiple_choice' ? '√áoktan Se√ßmeli' : 
                                                                   question.type === 'fill_blank' ? 'Bo≈üluk Doldurma' : 
                                                                   question.type === 'true_false' ? 'Doƒüru/Yanlƒ±≈ü' : 'Metin'})
                                                            </span>
                                                            ${!isCorrect ? `
                                                                <div class="text-xs ml-2">
                                                                    <span class="text-red-600">Cevap: ${userAnswerDisplay}</span>
                                                                    <span class="text-gray-500 mx-1">‚Üí</span>
                                                                    <span class="text-green-600 font-semibold">Doƒüru: ${correctAnswerDisplay}</span>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                        <div class="text-sm font-semibold ${isCorrect ? 'text-green-700' : 'text-red-700'}">
                                                            ${isCorrect ? questionPoints : 0}/${questionPoints} puan
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    
                                    ${!passed ? `
                                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
                                                <h4 class="text-sm font-semibold text-red-800">√ñnemli Bilgi</h4>
                                            </div>
                                            <p class="text-red-800 text-sm font-medium mb-1">
                                                √ñƒürenci ba≈üarƒ± puanƒ±na ula≈üamadƒ±.
                                            </p>
                                            <p class="text-red-700 text-xs">
                                                Tekrar √ß√∂zebilmesi i√ßin yeniden atama yapmanƒ±z gerekir.
                                            </p>
                                        </div>
                                    ` : `
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                            <div class="flex items-center mb-2">
                                                <i class="fas fa-star text-green-600 mr-2"></i>
                                                <h4 class="text-sm font-semibold text-green-800">Ba≈üarƒ±lƒ±!</h4>
                                            </div>
                                            <p class="text-green-800 text-sm">
                                                √ñƒürenci testi ba≈üarƒ±yla ge√ßti. Yeni rozetler kazanmƒ±≈ü olabilir.
                                            </p>
                                        </div>
                                    `}
                                </div>

                                <!-- Footer -->
                                <div class="p-6 border-t border-gray-200 bg-gray-50">
                                    <div class="flex justify-between items-center">
                                        <div class="text-sm text-gray-600">
                                            <i class="fas fa-info-circle mr-1"></i>
                                            Ye≈üil: Doƒüru | Kƒ±rmƒ±zƒ±: Yanlƒ±≈ü
                                        </div>
                                        <button onclick="closeDetailedResultsModal()" 
                                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                            <i class="fas fa-times mr-2"></i>Kapat
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Add modal to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                showNotification('‚úÖ Detaylƒ± sonu√ßlar y√ºklendi!', 'success');

            } catch (error) {
                console.error('Error loading detailed results:', error);
                showNotification('Detaylƒ± sonu√ßlar y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Close detailed results modal
        function closeDetailedResultsModal() {
            const modal = document.getElementById('detailedResultsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show pending tests modal


        // Refresh teacher data without page reload
        async function refreshTeacherData() {
            const refreshBtn = event.target.closest('button');
            const icon = refreshBtn.querySelector('i');
            
            // Add spinning animation
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            try {
                // Get current active tab
                const activeTab = document.querySelector('.teacher-tab-button.border-green-500');
                const tabName = activeTab ? activeTab.id.replace('Tab', '') : 'dashboard';
                
                // Reload data based on active tab
                switch(tabName) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'students':
                        await loadStudentsList();
                        break;
                    case 'tests':
                        await loadTestsList();
                        break;
                    case 'results':
                        await loadResultsList();
                        break;
                    case 'library':
                        // Reload library if student is selected
                        const selectedStudent = document.getElementById('libraryStudentSelect')?.value;
                        if (selectedStudent) {
                            await loadLibraryForStudent(selectedStudent);
                        }
                        break;
                }
                
                showNotification('‚úÖ Veriler g√ºncellendi!', 'success');
            } catch (error) {
                console.error('Refresh error:', error);
                showNotification('‚ùå Yenileme sƒ±rasƒ±nda hata olu≈ütu!', 'error');
            } finally {
                // Remove spinning animation
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            }
        }

        // Delete test result
        async function deleteTestResult(resultId, studentName, testTitle) {
            if (!confirm(`${studentName} adlƒ± √∂ƒürencinin "${testTitle}" testindeki sonucunu silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('test_results')
                    .delete()
                    .eq('id', resultId);

                if (error) throw error;

                showNotification('‚úÖ Test sonucu ba≈üarƒ±yla silindi!', 'success');
                loadResultsList(); // Refresh the list
            } catch (error) {
                console.error('Error deleting test result:', error);
                showNotification('‚ùå Test sonucu silinirken hata olu≈ütu: ' + error.message, 'error');
            }
        }
            // Show pending tests modal with SUPABASE VIEW logic (FINAL & CORRECTED VERSION)
        async function showPendingTestsModal() {
            try {
                showNotification('Bekleyen testler y√ºkleniyor...', 'info');

                // 1. Doƒürudan View'dan bekleyen test verilerini √ßek
                // NOT: Bu View'ƒ± Supabase'de olu≈üturduƒüunuz varsayƒ±lmƒ±≈ütƒ±r.
                const { data: rawPendingData, error } = await supabase
                    .from('pending_tests_view')
                    .select('*')
                    .order('student_name'); // ƒ∞sim sƒ±rasƒ±na g√∂re sƒ±rala

                if (error) throw error;

                // 2. Veriyi √∂ƒürenci bazƒ±nda grupla (Modal i√ßin gerekli format)
                const pendingDataMap = new Map();
                let totalPendingAssignments = 0;

                for (const item of rawPendingData) {
                    const studentKey = item.student_id;
                    
                    if (!pendingDataMap.has(studentKey)) {
                        pendingDataMap.set(studentKey, {
                            studentId: item.student_id,
                            studentName: item.student_name,
                            studentClass: item.student_class,
                            pendingTests: []
                        });
                    }
                    
                        pendingDataMap.get(studentKey).pendingTests.push({
                            testId: item.test_id, // Hatanƒ±n √ß√∂z√ºm√º: testId'yi ekle
                            testTitle: item.test_title
                        });
                    totalPendingAssignments++;
                }

                const pendingData = Array.from(pendingDataMap.values());
                
                // 3. Modalƒ± olu≈ütur ve g√∂ster
                const modalHTML = `
                    <div id="pendingTestsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                            <!-- Header -->
                            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                                <h3 class="text-xl font-semibold text-gray-900">
                                    <i class="fas fa-user-clock text-yellow-600 mr-2"></i>√ñƒürenci Bazƒ±nda Bekleyen Testler
                                </h3>
                                <button onclick="closePendingTestsModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times text-2xl"></i>
                                </button>
                            </div>

                            <!-- Content -->
                            <div class="p-6 overflow-y-auto flex-1">
                                ${pendingData.length === 0 ? `
                                    <div class="text-center py-12">
                                        <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                                        <p class="text-xl text-gray-600 font-semibold">Harika! Bekleyen test yok.</p>
                                        <p class="text-gray-500 mt-2">T√ºm √∂ƒürenciler kendilerine atanan testleri tamamlamƒ±≈ü.</p>
                                    </div>
                                ` : `
                                    <!-- Summary -->
                                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <div class="flex items-center gap-6">
                                            <div class="text-center">
                                                <div class="text-3xl font-bold text-yellow-700">${pendingData.length}</div>
                                                <div class="text-sm text-yellow-600 font-medium">√ñƒürencinin Bekleyen Testi Var</div>
                                            </div>
                                            <div class="text-center">
                                                <div class="text-3xl font-bold text-yellow-700">${totalPendingAssignments}</div>
                                                <div class="text-sm text-yellow-600 font-medium">Toplam Bekleyen Atama</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Student List -->
                                    <div class="space-y-4">
                                        ${pendingData.map(student => `
                                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                                <div class="flex items-center justify-between mb-3">
                                                    <div class="flex items-center gap-3">
                                                        <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center">
                                                            <i class="fas fa-user text-yellow-600"></i>
                                                        </div>
                                                        <div>
                                                            <h4 class="font-semibold text-gray-900">${student.studentName}</h4>
                                                            <p class="text-sm text-gray-500">${student.studentClass}</p>
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        <span class="inline-block px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-semibold rounded-full">
                                                            ${student.pendingTests.length} Test Bekliyor
                                                        </span>
                                                    </div>
                                                </div>
                                                <div class="pl-12 space-y-2">
                                                    ${student.pendingTests.map((test, index) => `
                                                        <div class="flex items-center justify-between gap-3 text-sm p-2 bg-gray-50 rounded">
                                                            <div class="flex items-center gap-3 flex-1">
                                                                <span class="text-gray-400 font-mono">${index + 1}.</span>
                                                                <i class="fas fa-file-alt text-yellow-500"></i>
                                                                <span class="text-gray-700">${test.testTitle}</span>
                                                            </div>
                                                            <button onclick="removePendingAssignment(${student.studentId}, ${test.testId}, \`${student.studentName}\`, \`${test.testTitle}\`)"
                                                                    class="text-red-500 hover:text-red-700 text-xs font-medium px-2 py-1 rounded-full hover:bg-red-100 transition duration-150">
                                                                <i class="fas fa-times mr-1"></i>Kaldƒ±r
                                                            </button>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>

                            <!-- Footer -->
                            <div class="p-6 border-t border-gray-200 bg-gray-50">
                                <div class="flex justify-end">
                                    <button onclick="closePendingTestsModal()" 
                                            class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                        <i class="fas fa-times mr-2"></i>Kapat
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);
                showNotification('‚úÖ Bekleyen testler ba≈üarƒ±yla listelendi!', 'success');

            } catch (error) {
                console.error('Error loading pending tests:', error);
                showNotification('Bekleyen testler y√ºklenirken bir hata olu≈ütu: ' + error.message, 'error');
            }
        }


       
        // Remove pending assignment
        async function removePendingAssignment(studentId, testId, studentName, testTitle) {
            if (!confirm(`"${testTitle}" testinin "${studentName}" adlƒ± √∂ƒürenciden atamasƒ±nƒ± kaldƒ±rmak istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                showNotification('Atama kaldƒ±rƒ±lƒ±yor...', 'info');

                const { error } = await supabase
                    .from('test_assignments')
                    .delete()
                    .eq('student_id', studentId)
                    .eq('test_id', testId);

                if (error) throw error;

                showNotification('‚úÖ Atama ba≈üarƒ±yla kaldƒ±rƒ±ldƒ±!', 'success');
                
                // Modalƒ± yenile
                closePendingTestsModal();
                showPendingTestsModal();

            } catch (error) {
                console.error('Error removing assignment:', error);
                showNotification('‚ùå Atama kaldƒ±rƒ±lƒ±rken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Close pending tests modal
        function closePendingTestsModal() {
            const modal = document.getElementById('pendingTestsModal');
            if (modal) {
                modal.remove();
            }
        }

        // Show edit test modal
        async function showEditTestModal(testId) {
            try {
                // Fetch test data
                const { data: test, error } = await supabase
                    .from('tests')
                    .select('*')
                    .eq('id', testId)
                    .single();

                if (error) throw error;

                const questions = JSON.parse(test.questions);
                
                // Build modal content
                let questionsHTML = '';
                questions.forEach((q, index) => {
                    const questionTypeLabel = {
                        'multiple_choice': 'üìù √áoktan Se√ßmeli',
                        'true_false': '‚úì‚úó Doƒüru/Yanlƒ±≈ü',
                        'fill_blank': 'üìÑ Bo≈üluk Doldurma',
                        'text': 'üìã Metin'
                    }[q.type] || '‚ùì Bilinmeyen';

                    questionsHTML += `
                        <div class="question-card border border-gray-200 rounded-lg p-4 mb-4" data-question-index="${index}">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-gray-800">Soru ${index + 1}</h4>
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 text-xs rounded ${
                                        q.type === 'multiple_choice' ? 'bg-blue-100 text-blue-700' :
                                        q.type === 'true_false' ? 'bg-green-100 text-green-700' :
                                        q.type === 'fill_blank' ? 'bg-yellow-100 text-yellow-700' :
                                        'bg-purple-100 text-purple-700'
                                    }">${questionTypeLabel}</span>
                                    <button type="button" onclick="deleteQuestion(${index})" class="px-2 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200">
                                        <i class="fas fa-trash mr-1"></i>Soruyu Sil
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Soru Metni:</label>
                                <textarea name="question_${index}_text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="3">${q.question || ''}</textarea>
                            </div>
                    `;

                    if (q.type === 'multiple_choice') {
                        questionsHTML += `
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Se√ßenekler:</label>
                                ${(q.options || ['', '', '', '']).map((opt, i) => `
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-medium">${String.fromCharCode(65 + i)})</span>
                                        <input type="text" name="question_${index}_option_${i}" value="${opt || ''}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                        <label class="flex items-center">
                                            <input type="radio" name="question_${index}_correct" value="${i}" ${q.correct === i ? 'checked' : ''} class="mr-1">
                                            <span class="text-sm">Doƒüru</span>
                                        </label>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else if (q.type === 'true_false') {
                        questionsHTML += `
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Doƒüru Cevap:</label>
                                <div class="flex gap-4">
                                    <label class="flex items-center">
                                        <input type="radio" name="question_${index}_correct" value="true" ${q.correct === true ? 'checked' : ''} class="mr-2">
                                        <span>Doƒüru</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="question_${index}_correct" value="false" ${q.correct === false ? 'checked' : ''} class="mr-2">
                                        <span>Yanlƒ±≈ü</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    } else if (q.type === 'fill_blank') {
                        if (q.options && q.options.length > 0) {
                            questionsHTML += `
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Se√ßenekler:</label>
                                    ${(q.options || ['', '', '', '']).map((opt, i) => `
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="font-medium">${String.fromCharCode(65 + i)})</span>
                                            <input type="text" name="question_${index}_option_${i}" value="${opt || ''}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg">
                                            <label class="flex items-center">
                                                <input type="radio" name="question_${index}_correct" value="${i}" ${q.correct === i ? 'checked' : ''} class="mr-1">
                                                <span class="text-sm">Doƒüru</span>
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        } else {
                            questionsHTML += `
                                <div class="mb-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Doƒüru Cevap:</label>
                                    <input type="text" name="question_${index}_correct_text" value="${q.correct || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            `;
                        }
                    } else {
                        questionsHTML += `
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Doƒüru Cevap:</label>
                                <textarea name="question_${index}_correct_text" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2">${q.correct || ''}</textarea>
                            </div>
                        `;
                    }

                    questionsHTML += `
                            <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                <div class="flex items-center gap-2">
                                    <label class="text-sm font-medium text-gray-700">‚≠ê Puan:</label>
                                    <input type="number" name="question_${index}_points" value="${q.points || 10}" min="1" max="100" class="w-20 px-2 py-1 border border-gray-300 rounded">
                                </div>
                            </div>
                        </div>
                    `;
                });

                const modalContent = `
                    <form id="editTestForm" onsubmit="saveEditedTest(event, ${testId})">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Test Ba≈ülƒ±ƒüƒ±:</label>
                            <input type="text" id="editTestTitle" value="${test.title || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">A√ßƒ±klama:</label>
                            <textarea id="editTestDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg" rows="2">${test.description || ''}</textarea>
                        </div>
                        
                        <div class="mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Sorular:</h4>
                            <div id="questionsContainer">
                                ${questionsHTML}
                            </div>
                        </div>
                        
                        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
                            <button type="button" onclick="closeModal('editTestModal')" class="px-6 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg">
                                ƒ∞ptal
                            </button>
                            <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                <i class="fas fa-save mr-2"></i>Deƒüi≈üiklikleri Kaydet
                            </button>
                        </div>
                    </form>
                `;

                document.getElementById('editTestContent').innerHTML = modalContent;
                document.getElementById('editTestModal').classList.remove('hidden');
                
                // Scroll to top
                setTimeout(() => {
                    document.getElementById('editTestContent').scrollTop = 0;
                }, 100);

            } catch (error) {
                console.error('Error loading test for edit:', error);
                showNotification('‚ùå Test y√ºklenirken hata olu≈ütu!', 'error');
            }
        }

        // Delete question from edit modal
        function deleteQuestion(index) {
            if (!confirm(`Soru ${index + 1}'i silmek istediƒüinizden emin misiniz?`)) {
                return;
            }
            const questionCard = document.querySelector(`[data-question-index="${index}"]`);
            if (questionCard) {
                questionCard.style.display = 'none';
                questionCard.dataset.deleted = 'true';
            }
        }

        // Save edited test
        async function saveEditedTest(event, testId) {
            event.preventDefault();
            
            try {
                const title = document.getElementById('editTestTitle').value;
                const description = document.getElementById('editTestDescription').value;
                
                // Collect questions
                const questionCards = document.querySelectorAll('.question-card');
                const questions = [];
                
                questionCards.forEach((card, index) => {
                    if (card.dataset.deleted === 'true') return; // Skip deleted questions
                    
                    const originalIndex = card.dataset.questionIndex;
                    const questionText = document.querySelector(`[name="question_${originalIndex}_text"]`).value;
                    const points = parseInt(document.querySelector(`[name="question_${originalIndex}_points"]`).value) || 10;
                    
                    // Determine question type from card
                    const typeLabel = card.querySelector('.px-2.py-1.text-xs').textContent;
                    let type = 'text';
                    if (typeLabel.includes('√áoktan Se√ßmeli')) type = 'multiple_choice';
                    else if (typeLabel.includes('Doƒüru/Yanlƒ±≈ü')) type = 'true_false';
                    else if (typeLabel.includes('Bo≈üluk Doldurma')) type = 'fill_blank';
                    
                    const question = {
                        question: questionText,
                        type: type,
                        points: points
                    };
                    
                    if (type === 'multiple_choice') {
                        question.options = [];
                        for (let i = 0; i < 4; i++) {
                            const optInput = document.querySelector(`[name="question_${originalIndex}_option_${i}"]`);
                            question.options.push(optInput ? optInput.value : '');
                        }
                        const correctRadio = document.querySelector(`[name="question_${originalIndex}_correct"]:checked`);
                        if (!correctRadio) throw new Error(`Soru ${questions.length + 1} i√ßin doƒüru cevap se√ßilmemi≈ü!`);
                        question.correct = parseInt(correctRadio.value);
                    } else if (type === 'true_false') {
                        const correctRadio = document.querySelector(`[name="question_${originalIndex}_correct"]:checked`);
                        if (!correctRadio) throw new Error(`Soru ${questions.length + 1} i√ßin doƒüru cevap se√ßilmemi≈ü!`);
                        question.correct = correctRadio.value === 'true';
                    } else if (type === 'fill_blank') {
                        // Check if has options
                        const hasOptions = document.querySelector(`[name="question_${originalIndex}_option_0"]`);
                        if (hasOptions) {
                            question.options = [];
                            for (let i = 0; i < 4; i++) {
                                const optInput = document.querySelector(`[name="question_${originalIndex}_option_${i}"]`);
                                if (optInput) question.options.push(optInput.value);
                            }
                            const correctRadio = document.querySelector(`[name="question_${originalIndex}_correct"]:checked`);
                            if (!correctRadio) throw new Error(`Soru ${questions.length + 1} i√ßin doƒüru cevap se√ßilmemi≈ü!`);
                            question.correct = parseInt(correctRadio.value);
                        } else {
                            const correctInput = document.querySelector(`[name="question_${originalIndex}_correct_text"]`);
                            question.correct = correctInput ? correctInput.value : '';
                        }
                    } else {
                        const correctInput = document.querySelector(`[name="question_${originalIndex}_correct_text"]`);
                        question.correct = correctInput ? correctInput.value : '';
                    }
                    
                    questions.push(question);
                });
                
                if (questions.length === 0) {
                    throw new Error('En az bir soru olmalƒ±!');
                }
                
                // Update test in database
                const { error } = await supabase
                    .from('tests')
                    .update({
                        title: title,
                        description: description,
                        questions: JSON.stringify(questions)
                    })
                    .eq('id', testId);
                
                if (error) throw error;
                
                showNotification('‚úÖ Test ba≈üarƒ±yla g√ºncellendi!', 'success');
                closeModal('editTestModal');
                loadTestsList(); // Refresh list
                
            } catch (error) {
                console.error('Error saving test:', error);
                showNotification('‚ùå ' + error.message, 'error');
            }
        }

        // Show JSON edit modal (placeholder - will be implemented)
        async function showJSONEditModal(testId) {
            showNotification('‚ö†Ô∏è JSON d√ºzenleme √∂zelliƒüi yakƒ±nda eklenecek!', 'info');
            // TODO: Implement JSON edit modal
        }

        // Load failed tests list
        // Load failed tests list using the Supabase View for performance and consistency
        async function loadFailedTestsList() {
            try {
                showNotification('Ba≈üarƒ±sƒ±z testler y√ºkleniyor...', 'info');

                // 1. Doƒürudan View'dan ba≈üarƒ±sƒ±z test verilerini √ßek
                // NOT: Bu View'ƒ± Supabase'de olu≈üturduƒüunuz varsayƒ±lmƒ±≈ütƒ±r.
                const { data: rawFailedData, error } = await supabase
                    .from('failed_tests_view')
                    .select('*');

                if (error) throw error;

                // 2. Veriyi i≈üleyerek gerekli formatƒ± olu≈ütur
                const failedTestsData = rawFailedData.map(item => ({
                    resultId: item.result_id,
                    studentId: item.student_id,
                    studentName: item.student_name,
                    studentClass: item.student_class,
                    testId: item.test_id,
                    testTitle: item.test_title,
                    score: item.score_percentage, // View'dan gelen y√ºzde
                    maxScore: 100, // Y√ºzde olduƒüu i√ßin max 100
                    completedAt: item.result_date,
                    percentage: item.score_percentage // Zaten y√ºzde
                }));

                // 3. ƒ∞statistikleri hesapla
                const failedStudentsSet = new Set(failedTestsData.map(f => f.studentId));
                const failedTestsCount = new Set(failedTestsData.map(f => f.testId)).size;
                const failedStudentsCount = failedStudentsSet.size;
                
                const totalScore = failedTestsData.reduce((sum, f) => sum + f.score, 0);
                const scoreCount = failedTestsData.length;
                const avgScore = scoreCount > 0 ? Math.round(totalScore / scoreCount) : 0;

                // 4. ƒ∞statistikleri g√ºncelle
                document.getElementById('failedTestsCount').textContent = failedTestsCount;
                document.getElementById('failedStudentsCount').textContent = failedStudentsCount;
                document.getElementById('failedTestsAvgScore').textContent = avgScore + '%';
                document.getElementById('failedTestsStats').classList.remove('hidden');

                // 5. Global olarak sakla ve g√∂ster
                window.allFailedTestsData = failedTestsData;
                window.currentFailedTestsFilter = 'all';
                window.currentFailedTestsSearch = '';

                displayFailedTests(failedTestsData);

                showNotification('‚úÖ Ba≈üarƒ±sƒ±z testler y√ºklendi!', 'success');

            } catch (error) {
                console.error('Error loading failed tests:', error);
                showNotification('‚ùå Ba≈üarƒ±sƒ±z testler y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Display failed tests
        function displayFailedTests(failedTests) {
            const container = document.getElementById('failedTestsList');
            container.innerHTML = '';

            if (!failedTests || failedTests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                        <p class="text-xl text-gray-600 font-semibold">T√ºm testler ba≈üarƒ±lƒ±!</p>
                        <p class="text-gray-500 mt-2">Hi√ß ba≈üarƒ±sƒ±z test bulunmamaktadƒ±r.</p>
                    </div>
                `;
                return;
            }

            failedTests.forEach(failed => {
                const card = document.createElement('div');
                card.className = 'bg-white border-2 border-red-200 rounded-lg p-4 hover:shadow-lg transition duration-200';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <h4 class="font-semibold text-gray-900">${failed.studentName}</h4>
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">${failed.studentNo}</span>
                                <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">${failed.studentClass}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">
                                <i class="fas fa-book mr-1"></i>${failed.testTitle}
                            </p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold text-red-600">${failed.percentage}%</div>
                            <div class="text-xs text-gray-500">${failed.score}/${failed.maxScore} puan</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div class="bg-red-500 h-2 rounded-full" style="width: ${failed.percentage}%"></div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                        <span><i class="fas fa-calendar mr-1"></i>${new Date(failed.completedAt).toLocaleDateString('tr-TR')}</span>
                        <span class="text-red-600 font-semibold">Ba≈üarƒ±sƒ±z</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="reassignFailedTest('${failed.studentId}', '${failed.testId}', '${failed.testTitle}', '${failed.studentName}')" class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-redo mr-1"></i>Tekrar Ata
                        </button>
                        <button onclick="deleteFailedTestResult('${failed.resultId}', '${failed.studentName}', '${failed.testTitle}')" class="px-4 py-2 bg-red-100 text-red-600 text-sm rounded hover:bg-red-200 transition duration-200">
                            <i class="fas fa-trash mr-1"></i>Sil
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });

            // Update filter info
            updateFailedTestsFilterInfo(failedTests.length);
        }

        // Filter failed tests
        function filterFailedTests() {
            const searchTerm = document.getElementById('failedTestsSearchInput')?.value.toLowerCase().trim() || '';
            const sortBy = document.getElementById('failedTestsSortSelect')?.value || 'recent';

            let filteredTests = [...(window.allFailedTestsData || [])];

            // Apply search filter
            if (searchTerm) {
                filteredTests = filteredTests.filter(test =>
                    test.studentName.toLowerCase().includes(searchTerm) ||
                    test.testTitle.toLowerCase().includes(searchTerm) ||
                    test.studentNo.includes(searchTerm)
                );
            }

            // Apply sorting
            switch (sortBy) {
                case 'oldest':
                    filteredTests.sort((a, b) => new Date(a.completedAt) - new Date(b.completedAt));
                    break;
                case 'student_asc':
                    filteredTests.sort((a, b) => a.studentName.localeCompare(b.studentName, 'tr'));
                    break;
                case 'student_desc':
                    filteredTests.sort((a, b) => b.studentName.localeCompare(a.studentName, 'tr'));
                    break;
                case 'score_asc':
                    filteredTests.sort((a, b) => a.score - b.score);
                    break;
                case 'score_desc':
                    filteredTests.sort((a, b) => b.score - a.score);
                    break;
                case 'recent':
                default:
                    filteredTests.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
                    break;
            }

            displayFailedTests(filteredTests);
        }

        // Clear failed tests filters
        function clearFailedTestsFilters() {
            document.getElementById('failedTestsSearchInput').value = '';
            document.getElementById('failedTestsSortSelect').value = 'recent';
            filterFailedTests();
        }

        // Update failed tests filter info
        function updateFailedTestsFilterInfo(filteredCount) {
            const totalCount = window.allFailedTestsData?.length || 0;
            const infoElement = document.getElementById('failedTestsFilterInfo');

            if (!infoElement) return;

            let infoText = '';
            if (totalCount === 0) {
                infoText = 'Ba≈üarƒ±sƒ±z test bulunmamaktadƒ±r.';
            } else if (filteredCount === totalCount) {
                infoText = `Toplam ${totalCount} ba≈üarƒ±sƒ±z test g√∂steriliyor`;
            } else {
                infoText = `${filteredCount}/${totalCount} ba≈üarƒ±sƒ±z test g√∂steriliyor`;
            }

            infoElement.textContent = infoText;
        }

        // Reassign failed test
        async function reassignFailedTest(studentId, testId, testTitle, studentName) {
            if (!confirm(`"${testTitle}" testini "${studentName}" adlƒ± √∂ƒürenciye tekrar atamak istediƒüinizden emin misiniz?`)) {
                return;
            }

            try {
                showNotification('Test tekrar atanƒ±yor...', 'info');

                // Check if already assigned
                const { data: existing, error: checkError } = await supabase
                    .from('test_assignments')
                    .select('*')
                    .eq('student_id', studentId)
                    .eq('test_id', testId);

                if (existing && existing.length > 0) {
                    // Already assigned, just notify
                    showNotification('Bu test zaten √∂ƒürenciye atanmƒ±≈ü.', 'warning');
                    return;
                }

                // Create new assignment
                const { error: assignError } = await supabase
                    .from('test_assignments')
                    .insert([{
                        student_id: studentId,
                        test_id: testId,
                        assigned_by: currentUser.id,
                        assigned_at: new Date().toISOString()
                    }]);

                if (assignError) throw assignError;

                showNotification('‚úÖ Test ba≈üarƒ±yla tekrar atandƒ±!', 'success');

                // Reload failed tests
                loadFailedTestsList();

            } catch (error) {
                console.error('Error reassigning test:', error);
                showNotification('‚ùå Test tekrar atanƒ±rken hata olu≈ütu: ' + error.message, 'error');
            }
        }

        // Delete failed test result
        async function deleteFailedTestResult(resultId, studentName, testTitle) {
            if (!confirm(`${studentName} adlƒ± √∂ƒürencinin "${testTitle}" testindeki sonucunu silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('test_results')
                    .delete()
                    .eq('id', resultId);

                if (error) throw error;

                showNotification('‚úÖ Test sonucu ba≈üarƒ±yla silindi!', 'success');
                loadFailedTestsList(); // Refresh the list
            } catch (error) {
                console.error('Error deleting test result:', error);
                showNotification('‚ùå Test sonucu silinirken hata olu≈ütu: ' + error.message, 'error');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97e724fa56c16e07',t:'MTc1Nzc2MTI2My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://gmzdeptaipfacmfdexnd.supabase.co',
    'PUBLIC_ANON_KEY'
  );
</script>
